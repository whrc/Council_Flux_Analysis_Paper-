---
title: "Council_EC Flux_Analysis.2_Github" #cleaning up the code for analysis while retaining the old one 
output: html_document
date: "2025-02-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Notes on site: Wind direction primarily blows from NW, except for Dec - Mar, when it primarily blows from SE direction. The site is largely tussock tundra but to the south there is thermokarst 


```{r, include=FALSE}
rm(list = ls())

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix)
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(pracma)
library(dplyr)


Sys.setenv(TZ='UTC')
```

# Set working directory and then Load data

```{r}
#using the ".2" version to reflect the updated SWC used in RF 

#original half-hourly dataframe 
df = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

#needs continuous day variable - daily avg, calculated in processing steps
df_avg = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_AVG_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

# #monthly avg, calculated in processing steps 
# df_monthly_avg = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_monthly_AVG_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


```


```{r}
#quick look at the different temp profiles (all at 15 cm depth, diff locations)
sum(is.na(df$TS_1_1_1)) #60277 NA's in temp by margin pond 
sum(is.na(df$TS_2_1_1)) #48729 NA's in temp  by lichen/berries  
sum(is.na(df$TS_3_1_1)) #50445 NA's in temp by tussock 
sum(is.na(df$TS_4_1_1)) #52796 NA's in temp by foot of EC tower
sum(is.na(df$TS_5_1_1)) #new temp in latest upload with 2023 data, don't have info on what it is yet** 


#SWC also broken up by location
#  SWC_1_1_1 % Soil water content (15cm depth) – margin pond
# SWC_2_1_1 % Soil water content (15cm depth) – lichen/berries
# SWC_3_1_1 % Soil water content (15cm depth) - tussock


```

```{r}
#checking timestamp 
ggplot(data = df,aes(TIMESTAMP_END,FC_F))+
  geom_point()+
  scale_x_datetime(limits = as.POSIXct(c('2021-09-28','2021-10-05')))+
  scale_y_continuous(limits = c(-12,5))
```

#create a useable timestamp - not necessary here as it's already in the correct format from our BASE processing code 
```{r}
#ignore this if df is already in correct format, as this might mess up the formatting here and cause issues with analysis
# df$TIMESTAMP_END = as.character(df$TIMESTAMP_END)
# df$TIMESTAMP_START = as.character(df$TIMESTAMP_START)
# 
# df$TIMESTAMP_END = as.POSIXct(df$TIMESTAMP_END, tz="UTC", format = "%Y%m%d%H%M")
# df$TIMESTAMP_START = as.POSIXct(df$TIMESTAMP_START, tz="UTC", format = "%Y%m%d%H%M")
```

#Yearly df -  function (currently not working anymore, see workaround below)
```{r}
#Create yearly dataframes

#create TIMESTAMP variable that is = to TIMESTAMP_END

#for some reason this function isn't working anymore

 df$TIMESTAMP = df$TIMESTAMP_END
# 
# year_df <- function(df, year) {
#   df %>%
#     filter(format(date, "%Y") == as.character(year)) %>%
#     mutate(DOY = yday(date))
# }

#for some reason the yr function is not working 
# df_avg_2018 <- year_df(df_avg, 2018)
# df_avg_2019 <- year_df(df_avg, 2019)
# df_avg_2020 <- year_df(df_avg, 2020)
# df_avg_2021 <- year_df(df_avg, 2021)
# df_avg_2022 <- year_df(df_avg, 2022)
# df_avg_2023 <- year_df(df_avg, 2023)

# #map out the timestamp of the half-hourly dataset
# df$date <- as.POSIXct(df$date, format = "%Y-%m-%d %H:%M:%OS") #yr month day hour min sec
# #dforig$date <- as.POSIXct(df$date, format = "%Y-%m-%d %H:%M:%OS") #yr month day hour min sec --> dataset using SWC_1
# 
# df_2017 <- year_df(df, 2017)
# df_2018 <- year_df(df, 2018)
# df_2019 <- year_df(df, 2019)
# df_2020 <- year_df(df, 2020)
# df_2021 <- year_df(df, 2021)
# df_2022 <- year_df(df, 2022)
# df_2023 <- year_df(df, 2023)


```


####create dataframes for each year for the data you have so you can look at annual trends 

#Creates data frames of each year containing the daily averages of each value- useful for focusing on one year at a time
```{r}
#create dataframes for each year for the data you have so you can look at annual trends 

#map out the timestamp of the daily avg dataset
df_avg$date <- as.POSIXct(df_avg$date, format = "%Y-%m-%d") #tells R the order of the timestamp: yr-month-day 

df_avg_2017 <- df_avg %>% filter(year == "2017") 
df_avg_2018 <- df_avg %>% filter(year == "2018") 
df_avg_2019 <- df_avg %>% filter(year == "2019") 
df_avg_2020 <- df_avg %>% filter(year == "2020") 
df_avg_2021 <- df_avg %>% filter(year == "2021") 
df_avg_2022 <- df_avg %>% filter(year == "2022") 
df_avg_2023 <- df_avg %>% filter(year == "2023") 


#for HH data
df <- df %>%
  mutate(year = format(date, "%Y"))

df_2017 <- df %>% filter(year == "2017") 
df_2018 <- df %>% filter(year == "2018") 
df_2019 <- df %>% filter(year == "2019") 
df_2020 <- df %>% filter(year == "2020") 
df_2021 <- df %>% filter(year == "2021") 
df_2022 <- df %>% filter(year == "2022") 
df_2023 <- df %>% filter(year == "2023") 


```



#Comparing SWC and soil temp from the different locations 
```{r}
#SWC 
ggplot(data = df) +
  geom_line(aes(TIMESTAMP, SWC_1_1_1, col = 'SWC1 margin pond'))+
  geom_line(aes(TIMESTAMP, SWC_2_1_1, col = 'SWC2 lichen berries')) +
  geom_line(aes(TIMESTAMP, SWC_3_1_1, col = 'SWC3 tussock')) +
  labs(title = "Comparing SWC locations")+
  labs( x = "Timestamp",
        y = "SWC")+
  scale_y_continuous()+
  theme_minimal()


#soil temp
ggplot(data = df) +
    geom_line(aes(TIMESTAMP, TS_5_1_1, col = 'TS5 unknown')) + #putting it at front so other colored lines are not obscured by TS5
  geom_line(aes(TIMESTAMP, TS_1_1_1, col = 'TS1 margin pond'))+
  geom_line(aes(TIMESTAMP, TS_2_1_1, col = 'TS2 lichen berries')) +
  geom_line(aes(TIMESTAMP, TS_3_1_1, col = 'TS3 tussock')) +
  geom_line(aes(TIMESTAMP, TS_4_1_1, col = 'TS4 EC tower')) +
  #geom_line(aes(TIMESTAMP, TS_5_1_1, col = 'TS5 unknown')) +
  labs(title = "Comparing Soil temp among locations")+
  labs( x = "Timestamp",
        y = "Soil temp (C)")+
  scale_y_continuous()+
  theme_minimal()


```
#***Annual budgets, seasonal budgets, figures, and correlations using daily avg df_avg

#Seasonal and annual summaries of CO2, CH4, soil temp, air temp, swc, and ERA5

#Adding in annual and seasonal total C budgets (sum of CO2 and CH4) - using daily avg data since HH and daily avg agreed in previous code chunks 

#Creating seasonal and annual total C budget tables 
```{r}
# Load necessary packages
library(dplyr)
library(ggplot2)
library(lubridate)

#Annual and seasonal summaries with SE 

#no SE for CO2 and CH4 fluxes as these are sums **** then we calc averages with SE for the met variables 

# Annual summaries with standard errors
# Annual summaries with total C budget
annual_budgets <- df_avg %>%
  group_by(year = year(date)) %>%
  filter(year != 2023) %>% #removing 2023 due to incomplete year data 
  summarize(
    CO2_budget = sum(FC_F * (60*60*24*(1/1000000)*12), na.rm = TRUE),
    CH4_budget = sum(FCH4_F * (60*60*24*(1/1000000000)*12), na.rm = TRUE),
    total_C_budget = CO2_budget + CH4_budget,  # Adding total C budget
    mean_soil_temp = mean(TS_3_1_1, na.rm = TRUE),
    se_soil_temp = sd(TS_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(TS_3_1_1))),
    mean_TS_ERA5 = mean(TS_ERA5, na.rm = TRUE),
    se_TS_ERA5 = sd(TS_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TS_ERA5))),
    mean_soil_moisture = mean(SWC_3_1_1, na.rm = TRUE),
    se_soil_moisture = sd(SWC_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(SWC_3_1_1))),
    mean_TA = mean(TA, na.rm = TRUE),
    se_TA = sd(TA, na.rm = TRUE)/sqrt(sum(!is.na(TA))),
    mean_TA_ERA5 = mean(TA_ERA5, na.rm = TRUE),
    se_TA_ERA5 = sd(TA_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TA_ERA5)))
  )

# Seasonal summaries with total C budget
seasonal_budgets <- df_avg %>%
  group_by(year = year(date), season) %>%
  filter(year != 2023) %>% #removing 2023 due to incomplete year data 
  summarize(
    CO2_budget = sum(FC_F * (60*60*24*(1/1000000)*12), na.rm = TRUE),
    CH4_budget = sum(FCH4_F * (60*60*24*(1/1000000000)*12), na.rm = TRUE),
    total_C_budget = CO2_budget + CH4_budget,  # Adding total C budget
    mean_soil_temp = mean(TS_3_1_1, na.rm = TRUE),
    se_soil_temp = sd(TS_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(TS_3_1_1))),
    mean_TS_ERA5 = mean(TS_ERA5, na.rm = TRUE),
    se_TS_ERA5 = sd(TS_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TS_ERA5))),
    mean_soil_moisture = mean(SWC_3_1_1, na.rm = TRUE),
    se_soil_moisture = sd(SWC_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(SWC_3_1_1))),
    mean_TA = mean(TA, na.rm = TRUE),
    se_TA = sd(TA, na.rm = TRUE)/sqrt(sum(!is.na(TA))),
    mean_TA_ERA5 = mean(TA_ERA5, na.rm = TRUE),
    se_TA_ERA5 = sd(TA_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TA_ERA5))),
    days = n()
  )

print(annual_budgets)
print(seasonal_budgets)
```
#Save table of annual and/or seasonal budgets 
```{r}
# Save as a nicely formatted table using kableExtra from knitr package 
# good for a publication or report --> creates HTML table, but not as customize-able as if you were to make it in Excel 

install.packages("kableExtra") 

library(kableExtra)

#Seasonal budgets 

seasonal_budgets %>%
  kable(digits = 2) %>%  # rounds numbers to 2 decimal places
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  save_kable("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_formatted.html")

#Write table to Excel file:
# First install if needed:
install.packages("writexl")

library(writexl)
write_xlsx(seasonal_budgets, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets.xlsx")

#Write table to CSV
# base R, no additional packages needed)
write.csv(seasonal_budgets, "seasonal_budgets.csv", row.names = FALSE)


# Create a new table with combined mean ± SE format
seasonal_budgets_formatted <- seasonal_budgets %>%
  mutate(
    soil_temp = sprintf("%.2f ± %.2f", mean_soil_temp, se_soil_temp),
    soil_moisture = sprintf("%.2f ± %.2f", mean_soil_moisture, se_soil_moisture),
    air_temp = sprintf("%.2f ± %.2f", mean_TA, se_TA),
    TS_ERA5 = sprintf("%.2f ± %.2f", mean_TS_ERA5, se_TS_ERA5),
    TA_ERA5 = sprintf("%.2f ± %.2f", mean_TA_ERA5, se_TA_ERA5)
  ) %>%
  select(year, season, CO2_budget, CH4_budget, total_C_budget, soil_temp, soil_moisture, air_temp, TS_ERA5, TA_ERA5, days)

# Save to Excel
write_xlsx(seasonal_budgets_formatted, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_formatted2.xlsx")

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#Annual budgets 
# Create a new table with combined mean ± SE format
annual_budgets_formatted <- annual_budgets %>%
  mutate(
    soil_temp = sprintf("%.2f ± %.2f", mean_soil_temp, se_soil_temp),
    soil_moisture = sprintf("%.2f ± %.2f", mean_soil_moisture, se_soil_moisture),
    air_temp = sprintf("%.2f ± %.2f", mean_TA, se_TA),
    TS_ERA5 = sprintf("%.2f ± %.2f", mean_TS_ERA5, se_TS_ERA5),
    TA_ERA5 = sprintf("%.2f ± %.2f", mean_TA_ERA5, se_TA_ERA5)
  ) %>%
  select(year, CO2_budget, CH4_budget, total_C_budget, soil_temp, soil_moisture, air_temp, TS_ERA5, TA_ERA5)

# Save to Excel
write_xlsx(annual_budgets_formatted, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/annual_budgets_formatted.xlsx")

```




#Plot annual and seasonal budgets 
```{r}
# Create visualizations

# 1. Annual CO2 budget
ggplot(annual_budgets, aes(x = factor(year))) +
  geom_bar(aes(y = CO2_budget), stat = "identity", fill = "steelblue") +
  geom_text(aes(y = CO2_budget, label = round(CO2_budget, 1)), vjust = -0.5) +
  labs(title = "Annual CO2 Budget by Year",
       x = "Year",
      # y = "CO2 Budget (gC/m²/year)") +
  y = expression(CO[2]~Budget~(gC/m^2/year))) +
  theme_bw()

#Annual budget for CH4
ggplot(annual_budgets, aes(x = factor(year))) +
  geom_bar(aes(y = CH4_budget), stat = "identity", fill = "darkgreen") +
  geom_text(aes(y = CH4_budget, label = round(CH4_budget, 2)), vjust = -0.5) +
  labs(title = "Annual CH4 Budget by Year",
       x = "Year",
      # y = "CH4 Budget (gC/m²/year)") +
  y = expression(CH[4]~Budget~(gC/m^2/year))) +
  theme_bw()


# 2. Seasonal patterns
#Re-order the seasons 
seasonal_budgets$season <- factor(seasonal_budgets$season, 
                                levels = c("Growing Season", "Fall Senescence", "Winter"))
# Create seasonal budget plots for CO2
seasonal_budgets_CO2 <- ggplot(seasonal_budgets, aes(x = factor(year), y = CO2_budget, fill = season)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept=0, colour = "black")+ 
  labs(title = expression(bold(Net~Seasonal~CO[2]~Flux~by~Year)),
       x = "Year",
        fill = "Season",
       #y = "CO2 Budget (gC/m²/season)") +
   y = expression(bold(Net~CO[2]~Flux~(gC/m^2/season)))) +
  scale_fill_manual(values = c("darkgreen", "brown4","steelblue1"))+
   scale_y_continuous(
      limits = c(-125, 125),  # Adjust these limits as needed
      breaks = seq(-125, 125, by = 25))+
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
                                  axis.text = element_text(size = 12, face = "bold"),
                                  axis.title = element_text(size = 14, face = "bold"))

  print(seasonal_budgets_CO2)

#Seasonal budgets for CH4
seasonal_budgets_CH4 <- ggplot(seasonal_budgets, aes(x = factor(year), y = CH4_budget, fill = season)) +
  geom_bar(stat = "identity", position = "dodge") +
  #labs(title = "Seasonal CH4 Budgets by Year",
  labs(title = expression(bold(Net~Seasonal~CH[4]~Flux~by~Year)),
       x = "Year",
       fill = "Season",
       #y = "CO2 Budget (gC/m²/season)") +
   y = expression(bold(Net~CH[4]~Flux~(gC/m^2/season)))) +
     scale_fill_manual(values = c("darkgreen","brown4", "steelblue1")) +
     scale_y_continuous(
      limits = c(0, 2.5),  # Adjust these limits as needed
      breaks = seq(0, 2.5, by = 0.5))+
  theme_bw() +
  theme(
    # axis.text.x = element_text(size = 14, face = "bold"),
    #  axis.text.y = element_text(size = 14, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 14, face = "bold"))

print(seasonal_budgets_CH4)

#Save CO2 seasonal budgets 

ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_CO2.png", seasonal_budgets_CO2, 
       width = 10, height = 7, dpi = 600)


#Save CH4 seasonal budgets 
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_CH4.png", seasonal_budgets_CH4, 
       width = 10, height = 7, dpi = 600)
```
#Checking normality of data for corr matrix - non-GF
```{r}
# Shapiro-Wilk test for normality across entire dataset
shapiro_test <- shapiro.test(df_avg$FCH4)
print(shapiro_test)

#flux_CO2: p<0.001, *NOT normal
#flux-CH4: p<0.001, *NOT normal

#by year 
shapiro_test <- shapiro.test(df_avg_2019$FC)
print(shapiro_test)

#all p<0.05 & NOT normal unless otherwise indicated 
#2017: FC   FCH4 
#2018: FC   FCH4
#2019: FC   FCH4
#2020: FC   FCH4 p=0.9, normal
#2021: FC p = 0.08, normal ; FCH4 p = 0.09, normal 
#2022: FC   FCH4


#Should use spearman non-parametric corr for corr matrix 
```




#Correlation matrix 

####Flux v Environmental correlation matrix --> use non-GF for correlation matrix and stats*

####Create corr matrix with complete observations 
```{r}
# Environmental relationships
# Create a correlation plot between fluxes and environmental variables
env_flux_daily_notGF <- df_avg %>%
  select(FC, FCH4, GPP, RECO, TS_3_1_1, SWC_3_1_1, TA, WS, WD, TA_ERA5, TS_ERA5) %>%
  rename(
    NEE = FC,
    CH4_flux = FCH4,
    GPP = GPP,
    RECO = RECO,
    Soil_temp = TS_3_1_1,
    Soil_moisture = SWC_3_1_1,
    Air_temp = TA,
    Wind_speed = WS,
    Wind_Direction = WD,
    Air_temp_ERA5 = TA_ERA5,
    Soil_temp_ERA5 = TS_ERA5
  )


```

#Pearson correlation - but data is not normally distributed, so this is for comparison but use spearman corr below 
```{r}
#comparing spearman and pearson correlations - exploratory 
corr_result_pearson <- rcorr(as.matrix(env_flux_daily_notGF))

# Step 2: Extract correlation coefficients and p-values
cor_coef_pearson <- corr_result_pearson$r
cor_p_pearson <- corr_result_pearson$P

# Step 3: Create a long format data frame for plotting
cor_long_pearson <- reshape2::melt(cor_coef_pearson)
names(cor_long_pearson) <- c("Var1", "Var2", "Correlation")

# Step 4: Add p-values to the long format data
p_long_pearson <- reshape2::melt(cor_p_pearson)
cor_long_pearson$p_value <- p_long_pearson$value

# Step 5: Add significance indicators
cor_long_pearson$significance <- ""
cor_long_pearson$significance[cor_long_pearson$p_value < 0.05] <- "*"    # p < 0.05
cor_long_pearson$significance[cor_long_pearson$p_value < 0.01] <- "**"   # p < 0.01
cor_long_pearson$significance[cor_long_pearson$p_value < 0.001] <- "***" # p < 0.001

```



#Spearman correlation 
```{r}
cor_matrix2 <- cor(env_flux_daily_notGF, method = "spearman", use = "pairwise.complete.obs")

#For p-values, use rcorr
library(Hmisc)
corr_with_p <- rcorr(as.matrix(env_flux_daily_notGF), type = "spearman")
print(corr_with_p)

# View results
print(cor_matrix2)
print("P-values:")
print(corr_with_p$P)


# Convert correlation matrix to long format for plotting
cor_long2 <- as.data.frame(as.table(cor_matrix2))
names(cor_long2) <- c("Var1", "Var2", "Correlation")


```


#Correlation matrix, non-GF fluxes - adj color breaks and adding values to the tiles 
```{r}
#adjusted this to use non-GF C fluxes 

# Fewer breaks for a cleaner look, only labels corr values above 0.3 --> I like this one best 
ggplot(cor_long2, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile() +
  # Add correlation values only for strong correlations
  geom_text(data = subset(cor_long2, abs(Correlation) > 0.3),  # Only show stronger correlations
            aes(label = sprintf("%.2f", Correlation),
                 color = abs(Correlation) < 0.5), # Changes text color based on correlation strength
            size = 3,
            fontface = "bold") + #to make numbers in tiles bold
  scale_fill_gradient2(low = "red", 
                      mid = "white", 
                      high = "blue", 
                      midpoint = 0,
                      limits = c(-1, 1),
                      breaks = c(-1, -0.5, 0, 0.5, 1)) +
    scale_color_manual(values = c("white", "black"), guide = "none") +  # For text visibility
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +                 
  labs(title = "Correlation Matrix of C Fluxes and Environmental Variables")

 #saves the figure directly above 
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/flux_correlation_matrix_allyears_notGF.png",
       width = 7, height = 5, dpi = 600)

```

####double checking corr results with pairwise tests 
```{r}
#double checking 
cor.test(df_avg$FC, df_avg$TS_3_1_1,, method="spearman")
cor.test(df_avg$FC, df_avg$TA, method="spearman")
cor.test(df_avg$FC, df_avg$TA_ERA5, method="spearman")

```


#Adding p-values to corr figure - help from Claude
```{r}
# Step 1: Calculate correlation and p-values
library(Hmisc)
corr_result <- rcorr(as.matrix(env_flux_daily_notGF), type = "spearman")

# Step 2: Extract correlation coefficients and p-values
cor_coef <- corr_result$r
cor_p <- corr_result$P

# Step 3: Create a long format data frame for plotting
cor_long <- reshape2::melt(cor_coef)
names(cor_long) <- c("Var1", "Var2", "Correlation")

# Step 4: Add p-values to the long format data
p_long <- reshape2::melt(cor_p)
cor_long$p_value <- p_long$value

# Step 5: Add significance indicators
cor_long$significance <- ""
cor_long$significance[cor_long$p_value < 0.05] <- "*"    # p < 0.05
cor_long$significance[cor_long$p_value < 0.01] <- "**"   # p < 0.01
cor_long$significance[cor_long$p_value < 0.001] <- "***" # p < 0.001

# Step 6: Create the correlation plot with significance indicators
ggplot(cor_long, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile() +
  # Add correlation coefficients with significance stars
  geom_text(aes(label = paste0(round(Correlation, 2), significance)), 
            color = "black", size = 3) +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0,
                      limits = c(-1, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 10, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +
  labs(title = "Correlation Matrix C Fluxes and Environmental Variables")




#correlation matrix using spearman's corr, for non-parametric / not normally distributed data 
ggplot(cor_long2, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile() +
  # Add correlation values only for strong correlations
  geom_text(data = subset(cor_long, abs(Correlation) > 0.3),  # Only show stronger correlations
            aes(label = paste0(sprintf("%.2f", Correlation), significance),
                 color = abs(Correlation) < 0.5), # Changes text color based on correlation strength
            size = 4.5,
            fontface = "bold") + #to make numbers in tiles bold
  scale_fill_gradient2(low = "red", 
                      mid = "white", 
                      high = "blue", 
                      midpoint = 0,
                      limits = c(-1, 1),
                      breaks = c(-1, -0.5, 0, 0.5, 1)) +
    scale_color_manual(values = c("white", "black"), guide = "none") +  # For text visibility
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 14, face = "bold", hjust = 0.5)) +                 
  labs(title = "Correlation Matrix of C Fluxes and Environmental Variables")


#Display corr text on tiles if it's >0.3 OR if it has a sig p 

ggplot(cor_long, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile() +
  # Add correlation values for EITHER strong correlations OR significant ones
  geom_text(data = subset(cor_long, abs(Correlation) > 0.3 | p_value < 0.05), #the | represents "OR" so this displays correlations above 0.3 OR significant correlations; also use "abs" to use absolute value of the corr so it's printed whether it's positive or negative*  
            aes(label = paste0(sprintf("%.2f", Correlation), significance),
                color = abs(Correlation) < 0.5), # Changes text color based on correlation strength
            size = 4.5,
            fontface = "bold") + #to make numbers in tiles bold
  scale_fill_gradient2(low = "red", 
                      mid = "white", 
                      high = "blue", 
                      midpoint = 0,
                      limits = c(-1, 1),
                      breaks = c(-1, -0.5, 0, 0.5, 1)) +
    scale_color_manual(values = c("white", "black"), guide = "none") +  # For text visibility
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12, face = "bold"),
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5)) +                 
  labs(title = "Correlation Matrix of C Fluxes and Environmental Variables",
       fill = "Spearman's \nCorrelation \n(ρ)")



 #saves the figure directly above 
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/flux_Spearmancorrelation_matrix_allyears_notGF.png",
       width = 11, height = 8, dpi = 600)
```

#Adding in p-value adjustments based on sample size / number of pairwise pairings


####Options include Bonferroni (much more conservative, use when you don't want ANY false positivies from a few critical hypotheses you're testing) and Benjamini-Hochberg (little less conservative, but has more power & keeps false positivies below 5% -may be better for very large datasets/exploratory work) 

coding help from chatGPT
```{r}

# 1. Load libraries
library(Hmisc)    # for rcorr()
library(reshape2) # for melt()
library(ggplot2)  # for plotting

# 2. Compute Spearman correlations + raw p-values
corr_result <- rcorr(as.matrix(env_flux_daily_notGF), type = "spearman")
# corr_result$r is the matrix of ρ’s
# corr_result$P is the matrix of raw p-values

# 3. Flatten the raw p-values to a vector
p_raw_flat <- as.vector(corr_result$P)

# 4. Apply multiple‐testing corrections to that vector
p_adjBH_flat  <- p.adjust(p_raw_flat, method = "BH")          # Benjamini–Hochberg
p_adjBon_flat <- p.adjust(p_raw_flat, method = "bonferroni")  # Bonferroni

# 5. Reassemble adjusted p’s into matrices matching the original dimensions
p_adjBH_mat  <- matrix(p_adjBH_flat,
                       nrow = nrow(corr_result$P),
                       ncol = ncol(corr_result$P),
                       dimnames = dimnames(corr_result$P))

p_adjBon_mat <- matrix(p_adjBon_flat,
                       nrow = nrow(corr_result$P),
                       ncol = ncol(corr_result$P),
                       dimnames = dimnames(corr_result$P))

# 6. Melt correlation coefficients and all three p-value matrices
cor_long     <- melt(corr_result$r,
                     varnames   = c("Var1","Var2"),
                     value.name = "Correlation")

p_raw_long    <- melt(corr_result$P,
                      varnames   = c("Var1","Var2"),
                      value.name = "p_raw")

p_bh_long     <- melt(p_adjBH_mat,
                      varnames   = c("Var1","Var2"),
                      value.name = "p_adjBH")

p_bonf_long   <- melt(p_adjBon_mat,
                      varnames   = c("Var1","Var2"),
                      value.name = "p_adjBon")

# 7. Combine them all into one data frame
cor_long$p_raw    <- p_raw_long$p_raw
cor_long$p_adjBH  <- p_bh_long$p_adjBH
cor_long$p_adjBon <- p_bonf_long$p_adjBon

# 8. (Optional) Add significance stars for each correction
#    – here we flag p < .05, p < .01, p < .001
cor_long$sigBH  <- cut(cor_long$p_adjBH,
                       breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", ""))

cor_long$sigBon <- cut(cor_long$p_adjBon,
                       breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
                       labels = c("***", "**", "*", ""))

# Now cor_long has columns:
#   Correlation   – the Spearman ρ
#   p_raw         – the unadjusted p-value
#   p_adjBH       – the FDR-adjusted p-value
#   p_adjBon      – the Bonferroni-adjusted p-value
#   sigBH, sigBon – significance stars for each

# 9. (Re)plot your heatmap, for example annotating based on BH but you could easily switch to Bonferroni
ggplot(cor_long, aes(x = Var1, y = Var2, fill = Correlation)) +
  geom_tile() +
  geom_text(
    data = subset(cor_long, abs(Correlation) > 0.3 | p_adjBon < 0.05),
    aes(label = paste0(sprintf("%.2f", Correlation), sigBon)),
    color = "white", size = 4, fontface = "bold"
  ) +
  scale_fill_gradient2(
    low = "red", mid = "white", high = "blue",
    midpoint = 0, limits = c(-1,1)
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text   = element_text(size = 12, face = "bold"),
    plot.title  = element_text(size = 16, face = "bold", hjust = 0.5)
  ) +
  labs(
    title = "Correlation Matrix of C Fluxes and Environmental Variables",
    fill = "Spearman ρ"
  )


```






#Annual total C and Seasonal C flux plots 
```{r}
# Create visualization for annual total C budget
ggplot(annual_budgets, aes(x = factor(year))) +
  geom_bar(aes(y = total_C_budget), stat = "identity", fill = "purple") +
  geom_text(aes(y = total_C_budget, label = round(total_C_budget, 1)), vjust = -0.5) +
  labs(title = "Annual Total Carbon Budget by Year",
       x = "Year",
       y = expression(Total~C~Budget~(gC/m^2/year))) +
  theme_bw()

# Create visualization for seasonal total C budget
ggplot(seasonal_budgets, aes(x = factor(year), y = total_C_budget, fill = season)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(y = total_C_budget, label = round(total_C_budget, 1)), 
           # vjust = -0.5, 
            vjust = ifelse(seasonal_budgets$total_C_budget < 0, 1.5, -0.5), #this neatly aligns the label with the corresponding bar
            position = position_dodge(width = 0.9),  ) +
  labs(title = "Seasonal Total Carbon Budgets by Year",
       x = "Year",
       y = expression(Total~C~Budget~(gC/m^2/season))) +
     scale_y_continuous(
      limits = c(-150, 150),  # Adjust these limits as needed
      breaks = seq(-150, 150, by = 50))+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

#Save yearly images individually 
```{r}
# Function to Save individual plots as individual images
for(i in seq_along(yearly_plots)) {
  ggsave(
    filename = paste0("carbon_budget_", 2016+i, ".png"),
    plot = yearly_plots[[i]],
    width = 8,
    height = 6,
    dpi = 300
  )
}

```

#Total carbon flux by year gridded figure with shared axis label 
```{r}
# Load required packages
library(gridExtra)
library(grid)

# Create separate plots for each year using lapply
# lapply applies the same function to each year (2017:2022)
yearly_plots <- lapply(2017:2022, function(yr) {
  ggplot(annual_budget_long %>% filter(year == yr), 
         aes(x = flux_type, y = flux)) +
    geom_bar(stat = "identity", fill = "#00BFC4") +
    geom_label(aes(label = round(flux, 2),
                   # Put the vjust logic inside aes()
                   vjust = ifelse(flux < 0, 
                                ifelse(flux_type == "CO2", 2.5, 2), #adjusts the neg CO2 value neatly under bar
                                -0.5)),
              hjust = 0.5,
              size = 3.5,
              label.padding = unit(0.2, "lines"),
              fill = "white",
              colour = "black") +
    # Set plot labels
    labs(title = as.character(yr),
         x = "",
         y = "") +  # Remove y-axis label since we'll have a shared one
    # Use clean theme
    theme_bw() +
    # Customize theme elements
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 14, face = "bold"),
      axis.title = element_text(size = 16, face = "bold"),
      panel.grid.major = element_line(color = "grey90"),
      panel.grid.minor = element_line(color = "grey95")
    ) +
    # Set y-axis limits and breaks
    scale_y_continuous(
      limits = c(-20, 50),
      breaks = seq(-20, 50, by = 10)
    )
})

# Create the grid arrangement with shared y-axis label
grid_arranged <- arrangeGrob(
  grobs = yearly_plots,
  ncol = 2,  # Arrange plots in 2 columns
  # Add shared y-axis label, rotated 90 degrees
  left = textGrob(expression(Net~Carbon~Flux~(gC~m^-2~y^-1)), 
                  rot = 90,
                  gp = gpar(fontsize = 30))
)

# Display the arranged grid
grid.arrange(grid_arranged)

#save
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/yearly_carbon_fluxes.png", grid_arranged, 
       width = 10, height = 15, dpi = 600)


```

#Bar graph of net CO2, CH4, and total C fluxes 

```{r}
# Reshape data for plotting
annual_budgets_long <- annual_budgets %>%
  select(year, CO2_budget, CH4_budget, total_C_budget) %>%
  pivot_longer(cols = c(CO2_budget, CH4_budget, total_C_budget),
               names_to = "flux_type",
               values_to = "flux")


# Create plot with perfectly aligned boxed labels for CO2 and CH4 
ggplot(annual_budgets_long, aes(x = factor(year), y = flux, fill = gas_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  geom_label(aes(label = round(budget, 1), group = flux_type), # Added group aesthetic
            position = position_dodge(width = 0.9),            # Match dodge width with bars
            vjust = ifelse(annual_budgets_long$budget < 0, 1.5, -0.5),
            hjust = 0.5,
            size = 3.5,
            label.padding = unit(0.2, "lines"),
            fill = "white",
            colour = "black") +
  labs(title = "Annual Carbon Budget by Year",
       x = "Year",
       y = expression(C~Budget~(gC/m^2/year)),
       fill = "Flux Type") +
  scale_fill_manual(values = c("salmon", "turquoise"),
                    labels = c(expression(CH[4]), expression(CO[2]))) +
   scale_y_continuous(
        breaks = seq(-20, 50, 10),  # Set limits for the primary axis - other years go up to -73
    limits = c(-20, 50))+ 
  theme_bw()


# Bar graph with CO2, CH4, and total C annual budgets with labeled flux values 
ggplot(annual_budgets_long, aes(x = factor(year), y = flux, fill = flux_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  # geom_label(aes(label = round(flux, 1), group = flux_type),
  #           position = position_dodge(width = 0.9),
  #           hjust = 0.5,
               #vjust = ifelse(annual_budget_long$flux < 0, 2.5, -0.5), #adjust all labels 
               # vjust = ifelse(annual_budget_long$flux < 0, 2.5,  # for negative values; if below 0, set label positioned 2 units below the bar for negative values
            geom_label(aes(label = round(flux, 1), group = flux_type),
            position = position_dodge(width = 0.9),
            hjust = 0.5,
            vjust = case_when(
              # For CO2 fluxes
              annual_budget_long$flux_type == "CO2" & annual_budget_long$flux < 0 ~ 1.8,  # negative CO2
              annual_budget_long$flux_type == "CO2" & annual_budget_long$flux >= 0 ~ -0.5,  # positive CO2
              # For Total fluxes
              annual_budget_long$flux_type == "Total" & annual_budget_long$flux < 0 ~ 1.2, # negative Total
              annual_budget_long$flux_type == "Total" & annual_budget_long$flux >= 0 ~ -1, # positive Total
              # For CH4 fluxes (all cases)
              annual_budget_long$flux_type == "CH4" ~ -0.5
            ),
            size = 3.5,
            label.padding = unit(0.2, "lines"),
            fill = "white",
            colour = "black") +
  labs(title = "Annual Carbon Budget by Year",
       x = "Year",
       y = expression(C~Budget~(gC/m^2/year)),
       fill = "Flux Type") +
  scale_fill_manual(values = c("salmon", "turquoise", "grey"),
                    labels = c(expression(CH[4]), expression(CO[2]), "Total C")) +
   scale_y_continuous(
        breaks = seq(-20, 50, 10),
        limits = c(-20, 55)) +  # Slightly increased upper limit to accommodate labels
  theme_bw()+
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 14, face = "bold"))



#bar graph of net CH4, CO2, and total C without labels above bars 

annual_Cbudget_bargraph <- ggplot(annual_budgets_long, aes(x = factor(year), y = flux, fill = flux_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  labs(title = "Annual Net Carbon Flux by Year",
       x = "Year",
       y = expression(Net~C~Flux~(gC/m^2/year)),
       fill = "Flux Type") +
  scale_fill_manual(values = c("salmon", "turquoise", "grey"),
                    labels = c(expression(CH[4]), expression(CO[2]), "Total C")) +
   scale_y_continuous(
        breaks = seq(-15, 45, 10),
        limits = c(-15, 45)) +  # Slightly increased upper limit to accommodate labels
  theme_bw()+
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 14, face = "bold"))

annual_Cbudget_bargraph

#save
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/yearly_carbon_fluxes_bargraph.png", annual_Cbudget_bargraph, 
       width = 10, height = 7, dpi = 600)


```

#***Adjusting the winter methane budget --> 98% of growing season CH4 flux --> new table to plot 

```{r}
#Load annual and seasonal tables with adjusted winter methane 
install.packages("readxl")
library("readxl")
# 
# adj_C_budgets = fread("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/Seasonal_Cbudgets_Table_all_years_for_paper.xlsx",na.strings = c('-9999','NA','NaN','NAN','-7999'))

adj_C_budgets <- read_xlsx(path ="C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/Seasonal_Cbudgets_Table_all_years_for_paper.xlsx", sheet = "R template" )

# Reshape data for plotting
adj_C_budgets_long<- adj_C_budgets %>%
  pivot_longer(cols = c(Net_CO2, Net_CH4_adj, Total_Net_C),
               names_to = "flux_type",
               values_to = "flux")


```

#Plot of budgets with winter-adj CH4 --> not redoing CO2 as those budgets should remain the same 
```{r}
#Seasonal patterns - winter-adj CH4

#Seasonal budgets for CH4
adj_seasonal_budgets_CH4 <- ggplot(adj_C_budgets %>% 
                                    filter(Season != "Annual"), #takes out "annual" as a season
                                  aes(x = factor(Year), y = Net_CH4_adj, fill = Season)) +
  geom_bar(stat = "identity", position = "dodge") +
  #labs(title = "Seasonal CH4 Budgets by Year",
  labs(title = expression(bold(Net~Seasonal~CH[4]~Flux~by~Year)),
       x = "Year",
       fill = "Season",
       #y = "CO2 Budget (gC/m²/season)") +
   y = expression(bold(Net~CH[4]~Flux~(gC/m^2/season)))) +
     scale_fill_manual(values = c("brown4", "darkgreen", "steelblue1", "grey")) +
     scale_y_continuous(
      limits = c(0, 2.5),  # Adjust these limits as needed
      breaks = seq(0, 2.5, by = 0.5))+
  theme_bw() +
  theme(
    # axis.text.x = element_text(size = 14, face = "bold"),
    #  axis.text.y = element_text(size = 14, face = "bold"),
        plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 14, face = "bold"))

adj_seasonal_budgets_CH4

#Save CH4 seasonal budgets 
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/adj_seasonal_budgets_CH4.png", adj_seasonal_budgets_CH4, 
       width = 10, height = 7, dpi = 600)
```

#bar graph of seasonal budgets 
```{r}
#bar graph of net CH4, CO2, and total C without labels above bars 

adj_annual_Cbudget_bargraph <- ggplot(adj_C_budgets_long %>%
                                        filter(Season == "Annual"),
                                               aes(x = factor(Year), y = flux, fill = flux_type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  labs(title = "Annual Net Carbon Flux by Year",
       x = "Year",
       y = expression(Net~C~Flux~(gC/m^2/year)),
       fill = "Flux Type") +
  scale_fill_manual(values = c("salmon", "turquoise", "grey"),
                    labels = c(expression(CH[4]), expression(CO[2]), "Total C")) +
   scale_y_continuous(
        breaks = seq(-15, 45, 10),
        limits = c(-15, 45)) +  # Slightly increased upper limit to accommodate labels
  theme_bw()+
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 12, face = "bold"),
      axis.title = element_text(size = 14, face = "bold"))

adj_annual_Cbudget_bargraph

#save
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/adj_yearly_carbon_fluxes.png", adj_annual_Cbudget_bargraph, 
       width = 10, height = 7, dpi = 600)
```

#gridded bar graph of budgets with winter-adj methane 
```{r}

# Load required packages
library(gridExtra)
library(grid)

# Create separate plots for each year using lapply
# lapply applies the same function to each year (2017:2022)
adj_yearly_plots <- lapply(2017:2022, function(yr) {
  ggplot(adj_C_budgets_long %>% filter(Year == yr) %>%
              filter(Season == "Annual"),
         aes(x = flux_type, y = flux)) +
    geom_bar(stat = "identity", fill = "#00BFC4") +
    geom_label(aes(label = round(flux, 2),
                   # Put the vjust logic inside aes()
                   vjust = ifelse(flux < 0, 
                                ifelse(flux_type == "CO2", 2.5, 2), #adjusts the neg CO2 value neatly under bar
                                -0.5)),
              hjust = 0.5,
              size = 3.5,
              label.padding = unit(0.2, "lines"),
              fill = "white",
              colour = "black") +
    # Set plot labels
    labs(title = as.character(yr),
         x = "",
         y = "") +  # Remove y-axis label since we'll have a shared one
    theme_bw() +
    # Add this line to change x-axis labels
    scale_x_discrete(labels = c(expression(bold(CH[4])), expression(bold(CO[2])), expression(bold("Total C")))) +
       # Customize theme elements
    theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.text = element_text(size = 14, face = "bold"), ## This will make all axis text bold
      axis.title = element_text(size = 16, face = "bold"),
      panel.grid.major = element_line(color = "grey90"),
      panel.grid.minor = element_line(color = "grey95")
    ) +
    # Set y-axis limits and breaks
    scale_y_continuous(
      limits = c(-20, 50),
      breaks = seq(-20, 50, by = 10)
    )
})

# Create the grid arrangement with shared y-axis label
adj_grid_arranged <- arrangeGrob(
  grobs = adj_yearly_plots,
  ncol = 2,  # Arrange plots in 2 columns
  # Add shared y-axis label, rotated 90 degrees
  left = textGrob(expression(Net~Carbon~Flux~(gC~m^-2~y^-1)), 
                  rot = 90,
                  gp = gpar(fontsize = 30))
)

# Display the arranged grid
grid.arrange(adj_grid_arranged)

#save
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/adj_yearly_carbon_fluxes.png", adj_grid_arranged, 
       width = 10, height = 15, dpi = 600)


```
#Daily avg NEE flux per season
```{r}
# Calculate daily average CO2 flux (FC_F) by season with standard error
seasonal_NEE_summary <- df_avg %>%
  group_by(year, season) %>%
  summarize(
    mean_flux = mean(FC_F, na.rm = TRUE),
    se_flux = sd(FC_F, na.rm = TRUE)/sqrt(sum(!is.na(FC_F))),
    n_days = n()  # number of days per season
  )

# Format the results with mean ± SE
seasonal_NEE_formatted <- seasonal_NEE_summary %>%
  mutate(
    flux = sprintf("%.2f ± %.2f", mean_flux, se_flux)
  ) %>%
  select(season, flux, n_days)
         
seasonal_NEE_formatted

# Save to Excel
library(writexl)
write_xlsx(seasonal_NEE_formatted, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_NEE_summary.xlsx")
```

```{r}

```














