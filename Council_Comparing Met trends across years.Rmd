---
title: "Council_Comparing Met trends"
output: html_document
date: "2025-01-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
rm(list = ls())

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix)
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(pracma)
library(dplyr)


Sys.setenv(TZ='UTC')
```

# Set working directory and then Load data


```{r}
#changed to "council_gapfilled_clean_2017_2023_for analysis.2.csv" --> .2 indicates updated dataset with SWC_3 tussock; ".3" indicates columns for ERA5.mod-gapfilled air and soil temp  

#half-hourly dataframe --> gapfilled 
df = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


#daily avg dataframe --> gapfilled 
df_avg = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_AVG_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


#with gapfilled soil and air temp columns 

#half-hourly dataframe --> gapfilled 
df2 = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_gapfilled_clean_2017_2023_for analysis.3.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


#daily avg dataframe --> gapfilled 
df_avg2 = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_AVG_gapfilled_clean_2017_2023_for analysis.3.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


# #make sure timestamp is correct and in POSIXct (it should be already)
# summary(df_avg$date)
# 
# #make sure date is in POSIXct --> should return "POSIXct"
# class(df$date)
# class(df_avg$date) #these were in class "date", not POSIXct
# 
# #formatting into POSIXct
# df$date <- as.POSIXct(df$date, format = "%Y-%m-%d", tz = "UTC")
# df_avg$date <- as.POSIXct(df_avg$date, format = "%Y-%m-%d", tz = "UTC")
# 
# 
# df$TIMESTAMP = df$TIMESTAMP_END
# df_avg$TIMESTAMP = df_avg$TIMESTAMP_END


```


#Annual Avg air temp (based on all years, 2017 - 2022, excluding the incomplete 2023*)
```{r}

library(dplyr)
library(lubridate)

annual_temps <- df_avg %>%
  mutate(year = year(date)) %>%      # extract the calendar year
  filter(year >= 2017, year <= 2022) %>%  
  group_by(year) %>%                 
  summarise(
    obs_airtemp    = mean(TA, na.rm = TRUE),  # observed
    obs_airtemp_se   = sd(TA, na.rm = TRUE)/sqrt(sum(!is.na(TA))),   # annual standard deviation
    era5_airtemp   = mean(TA_ERA5,   na.rm = TRUE),   # modeled air temp 
    era5_airtemp_se   = sd(TA_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TA_ERA5))),
    obs_soiltemp = mean(TS_3_1_1, na.rm = TRUE), #observed soil temp at TS3
    obs_soiltemp_se = sd(TS_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(TS_3_1_1))),
    era5_soiltemp = mean(TS_ERA5, na.rm = TRUE), #modeled soil temp 
    era5_soiltemp_se = sd(TS_ERA5, na.rm = TRUE /sqrt(sum(!is.na(TS_ERA5))))
    )
#sd(FC, na.rm = TRUE)/sqrt(sum(!is.na(FC)))
print(annual_temps)


#Make nicer plot with all together 

library(dplyr)
library(knitr)

annual_temps_formatted <- annual_temps %>%
  # 1) Create new character columns combining mean ± sd, rounded to 2 dp
  mutate(
    Obs_TA   = sprintf("%.2f ± %.2f", obs_airtemp, obs_airtemp_se),
    ERA5_TA  = sprintf("%.2f ± %.2f", era5_airtemp, era5_airtemp_se),
    Obs_TS3 = sprintf("%.2f ± %.2f", obs_soiltemp, obs_airtemp_se),
    ERA5_TS  = sprintf("%.2f ± %.2f", era5_soiltemp, era5_soiltemp_se),
  ) %>%
  # 2) Select only the columns you want in the final table
  select(year, Obs_TA, ERA5_TA, Obs_TS3, ERA5_TS)

# 3) Print it neatly with knitr::kable()
annual_temps_formatted %>%
  kable(
    col.names = c("Year", "Obs. Air Temp (°C)", "ERA5 Air Temp (°C)", "Obs. Soil Temp at Tuss (°C)", "ERA5 Soil Temp (°C)" ),
    caption   = "Mean Annual Air & Soil Temperature ± SE (2017–2022)"
  )


#Big differences here in the obs temp and ERA5 temp due to large gaps in data for many years...need to try to gapfill?
```

#Era5.mod-gapfilled Annual Avg air & soil (TS_3) temp (based on all years, 2017 - 2022, excluding the incomplete 2023*)
```{r}
library(dplyr)
library(lubridate)

annual_temps2 <- df_avg2 %>%
  mutate(year = year(date)) %>%      
  filter(year >= 2017, year <= 2022) %>%  
  group_by(year) %>%                 
  summarise(
    TA_gapfilled_avg   = mean(TA_gapfilled, na.rm = TRUE),  
   TA_gapfilled_se   = sd(TA_gapfilled, na.rm = TRUE)/sqrt(sum(!is.na(TA_gapfilled))), 
    TS_3_gapfilled_avg = mean(TS_3_gapfilled, na.rm = TRUE), 
    TS_3_gapfilled_se = sd(TS_3_gapfilled, na.rm = TRUE)/sqrt(sum(!is.na(TS_3_gapfilled)))
    )


#sd(FC, na.rm = TRUE)/sqrt(sum(!is.na(FC)))
print(annual_temps2)


#Make nicer plot with all together 

library(dplyr)
library(knitr)

annual_temps_formatted2 <- annual_temps2 %>%
  # 1) Create new character columns combining mean ± sd, rounded to 2 dp
  mutate(
    TA_GF   = sprintf("%.2f ± %.2f", TA_gapfilled, TA_gapfilled_se),
    TS3_GF  = sprintf("%.2f ± %.2f", TS_3_gapfilled, TS_3_gapfilled_se)
  ) %>%
  # 2) Select only the columns you want in the final table
  select(year, TA_GF, TS3_GF)

# 3) Print it neatly with knitr::kable()
annual_temps_formatted2 %>%
  kable(
    col.names = c("Year", "Gapfilled Air Temp (°C)", "Gapfilled Soil Temp at Tuss (°C)"), 
    caption   = "Gapfilled Mean Annual Air & Soil Temperature ± SE (2017–2022)"
  )




```



# % gapfilled vs observed for TS3 and TA

```{r}
# Calculate percentages for Air Temperature (TA)
#HH - year, season 
TA_summaryHH <- df2 %>%
   filter( year != 2023) %>%
  group_by(year, season) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TA_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TA_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TA_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Air_Temperature")

#daily avg - year, season
TA_summary <- df_avg2 %>%
   filter( year != 2023) %>%
  group_by(year, season) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TA_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TA_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TA_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Air_Temperature")


#HH - year only 
TA_summaryHH_annual <- df2 %>%
   filter( year != 2023) %>%
  group_by(year) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TA_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TA_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TA_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Air_Temperature")

#daily avg - year only
TA_summary_annual <- df_avg2 %>%
   filter( year != 2023) %>%
  group_by(year) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TA_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TA_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TA_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Air_Temperature")


# Calculate percentages for Soil Temperature (TS_3_1_1)

#HH - year, season 
TS_summaryHH <- df2 %>%
  filter( year != 2023) %>%
  group_by(year, season) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TS_3_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TS_3_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TS_3_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Soil_Temperature")


#daily avg - year, season 
TS_summary <- df_avg2 %>%
   filter( year != 2023) %>%
  group_by(year, season ) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TS_3_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TS_3_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TS_3_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Soil_Temperature")

#HH - year only 
TS_summaryHH_annual <- df2 %>%
  filter( year != 2023) %>%
  group_by(year) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TS_3_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TS_3_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TS_3_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Soil_Temperature")


#daily avg - year only 
TS_summary_annual <- df_avg2 %>%
   filter( year != 2023) %>%
  group_by(year, season ) %>%
  summarise(
    total_records = n(),
    observed_count = sum(TS_3_gapfilled_flag == "observed", na.rm = TRUE),
    gapfilled_count = sum(TS_3_gapfilled_flag == "gapfilled", na.rm = TRUE),
    missing_count = sum(is.na(TS_3_gapfilled)),
    observed_percent = round((observed_count / total_records) * 100, 1),
    gapfilled_percent = round((gapfilled_count / total_records) * 100, 1),
    missing_percent = round((missing_count / total_records) * 100, 1)
  ) %>%
  mutate(variable = "Soil_Temperature")

```

#Table: seasonal and annual total C budget & met variable tables 
```{r}
# Load necessary packages
library(dplyr)
library(ggplot2)
library(lubridate)

#Annual and seasonal summaries with SE 

#no SE for CO2 and CH4 fluxes as these are sums **** then we calc averages with SE for the met variables 

# Annual summaries with standard errors
# Annual summaries with total C budget
annual_budgets <- df_avg2 %>%
  group_by(year = year(date)) %>%
  filter(year != 2023) %>% #removing 2023 due to incomplete year data 
  summarize(
    CO2_budget = sum(FC_F * (60*60*24*(1/1000000)*12), na.rm = TRUE),
    CH4_budget = sum(FCH4_F * (60*60*24*(1/1000000000)*12), na.rm = TRUE),
    total_C_budget = CO2_budget + CH4_budget,  # Adding total C budget
    mean_soil_temp = mean(TS_3_1_1, na.rm = TRUE),
    se_soil_temp = sd(TS_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(TS_3_1_1))),
    mean_TS_ERA5 = mean(TS_ERA5, na.rm = TRUE),
    se_TS_ERA5 = sd(TS_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TS_ERA5))),
    mean_soil_moisture = mean(SWC_3_1_1, na.rm = TRUE),
    se_soil_moisture = sd(SWC_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(SWC_3_1_1))),
    mean_TA = mean(TA, na.rm = TRUE),
    se_TA = sd(TA, na.rm = TRUE)/sqrt(sum(!is.na(TA))),
    mean_TA_ERA5 = mean(TA_ERA5, na.rm = TRUE),
    se_TA_ERA5 = sd(TA_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TA_ERA5))),
    mean_TA_gapfilled   = mean(TA_gapfilled, na.rm = TRUE),  
   se_TA_gapfilled   = sd(TA_gapfilled, na.rm = TRUE)/sqrt(sum(!is.na(TA_gapfilled))), 
    mean_TS_3_gapfilled = mean(TS_3_gapfilled, na.rm = TRUE), 
    se_TS_3_gapfilled = sd(TS_3_gapfilled, na.rm = TRUE /sqrt(sum(!is.na(TS_3_gapfilled))))
      )

# Seasonal summaries with total C budget
seasonal_budgets <- df_avg2 %>%
  group_by(year = year(date), season) %>%
  filter(year != 2023) %>% #removing 2023 due to incomplete year data 
  summarize(
    CO2_budget = sum(FC_F * (60*60*24*(1/1000000)*12), na.rm = TRUE),
    CH4_budget = sum(FCH4_F * (60*60*24*(1/1000000000)*12), na.rm = TRUE),
    total_C_budget = CO2_budget + CH4_budget,  # Adding total C budget
    mean_soil_temp = mean(TS_3_1_1, na.rm = TRUE),
    se_soil_temp = sd(TS_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(TS_3_1_1))),
    mean_TS_ERA5 = mean(TS_ERA5, na.rm = TRUE),
    se_TS_ERA5 = sd(TS_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TS_ERA5))),
    mean_soil_moisture = mean(SWC_3_1_1, na.rm = TRUE),
    se_soil_moisture = sd(SWC_3_1_1, na.rm = TRUE)/sqrt(sum(!is.na(SWC_3_1_1))),
    mean_TA = mean(TA, na.rm = TRUE),
    se_TA = sd(TA, na.rm = TRUE)/sqrt(sum(!is.na(TA))),
    mean_TA_ERA5 = mean(TA_ERA5, na.rm = TRUE),
    se_TA_ERA5 = sd(TA_ERA5, na.rm = TRUE)/sqrt(sum(!is.na(TA_ERA5))),
    mean_TA_gapfilled   = mean(TA_gapfilled, na.rm = TRUE),  
    se_TA_gapfilled   = sd(TA_gapfilled, na.rm = TRUE)/sqrt(sum(!is.na(TA_gapfilled))), 
    mean_TS_3_gapfilled = mean(TS_3_gapfilled, na.rm = TRUE), 
    se_TS_3_gapfilled = sd(TS_3_gapfilled, na.rm = TRUE /sqrt(sum(!is.na(TS_3_gapfilled)))),
    days = n()
  )

print(annual_budgets)
print(seasonal_budgets)
```



#Save table of annual and/or seasonal budgets 
```{r}
# Save as a nicely formatted table using kableExtra from knitr package 
# good for a publication or report --> creates HTML table, but not as customize-able as if you were to make it in Excel 

install.packages("kableExtra") 

library(kableExtra)

#Seasonal budgets 

seasonal_budgets %>%
  kable(digits = 2) %>%  # rounds numbers to 2 decimal places
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  save_kable("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_formatted.html")

#Write table to Excel file:
# First install if needed:
install.packages("writexl")

library(writexl)
write_xlsx(seasonal_budgets, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets.xlsx")

#Write table to CSV
# base R, no additional packages needed)
write.csv(seasonal_budgets, "seasonal_budgets.csv", row.names = FALSE)


# Create a new table with combined mean ± SE format
seasonal_budgets_formatted <- seasonal_budgets %>%
  mutate(
    soil_temp = sprintf("%.2f ± %.2f", mean_soil_temp, se_soil_temp),
    soil_moisture = sprintf("%.2f ± %.2f", mean_soil_moisture, se_soil_moisture),
    air_temp = sprintf("%.2f ± %.2f", mean_TA, se_TA),
    TS_ERA5 = sprintf("%.2f ± %.2f", mean_TS_ERA5, se_TS_ERA5),
    TA_ERA5 = sprintf("%.2f ± %.2f", mean_TA_ERA5, se_TA_ERA5),
    TA_GF = sprintf("%.2f ± %.2f", mean_TA_gapfilled, se_TA_gapfilled),
    TS3_GF = sprintf("%.2f ± %.2f", mean_TS_3_gapfilled, se_TS_3_gapfilled),
  ) %>%
  select(year, season, CO2_budget, CH4_budget, total_C_budget, soil_temp, soil_moisture, air_temp, TS_ERA5, TA_ERA5, TA_GF, TS3_GF, days)

# Save to Excel
write_xlsx(seasonal_budgets_formatted, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_formatted3.xlsx")

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#Annual budgets 
# Create a new table with combined mean ± SE format
annual_budgets_formatted <- annual_budgets %>%
  mutate(
    soil_temp = sprintf("%.2f ± %.2f", mean_soil_temp, se_soil_temp),
    soil_moisture = sprintf("%.2f ± %.2f", mean_soil_moisture, se_soil_moisture),
    air_temp = sprintf("%.2f ± %.2f", mean_TA, se_TA),
    TS_ERA5 = sprintf("%.2f ± %.2f", mean_TS_ERA5, se_TS_ERA5),
    TA_ERA5 = sprintf("%.2f ± %.2f", mean_TA_ERA5, se_TA_ERA5),
    TA_GF = sprintf("%.2f ± %.2f", mean_TA_gapfilled, se_TA_gapfilled),
    TS3_GF = sprintf("%.2f ± %.2f", mean_TS_3_gapfilled, se_TS_3_gapfilled),
  ) %>%
  select(year, CO2_budget, CH4_budget, total_C_budget, soil_temp, soil_moisture, air_temp, TS_ERA5, TA_ERA5, TA_GF, TS3_GF)

# Save to Excel
write_xlsx(annual_budgets_formatted, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/annual_budgets_formatted2.xlsx")

```

#Add % gapfilled to seasonal and annual table 

```{r}

# Join the season, year datasets, adding only the gapfilled_percent column
seasonal_budgets_with_gapfill <- seasonal_budgets %>%
  left_join(TA_summaryHH %>% select(year, season, TA_gapfill_percent = gapfilled_percent), 
            by = c("year", "season")) %>%
   left_join(TS_summaryHH %>% select(year, season, TS3_gapfill_percent = gapfilled_percent), 
            by = c("year", "season"))

# Check the result
print(seasonal_budgets_with_gapfill)


# Join the annual datasets, adding only the gapfilled_percent column
annual_budgets_with_gapfill <- seasonal_budgets %>%
  left_join(TA_summaryHH_annual %>% select(year, TA_gapfill_percent = gapfilled_percent), 
            by = c("year")) %>%
   left_join(TS_summaryHH_annual %>% select(year, TS3_gapfill_percent = gapfilled_percent), 
            by = c("year"))

# Check the result
print(annual_budgets_with_gapfill)


# ~~~~~~~~~~~~~Add to formatted tables ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#Annual 
# Join the annual datasets, adding only the gapfilled_percent column
annual_budgets_formatted2 <- annual_budgets_formatted %>%
  left_join(TA_summaryHH_annual %>% select(year, TA_gapfill_percent = gapfilled_percent), 
            by = c("year")) %>%
   left_join(TS_summaryHH_annual %>% select(year, TS3_gapfill_percent = gapfilled_percent), 
             by = c("year"))

# Check the result
print(annual_budgets_formatted2)


#Seasonal 

# Join the seasonal datasets, adding only the gapfilled_percent column
seasonal_budgets_formatted2 <- seasonal_budgets_formatted %>%
  left_join(TA_summaryHH %>% select(year, season, TA_gapfill_percent = gapfilled_percent), 
            by = c("year", "season")) %>%
   left_join(TS_summaryHH %>% select(year, season, TS3_gapfill_percent = gapfilled_percent), 
            by = c("year", "season"))

# Check the result
print(seasonal_budgets_formatted2)


# Save to Excel

#annual 
write_xlsx(annual_budgets_formatted2, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/annual_budgets_formatted2.xlsx")

#seasonal 
write_xlsx(seasonal_budgets_formatted2, "C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/seasonal_budgets_formatted3.xlsx")

```


#plot annual means 
```{r}

#pivot to plot 
annual_temps_long <- annual_temps %>%
  pivot_longer(-year, names_to = "source", values_to = "annual_mean_temp")


library(ggplot2)

ggplot(annual_temps_long, aes(x = year, y = annual_mean_temp, color = source)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = 2017:2022) +
  labs(
    x = "Year",
    y = expression("Mean Annual Temp ("*degree*"C)"),
    color = "Data Source"
  ) +
  theme_minimal()


```


#Yearly summaries of key variables 
```{r}
# Create yearly summaries of key variables
yearly_summary <- df_avg %>%
  mutate(year = format(date, "%Y")) %>%
  group_by(year) %>%
  summarise(
    # Temperature metrics
    mean_ta = mean(TA, na.rm = TRUE), #air temp 
    mean_ts3 = mean(TS_3_1_1, na.rm = TRUE),  # Tussock soil temp
    
      #ERA5 air temp
    mean_ERA.ta = mean(TA_ERA5, na.rm = TRUE), #ERA5 air temp 
    mean_ERA.ts = mean(TS_ERA5, na.rm = TRUE),  # ERA5 soil temp 
    
    # Moisture metrics
    mean_swc3 = mean(SWC_3_1_1, na.rm = TRUE),  # Tussock moisture
    mean_vpd = mean(VPD, na.rm = TRUE),
    mean_rh = mean(RH, na.rm = TRUE),
    
    # Energy metrics
    mean_netrad = mean(NETRAD, na.rm = TRUE),
    mean_le = mean(LE, na.rm = TRUE),
    
    # Sample sizes
    n_total = n(),
    n_fch4 = sum(!is.na(FCH4))
  )

# Create visualization
library(tidyr)

# Reshape data for plotting
yearly_long <- yearly_summary %>%
  select(-n_total, -n_fch4) %>%
  pivot_longer(-year, 
               names_to = "variable", 
               values_to = "value")

# Plot
ggplot(yearly_long, aes(x = year, y = value, group = 1)) +
  geom_line() +
  geom_point() +
  facet_wrap(~variable, scales = "free_y") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Environmental Variables Across Years",
       y = "Value",
       x = "Year")

#Results of total annual avg:
#2019 had lower mean air temp and soil temps at tussock location (TS3)
#very high temps in 2023 compared to others, but this is likely driven by missing half the year ** 
#can see the come down from the heat spike in 2017 
#in measure TA you don't see the air temp spike in 2019, which is likely due to having the most complete winter data, which evens out the mean? **need to look at seasons ** 
#VPD also appears to substantially increase over the years - conversely, RH is decreasing over the years 
#netrad increases over the years, as well

#**but these are annual averages which don't capture a lot of the nuance, going to break it down into seasons and compare seasons among years
```


#Create yearly dataframes 
```{r}
#create dataframes for each year for the data you have so you can look at annual trends --> the previous way I did them doesn't work here for some reason, so using filtering 

#Daily avg

df_avg_2017 <- df_avg %>%
  filter(year(date) == 2017)

df_avg_2018 <- df_avg %>%
  filter(year(date) == 2018)

df_avg_2019 <- df_avg %>%
  filter(year(date) == 2019)

df_avg_2020 <- df_avg %>%
  filter(year(date) == 2020)

df_avg_2021 <- df_avg %>%
  filter(year(date) == 2021)

df_avg_2022 <- df_avg %>%
  filter(year(date) == 2022)

df_avg_2023 <- df_avg %>%
  filter(year(date) == 2023)

# HH 

df_2017 <- df %>%
  filter(year(date) == 2017)

df_2018 <- df %>%
  filter(year(date) == 2018)

df_2019 <- df %>%
  filter(year(date) == 2019)

df_2020 <- df %>%
  filter(year(date) == 2020)

df_2021 <- df %>%
  filter(year(date) == 2021)

df_2022 <- df %>%
  filter(year(date) == 2022)

df_2023 <- df %>%
  filter(year(date) == 2023)


```

#Seasonal dataframes 
```{r}
#Across all years
#This will exclude 2023 because it does not have assigned seasons 

#Daily avg 
df_avg_winter <- df_avg %>%
  filter(season == "Winter")

df_avg_growing <- df_avg %>%
  filter(season == "Growing Season")

df_avg_fall <- df_avg %>%
  filter(season == "Fall Senescence")


#HH data 
df_winter <- df %>%
  filter(season == "Winter")

df_growing <- df %>%
  filter(season == "Growing Season")

df_fall <- df %>%
  filter(season == "Fall Senescence")




#Within each year 

#** TO DO

#Daily avg



sum(is.na(df_avg_fall$season))
```







#Creating timeseries for each year, with seasonal delineations 
```{r}
#Below code sets it up as a function so all you have to do it change the years at the bottom, and re-run, and it'll adjust the figure with associated seasonal delineations 

library(ggplot2)
library(dplyr)
library(lubridate)

# Create seasonal boundaries dataframe
season_boundaries <- data.frame(
  year = rep(2017:2022, each = 3),  # now each year has 3 dates
  DOY = c(
    # 2017
    131, 258, 291,  # Growing season start, Fall start, Winter start
    # 2018
    152, 257, 301,  # Growing season start, Fall start, Winter start
    # 2019
    145, 246, 285,  # Growing season start, Fall start, Winter start
    # 2020
    136, 252, 300,  # Growing season start, Fall start, Winter start
    # 2021
    142, 260, 284,  # Growing season start, Fall start, Winter start
    # 2022
    144, 245, 282   # Growing season start, Fall start, Winter start
  )
)

# Function to create seasonal flux plots
create_seasonal_plot <- function(df_avg, year_to_plot) {
  # Filter data for specified year
  yearly_data <- df_avg %>%
    filter(year(date) == year_to_plot)
  
  # Get the seasonal boundaries for this year and calculate mid-points for labels
  year_boundaries <- season_boundaries %>%
    filter(year == year_to_plot) %>%
    mutate(date = as.Date(paste(year, DOY), format="%Y %j"))

  # Calculate midpoints for season labels
  year_start <- as.Date(paste0(year_to_plot, "-01-01"))
  year_end <- as.Date(paste0(year_to_plot, "-12-31"))
  
  label_dates <- data.frame(
    season = c("Winter", "Growing Season", "Fall Senescence", "Winter"),
    date = c(
      year_start + (year_boundaries$date[1] - year_start)/2,  # Winter to Growing
      year_boundaries$date[1] + (year_boundaries$date[2] - year_boundaries$date[1])/2,  # Growing to Fall
      year_boundaries$date[2] + (year_boundaries$date[3] - year_boundaries$date[2])/2,  # Fall to Winter
      year_boundaries$date[3] + (year_end - year_boundaries$date[3])/2  # End of year Winter
    )
  )
  
  # Create plot a (Temperature and NEE)
  p1 <- ggplot(yearly_data) +
    # Add air temperature with scaling
    geom_line(aes(x = date, y = TA/15, color = "Air Temperature"), size = 0.5) +
    # Add soil temperature with same scaling - TS3 = tussock location 
    geom_line(aes(x = date, y = TS_2_1_1/15, color = "Soil Temperature"), size = 0.5) + 
    #Add air temp ERA5 
    geom_line(aes(x = date, y = TA_ERA5/15, colour = "ERA5 Air Temperature"), linetype = "dashed")+
    # Add NEE points
    geom_point(aes(x = date, y = FC_F * 60 * 60 * 24 * (1/1000000) * 12, color = "NEE"), alpha = 0.6, size = 1) +
       #add dark line at y=0
    geom_hline(yintercept=0, col="black")+
    # Create secondary y-axis for temperature with correct scaling
    scale_y_continuous(
      name = expression(NEE~(gC~m^-2~d^-1)),
      limits = c(-4, 3),
      sec.axis = sec_axis(~ . * 15, name = expression("Temperature ("*degree*"C)"))
    ) +
    # Add season divisions using geom_vline with year-specific dates
    geom_vline(data = year_boundaries,
               aes(xintercept = date),
               linetype = "solid", color = "black") +
    # Customize colors
    scale_color_manual(
      values = c("Air Temperature" = "salmon", 
                "Soil Temperature" = "navy",
                "ERA5 Air Temperature" = "darkgreen",
                "NEE" = "turquoise"),
      name = ""
    ) +
    # Add season labels
    geom_text(data = label_dates,
              aes(x = date, y = -3.8, label = season),
              size = 3, angle = 0) +
    theme_bw() +
    theme(
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      axis.title.y.right = element_text(color = "black"),
      axis.text.y.right = element_text(color = "black")
    ) +
    labs(x = "Date", title = paste("Seasonal Trends:", year_to_plot))
  
  # Create plot b (GPP, RECO, NEE, and CH4)
  p2 <- ggplot(yearly_data) +
    # Add GPP points (negative for uptake)
    geom_point(aes(x = date, y = -GPP_F * 60 * 60 * 24 * (1/1000000) * 12, color = "GPP"), alpha = 0.6, size = 1) +
    # Add RECO points
    geom_point(aes(x = date, y = RECO_F * 60 * 60 * 24 * (1/1000000) * 12, color = "Respiration"), alpha = 0.6, size = 1) +
    # Add NEE line
    geom_line(aes(x = date, y = FC_F * 60 * 60 * 24 * (1/1000000) * 12, color = "NEE"), size = 0.5) +
    # Add CH4 line (scaled for visibility)
    geom_line(aes(x = date, y = FCH4_F * 60 * 60 * 24 * (1/1000000000) * 12 * 33, color = "CH4"), size = 0.5) +
    #add dark line at y=0
    geom_hline(yintercept=0, col="black")+
    # Create secondary y-axis for CH4
    scale_y_continuous(
      name = expression(Flux~(gC~m^-2~d^-1)),
      limits = c(-5, 3),
      sec.axis = sec_axis(~ . / 33, name = expression('CH'[4]*' Flux (g C'~m^-2~d^-1*')'))
    ) +
    # Add season divisions using geom_vline with year-specific dates
    geom_vline(data = year_boundaries,
               aes(xintercept = date),
               linetype = "solid", color = "black") +
    # Customize colors
    scale_color_manual(
      values = c("GPP" = "navy",
                "Respiration" = "turquoise",
                "NEE" = "coral",
                "CH4" = "purple"),
      name = ""
    ) +
    # Add season labels
    geom_text(data = label_dates,
              aes(x = date, y = -5, label = season),
              size = 3, angle = 0) +
    theme_bw() +
    theme(
      legend.position = "bottom",
      panel.grid.minor = element_blank(),
      axis.title.y.right = element_text(color = "black"),
      axis.text.y.right = element_text(color = "black")
    ) +
     labs(x = "Date", title = paste("Seasonal Trends:", year_to_plot))
  
  return(list(temp_nee = p1, fluxes = p2))
}

# Usage example:
plots_2020 <- create_seasonal_plot(df_avg, 2020)
plots_2020$temp_nee  # Display temperature and NEE plot
plots_2020$fluxes    # Display GPP, RECO, NEE, and CH4 plot




```


#Comparison plots 

####Trying to map the different met data trends by season, for each year
####trouble getting continuous winter figure due to it occuring at first and end of year 


```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)

create_seasonal_comparison <- function(df_avg, season_name) {
  # Filter data for the specified season and handle winter wrap-around
  seasonal_data <- df_avg %>%
    filter(season == season_name) %>%
    mutate(
      doy = case_when(
        season == "Winter" & month(date) <= 6 ~ yday(date),
        season == "Winter" & month(date) >= 7 ~ yday(date) - 365,
        TRUE ~ yday(date)
      )
    )
  
  # Create a long format dataset for the variables we want to compare
  long_data <- seasonal_data %>%
    select(date, year, doy, TA, TA_ERA5, TS_3_1_1, SWC_3_1_1) %>%
    pivot_longer(
      cols = c(TA, TA_ERA5, TS_3_1_1, SWC_3_1_1),
      names_to = "variable",
      values_to = "value"
    ) %>%
    mutate(
      variable = factor(variable, 
                       levels = c("TA", "TA_ERA5", "TS_3_1_1", "SWC_3_1_1"),
                       labels = c("Air Temperature (°C)", "ERA5 Air Temperature (°C)", 
                                "Soil Temperature (Tussock) (°C)", "Soil Moisture (Tussock) (%SWC)"))
    )
  
  # Get unique months that appear in this season's data
  if(season_name == "Winter") {
    # For winter, explicitly set the months we want to show
    month_doys <- c(-31, -15, 0, 31, 59)  # Mid-Nov through mid-Mar
    month_labels <- c("Nov", "Dec", "Jan", "Feb", "Mar")
  } else {
    # For other seasons, use the actual months in the data
    unique_months <- unique(month(seasonal_data$date))
    month_dates <- as.Date(paste0("2019-", unique_months, "-15"))
    month_doys <- yday(month_dates)
    month_labels <- format(month_dates, "%b")
  }
  
  # Create the plot
  p <- ggplot(long_data, aes(x = doy, y = value)) +
    geom_line(aes(color = as.factor(year))) +
    facet_wrap(~variable, scales = "free_y", ncol = 1) +
    scale_color_brewer(palette = "Dark2", name = "Year") +
    scale_x_continuous(
      breaks = month_doys,
      labels = month_labels,
      limits = range(long_data$doy)
    ) +
    labs(
      title = paste(season_name, "Conditions"),
      x = "Month",
      y = NULL
    ) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 10, face = "bold"),
      legend.position = "right",
      panel.grid.minor = element_blank()
    )
  
  return(p)
}

# Create plots for each season
winter_plot <- create_seasonal_comparison(df_avg, "Winter")
growing_plot <- create_seasonal_comparison(df_avg, "Growing Season")
fall_plot <- create_seasonal_comparison(df_avg, "Fall Senescence")

# Display plots
winter_plot
growing_plot
fall_plot
```
```{r}
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)

create_seasonal_comparison <- function(df_avg, season_name) {
  # Filter data for the specified season and handle winter wrap-around
  seasonal_data <- df_avg %>%
    filter(season == season_name) %>%
    mutate(
      doy = case_when(
        season == "Winter" & month(date) <= 6 ~ yday(date),
        season == "Winter" & month(date) >= 7 ~ yday(date) - 365,
        TRUE ~ yday(date)
      )
    )
  
  # Create a long format dataset for the variables we want to compare
  long_data <- seasonal_data %>%
    select(date, year, doy, TA, TA_ERA5, TS_3_1_1, SWC_3_1_1) %>%
    pivot_longer(
      cols = c(TA, TA_ERA5, TS_3_1_1, SWC_3_1_1),
      names_to = "variable",
      values_to = "value"
    ) %>%
    mutate(
      variable = factor(variable, 
                       levels = c("TA", "TA_ERA5", "TS_3_1_1", "SWC_3_1_1"),
                       labels = c("Air Temperature (°C)", "ERA5 Air Temperature (°C)", 
                                "Soil Temperature (Tussock) (°C)", "Soil Moisture (Tussock) (%SWC)"))
    )
  
  # Get unique months that appear in this season's data
  if(season_name == "Winter") {
    # For winter, explicitly set the months we want to show
    month_doys <- c(-31, -15, 0, 31, 59)  # Mid-Nov through mid-Mar
    month_labels <- c("Nov", "Dec", "Jan", "Feb", "Mar")
  } else {
    # For other seasons, use the actual months in the data
    unique_months <- unique(month(seasonal_data$date))
    month_dates <- as.Date(paste0("2019-", unique_months, "-15"))
    month_doys <- yday(month_dates)
    month_labels <- format(month_dates, "%b")
  }
  
  # Create the plot
  p <- ggplot(long_data, aes(x = doy, y = value)) +
    geom_line(aes(color = as.factor(year))) +
    facet_wrap(~variable, scales = "free_y", ncol = 1) +
    scale_color_brewer(palette = "Dark2", name = "Year") +
    scale_x_continuous(
      breaks = month_doys,
      labels = month_labels,
      limits = range(long_data$doy)
    ) +
    labs(
      title = paste(season_name, "Conditions"),
      x = "Month",
      y = NULL
    ) +
    theme_bw() +
    theme(
      strip.background = element_rect(fill = "white"),
      strip.text = element_text(size = 10, face = "bold"),
      legend.position = "right",
      panel.grid.minor = element_blank()
    )
  
  return(p)
}

# Create plots for each season
winter_plot <- create_seasonal_comparison(df_avg, "Winter")
growing_plot <- create_seasonal_comparison(df_avg, "Growing Season")
fall_plot <- create_seasonal_comparison(df_avg, "Fall Senescence")

# Display plots
winter_plot
growing_plot
fall_plot

#**need to find a way to double check the months included in each season for each year 
```
#Create seasonal subsets from df_avg
```{r}
create_seasonal_subsets <- function(year_data, year_num) {
  # Create seasonal datasets
  winter <- year_data %>%
    filter(season == "Winter")
  
  growing <- year_data %>%
    filter(season == "Growing Season")
  
  fall <- year_data %>%
    filter(season == "Fall Senescence")
  
  # Print summary information
  cat(paste("\nSeasonal Summary for", year_num, ":\n"))
  cat("------------------------\n")
  
  cat("Winter dates:\n")
  print(range(winter$date))
  cat(paste("Number of winter days:", nrow(winter), "\n\n"))
  
  cat("Growing Season dates:\n")
  print(range(growing$date))
  cat(paste("Number of growing days:", nrow(growing), "\n\n"))
  
  cat("Fall Senescence dates:\n")
  print(range(fall$date))
  cat(paste("Number of fall days:", nrow(fall), "\n\n"))
  
  # Return the datasets as a list
  return(list(
    winter = winter,
    growing = growing,
    fall = fall
  ))
}

# print results 
seasons_2017 <- create_seasonal_subsets(df_avg_2017, 2017)

# Access individual seasonal datasets if needed:
winter_2017 <- seasons_2017$winter
growing_2017 <- seasons_2017$growing
fall_2017 <- seasons_2017$fall

# Can easily do for other years:
seasons_2018 <- create_seasonal_subsets(df_avg_2018, 2018)
seasons_2019 <- create_seasonal_subsets(df_avg_2019, 2019)
seasons_2020 <- create_seasonal_subsets(df_avg_2020, 2020)
seasons_2021 <- create_seasonal_subsets(df_avg_2021, 2021)
seasons_2022 <- create_seasonal_subsets(df_avg_2019, 2022)
```
#Met data per season
```{r}
create_seasonal_subsets <- function(year_data, year_num) {
  # Create seasonal datasets
  winter <- year_data %>%
    filter(season == "Winter")
  
  growing <- year_data %>%
    filter(season == "Growing Season")
  
  fall <- year_data %>%
    filter(season == "Fall Senescence")
  
  # Function to calculate seasonal statistics
  get_season_stats <- function(data) {
    list(
      # Measured Air Temperature statistics
      mean_air_temp = mean(data$TA, na.rm = TRUE),
      max_air_temp = max(data$TA, na.rm = TRUE),
      min_air_temp = min(data$TA, na.rm = TRUE),
      
      # ERA5 Air Temperature statistics
      mean_era5_temp = mean(data$TA_ERA5, na.rm = TRUE),
      max_era5_temp = max(data$TA_ERA5, na.rm = TRUE),
      min_era5_temp = min(data$TA_ERA5, na.rm = TRUE),
      
      # Soil conditions
      mean_soil_temp = mean(data$TS_3_1_1, na.rm = TRUE),
      max_soil_temp = max(data$TS_3_1_1, na.rm = TRUE),
      min_soil_temp = min(data$TS_3_1_1, na.rm = TRUE),
      
      mean_soil_moisture = mean(data$SWC_3_1_1, na.rm = TRUE),
      max_soil_moisture = max(data$SWC_3_1_1, na.rm = TRUE),
      min_soil_moisture = min(data$SWC_3_1_1, na.rm = TRUE),
      
      # Carbon fluxes
      mean_NEE = mean(data$FC_F, na.rm = TRUE),
      mean_CH4 = mean(data$FCH4_F, na.rm = TRUE),
      cumulative_NEE = sum(data$FC_F, na.rm = TRUE),
      cumulative_CH4 = sum(data$FCH4_F, na.rm = TRUE)
    )
  }
  
  # Calculate statistics for each season
  winter_stats <- get_season_stats(winter)
  growing_stats <- get_season_stats(growing)
  fall_stats <- get_season_stats(fall)
  
  # Print summary information
  cat(paste("\nSeasonal Summary for", year_num, ":\n"))
  cat("================================================\n")
  
  for(season_name in c("Winter", "Growing Season", "Fall Senescence")) {
    season_data <- switch(season_name,
                         "Winter" = winter,
                         "Growing Season" = growing,
                         "Fall Senescence" = fall)
    stats <- switch(season_name,
                   "Winter" = winter_stats,
                   "Growing Season" = growing_stats,
                   "Fall Senescence" = fall_stats)
    
    cat(paste("\n", season_name, ":\n"))
    cat("----------------\n")
    cat("Dates:", format(range(season_data$date), "%Y-%m-%d"), "\n")
    cat("Number of days:", nrow(season_data), "\n")
    cat("\nTemperature Conditions:\n")
    cat(sprintf("Measured Air Temperature: %.1f°C (range: %.1f to %.1f°C)\n", 
                stats$mean_air_temp, stats$min_air_temp, stats$max_air_temp))
    cat(sprintf("ERA5 Air Temperature: %.1f°C (range: %.1f to %.1f°C)\n", 
                stats$mean_era5_temp, stats$min_era5_temp, stats$max_era5_temp))
    cat(sprintf("Soil Temperature: %.1f°C (range: %.1f to %.1f°C)\n", 
                stats$mean_soil_temp, stats$min_soil_temp, stats$max_soil_temp))
    
    cat("\nSoil Moisture:\n")
    cat(sprintf("Mean: %.1f %%SWC (range: %.1f to %.1f %%SWC)\n", 
                stats$mean_soil_moisture, stats$min_soil_moisture, stats$max_soil_moisture))
    
    cat("\nCarbon Fluxes:\n")
    cat("\nCarbon Fluxes:\n")
    cat(sprintf("Mean NEE: %.2f µmol/m²/s\n", stats$mean_NEE))
    cat(sprintf("Mean CH4: %.3f nmol/m²/s\n", stats$mean_CH4))
    cat(sprintf("Cumulative NEE: %.1f µmol/m²\n", stats$cumulative_NEE))
    cat(sprintf("Cumulative CH4: %.2f nmol/m²\n", stats$cumulative_CH4))
    cat("\n")
  }
  
  # Return the datasets as a list
  return(list(
    winter = winter,
    growing = growing,
    fall = fall,
    stats = list(
      winter = winter_stats,
      growing = growing_stats,
      fall = fall_stats
    )
  ))
}

# print results 
seasons_2019 <- create_seasonal_subsets(df_avg_2019, 2019)

# Access individual seasonal datasets if needed:
winter_2019 <- seasons_2019$winter
growing_2019 <- seasons_2019$growing
fall_2019 <- seasons_2019$fall

# Easily print results for other years:
seasons_2018 <- create_seasonal_subsets(df_avg_2018, 2018)
seasons_2019 <- create_seasonal_subsets(df_avg_2019, 2019)
seasons_2020 <- create_seasonal_subsets(df_avg_2020, 2020)
seasons_2021 <- create_seasonal_subsets(df_avg_2021, 2021)
seasons_2022 <- create_seasonal_subsets(df_avg_2019, 2022)
```


