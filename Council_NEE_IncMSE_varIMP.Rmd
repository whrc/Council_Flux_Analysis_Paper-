---
title: "Council_IncMSE_NEE" #script for exploring deconstructed incMSE models for correlated variables 
#Note: optimal OOB determined in BASE data prepping proj, script 1.5 "Optimizing RF ntree OOB"

#Settled on using model 7 as final reduced model 

output: html_document
date: "2025-09-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
rm(list = ls())

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix)
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(pracma)
library(dplyr)
library(car) 
library(randomForest)

Sys.setenv(TZ='UTC')
```


#ERA dataset 
####Prepping the era dataset to use to train RF too -- calc vpd and RF for SWC gapfilling, just like in the processing steps 
```{r}
#ERA-5 dataset for RF training - just like in step 2 of the processing code -- uses the same dataset used in the beginning of step 2 
df_era = fread("C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_2016_2023_era.csv") #using the re-cleaned df from Dani 

#subset out by which has complete air t data 
df_era = df_era[complete.cases(df_era$airt.eramod),]

#create subset of the variables wanted for training RF 
df_era2 = data.frame(df_era$date,df_era$FC.c,df_era$FCH4.c,
                 df_era$airt.eramod, df_era$wd, df_era$cardinal_direction, df_era$rh.eramod,df_era$rad.eramod,
                 df_era$ws.eramod,df_era$tsoil.eramod,#df_era$SWC_1_1_1.c,df_era$SWC_2_1_1.c, 
                 df_era$SWC_3_1_1.c, #SWC 3 = the tussock location 
                 df_era$h.eramod,df_era$le.eramod)

#rename for easier names
names(df_era2) = c('date','nee',"fch4",'tair', 'wd', 'cardDir','rh','rg','ws','tsoil','swc','h','le')

#make card dir as factor - 8 levels 
df_era2$cardDir <- as.factor(df_era2$cardDir)

#calculate VPD from air t and RH
svp = 610.7*10^((7.5*df_era2$tair)/(237.3+df_era2$tair))
df_era2$vpd = ((100 - df_era2$rh)/100)*svp  
```


#RF for SWC - Train RF to fill in SWC (using SWC3, tussocklocation*)
```{r}

#Subset dataset into training and testing dataset 

set.seed(123)#sets the start point of models, good for repeatability
cc = df_era2[complete.cases(df_era2$swc),]#create a gap free data set of the target variable

#use 80% of data set as training set and 20% as test set
sample = sample(c(TRUE, FALSE), nrow(cc), replace=TRUE, prob=c(0.8,0.2))
train  = cc[sample, ]
test   = cc[!sample, ]
#compare to ensure all data sets are representative of total data
hist(cc$swc)
hist(train$swc)
hist(test$swc)

#run random forest to predict missing SWC values 
library(randomForest)

rf.swc = randomForest(formula = swc ~ tair + rh + rg + ws + wd + tsoil + vpd + le + h,data = train,ntree = 800) #optimum ntree determined by OOB error (script in Council Base data prepping, #1.5)

#predict it on the full data set
swc.rf = predict(object = rf.swc,newdata = df_era2)
df_era2$swc.rf = swc.rf 

#time series plot of gap filled vs real
ggplot(data = df_era2)+
  geom_point(aes(date,swc.rf*100,col='RF'))+
  geom_point(aes(date,swc*100,col='Measured'))+
  scale_y_continuous("SWC (%)")


#validation dataset from only test data
val = merge(test,df_era2,by = "date",all.x = T)

ggplot(data = val,aes(swc.rf,swc.x))+theme_bw()+geom_abline(slope = 1,intercept = 0,col='red')+
  geom_point(alpha=0.1)+
  scale_x_continuous(limits = c(0,70),"RF SWC (%)")+
  scale_y_continuous(limits = c(0,70),"Measured SWC (%)")


#summary stats on gap filling
summary(lm(val$swc.x ~ val$swc.rf)) #R2 = 0.98, slope = 1.02

#Fig for council paper supp material 
SWC_RF <- ggplot(data = val,aes(swc.rf,swc.x))+theme_bw()+geom_abline(slope = 1,intercept = 0,col='red')+
  geom_point(alpha=0.1)+
  scale_x_continuous(limits = c(0,70),"RF SWC (%)")+
  scale_y_continuous(limits = c(0,70),"Measured SWC (%)")+
    annotate(geom = 'text',x = 10, y = 70,label=expression(R^2~"= 0.98"),size = 5)+
  annotate(geom = 'text',x = 10,y = 65,label=expression(Slope~"= 1.02"), size = 5)
SWC_RF

# ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/SWC_RF_Validation.png", SWC_RF, 
#        width = 10, height = 7, dpi = 600)

#create final gap free soil moisture
df_era2$swc = ifelse(is.na(df_era2$swc),df_era2$swc.rf,df_era2$swc)

```

#SWC-soil temp interaction term 
```{r}
# Create interaction term --> explicit interaction term while keeping original terms 
df_era2$TS_SWC_interact <- df_era2$tsoil * df_era2$swc
```

#Checking collinearity among continuous predictor variables - gives an idea of how to approach iterative model reduction of correlated / collinear vars - use spearman corr as these variables tend to be nonparametric 

```{r}
library(corrplot)
library(car)
library(dplyr)

# CORRELATION MATRIX - Visual inspection
# Predictor variables
predictors <- df_era2 %>%
  select(tair, rh, rg, ws, wd, tsoil, vpd, swc, h, le, TS_SWC_interact) %>%
  na.omit()  # Remove rows with any missing values

# Calculate correlation matrix using complete observations 
cor_matrix <- cor(predictors, use = "complete.obs", method = "spearman")
print("Spearman Correlation Matrix:")
print(round(cor_matrix, 3))

# Visualize correlation matrix
corrplot(cor_matrix, method = "color", type = "upper", 
         order = "hclust", tl.cex = 0.8, tl.col = "black",
         addCoef.col = "black", number.cex = 0.7)
title("Collinearity Check: Spearman Correlation Matrix")

# Identify highly correlated pairs (|r| > 0.7) - code from claude
high_cor_pairs <- which(abs(cor_matrix) > 0.7 & abs(cor_matrix) < 1, arr.ind = TRUE)
if(nrow(high_cor_pairs) > 0) {
  print("Variable pairs with |correlation| > 0.7:")
  for(i in 1:nrow(high_cor_pairs)) {
    var1 <- rownames(cor_matrix)[high_cor_pairs[i,1]]
    var2 <- colnames(cor_matrix)[high_cor_pairs[i,2]]
    cor_val <- cor_matrix[high_cor_pairs[i,1], high_cor_pairs[i,2]]
    cat(paste(var1, "vs", var2, ": r =", round(cor_val, 3), "\n"))
  }
} else {
  print("No variable pairs with |correlation| > 0.7 found")
}
#Results: most of them have collinearity / correlation 
# strongest correlations: 
#swc - tsoil, TS interact, tair, vpd, le 
#tsoil - swc, TS interact, tair, vpd, le
#TS interact - tair, vpd, le 
#tair - vpd, le, rg, h
#vpd - le, rg, h, rh
#wd - ok
#le - rg, h, rh
#rg - h, rh
#h - rh
#ws - ok 
```


# VarImp for NEE

#Running with complete cases of ALL variables used in the model, and using the whole df_era2 dataset 

#complete cases of all predictor variables being used and complete cases of obs fch4 (not gapfilled)


```{r}
#Complete cases of nee, constrain to remove some spread 
cc_nee = df_era2[complete.cases(df_era2$nee),]
cc = subset(cc_nee,cc_nee$nee < 12 & cc_nee$nee > -14) #removes some outliers / spread


#subset out cc
cc_all = cc[complete.cases(cc$tair, cc$wd, cc$cardDir, cc$rh, cc$rg, cc$ws, cc$tsoil, cc$swc, cc$h, cc$le, cc$vpd),]

sum(is.na(cc_all$tair))
```

#SWC-soil temp interaction term 
```{r}
# Create interaction term --> explicit interaction term while keeping original terms 
cc_all$TS_SWC_interact <- cc_all$tsoil * cc_all$swc
```

#Boruta variable importance
```{r}
#added wd (degrees)
library(Boruta)

boruta = Boruta(nee ~ tair + rh + rg + ws + wd + tsoil + swc + vpd + le + h + TS_SWC_interact, data = cc_all ,doTrace = 2,maxRuns = 100)
boruta$finalDecision #indicates all above are confirmed important variables via a list 
plot(boruta,las = 2) 

#using carDir instead of wd 
boruta2 = Boruta(nee ~ tair + rh + rg + ws + cardDir + tsoil + swc + vpd + le + h + TS_SWC_interact, data = cc_all ,doTrace = 2,maxRuns = 100)
boruta2$finalDecision #indicates all above are confirmed important variables via a list 
plot(boruta2,las = 2) 
```

# VarImp for NEE

#Now we start removing / swapping out variables that appear to be collinear (see VIF, corr matrix). My approach is to remove the variables with the highest VIF after each model run


##### Full model with all variables & interaction term, cc of ALL variables 
```{r}

rf.nee_full.cc <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + 
                             vpd + swc + h + le + TS_SWC_interact ,
                             data = cc_all,
                             ntree = 950,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + vpd + swc + h + le + TS_SWC_interact, data = cc_all)

vif(vif_model) 
#            tair              rh              rg              ws              wd 
#       10.876306        4.230133       14.025554        1.241197        1.056193 
#           tsoil             vpd             swc               h              le 
#       33.772879       13.803904        1.842530        6.544763        6.066360 
# TS_SWC_interact 
#       22.582830 

# Extract variable importance
importance_values <- importance(rf.nee_full.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_full.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                   %IncMSE
# tair             44.04506
# rh               87.83592
# rg               50.09184
# ws              106.12816
# wd              141.06816
# tsoil            61.94372
# vpd              50.11790
# swc             127.16900
# h                82.96411
# le               62.92248
# TS_SWC_interact  61.33962

```



#reduced model 1: removing soil temp - soil moisture interaction first since it was a newly introduced variable 
```{r}

rf.nee_1.cc <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + 
                             vpd + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + vpd + swc + h + le, data = cc_all)

 vif(vif_model)
#       tair        rh        rg        ws        wd     tsoil       vpd       swc         h 
# 10.096192  4.111179 13.961169  1.216213  1.050961  7.784100 13.641347  1.820802  6.512390 
#        le 
#  6.064610 

# Extract variable importance
importance_values <- importance(rf.nee_1.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_1.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   43.47467
# rh     90.13754
# rg     45.32025
# ws    112.47298 *
# wd    131.55486 *
# tsoil  76.82326
# vpd    46.70014
# swc   140.57965 *
# h      86.72934
# le     62.10891
```
#removing variable with highest VIF from previous model 

#reduced model 2: removing soil moist-temp interaction & vpd
```{r}

rf.nee_2.cc <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + swc + h + le, data = cc_all)

 vif(vif_model) 
 #     tair        rh        rg        ws        wd     tsoil       swc         h        le 
 # 7.465335  1.971089 13.902665  1.145542  1.047940  6.796080  1.672813  6.420426  5.481915 

# Extract variable importance
importance_values <- importance(rf.nee_2.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_2.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   44.05508
# rh     98.98468
# rg     48.72340
# ws    107.87091
# wd    146.52951
# tsoil  90.45768
# swc   142.86412
# h      83.62852
# le     64.32201
```


#reduced model 3: removing soil moist-temp interaction, vpd, & rg
```{r}

rf.nee_3.cc <- randomForest(nee ~ tair + rh + ws + wd + tsoil + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + tsoil + swc + h + le, data = cc_all)

 vif(vif_model) 
#     tair       rh       ws       wd    tsoil      swc        h       le 
# 5.598571 1.736815 1.122798 1.047448 5.394029 1.550447 2.812292 3.861786 

# Extract variable importance
importance_values <- importance(rf.nee_3.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_3.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   56.54131
# rh     91.57067
# ws    118.09106
# wd    123.46611 *
# tsoil 107.01640
# swc   147.59590 *
# h     131.88021 *
# le     83.55430
```


#reduced model 4: removing soil moist-temp interaction, rg, vpd, tsoil   
```{r}

rf.nee_4.cc <- randomForest(nee ~ tair + rh + ws + wd + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + swc + h + le, data = cc_all)

 vif(vif_model) 
#     tair       rh       ws       wd      swc        h       le 
# 2.135656 1.736737 1.109567 1.030415 1.366761 2.801496 3.861341 

# Extract variable importance
importance_values <- importance(rf.nee_4.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_4.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tair 142.61403 *
# rh    98.42112
# ws   119.32521
# wd   130.03058 *
# swc  186.98190 *
# h    120.00928
# le   100.43484

```



#reduced model 5: removing soil moist-temp interaction, rg, vpd, *Swapping out tair and adding tsoil back in   
```{r}

rf.nee_5.cc <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + rh + ws + wd + swc + h + le, data = cc_all)

 vif(vif_model) 
#    tsoil       rh       ws       wd      swc        h       le 
# 2.057631 1.716666 1.121311 1.040650 1.549643 2.789477 3.606361 

# Extract variable importance
importance_values <- importance(rf.nee_5.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_5.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tsoil 155.24056
# rh     95.72478
# ws    117.09667
# wd    126.92049
# swc   160.64890
# h     129.41520
# le     95.42372

#tsoil has higher incMSE compared to tair when the other is excluded 
#for both models, le has the highest VIF so removing that next 

```

#reduced model 6: removing soil moist-temp interaction, rg, *tsoil, and le    
```{r}

rf.nee_6.cc <- randomForest(nee ~ tair + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
#     tair       rh       ws       wd      swc        h 
# 1.740603 1.490105 1.062742 1.029830 1.364663 1.809669 

# Extract variable importance
importance_values <- importance(rf.nee_6.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_6.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#       %IncMSE
# tair 187.8308 *
# rh   100.1157
# ws   173.3438
# wd   141.8155
# swc  203.8333 *
# h    349.2868 *


```


#reduced model 7: removing soil moist-temp interaction, vpd, rg, *tair, and le  (swapping tair and tsoil)  
#**Final model used for AMF council paper **
```{r}

rf.nee_7.cc <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
#    tsoil       rh       ws       wd      swc        h 
# 1.795580 1.489901 1.075118 1.038305 1.548411 1.640588 

# Extract variable importance
importance_values <- importance(rf.nee_7.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_7.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tsoil 220.5808
# rh    113.1165
# ws    181.1576
# wd    147.6526
# swc   171.3750
# h     390.4434


```


#reduced model 8: removing VPD, rg, tsoil, tair, and le -- *adding in soil temp-moist interaction
```{r}

rf.nee_8.cc <- randomForest(nee ~ TS_SWC_interact + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ TS_SWC_interact + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
# TS_SWC_interact              rh              ws              wd             swc 
#        1.718074        1.492343        1.062468        1.034981        1.539371 
#               h 
#        1.601840 

# Extract variable importance
importance_values <- importance(rf.nee_8.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_8.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                  %IncMSE
# TS_SWC_interact 189.7590 *
# rh              110.9547
# ws              176.0384 *
# wd              143.0567
# swc             163.0466
# h               386.0758 *


#Notes: 
#*tsoil has higher incMSE compared to interaction term; tair inMSE also slightly higher 
#*
#*#but I think this clouds the individual tsoil and swc, so this is exploratory, will not use interaction in final model for AMF Council paper 

```


#VIF all ok, but h & rh are collinear per the spearman corr matrix, so removing and swapping to see how this changes model 


#reduced model 9: removing interaction, VPD, rg, tair, le, rh 
```{r}

rf.nee_9.cc <- randomForest(nee ~ tsoil + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
#    tsoil       ws       wd      swc        h 
# 1.794709 1.033993 1.023132 1.526802 1.189518 

# Extract variable importance
importance_values <- importance(rf.nee_9.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_9.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tsoil 159.0848
# ws    137.1224
# wd    140.6637
# swc   128.9154
# h     392.7124

```




#reduced model 10: removing VPD, rg, tair, le, swapping out *h and rh 
```{r}

rf.nee_10.cc <- randomForest(nee ~ tsoil + ws + wd + swc + rh,
                             data = cc_all,
                             ntree = 950,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + ws + wd + swc + rh, data = cc_all)

 vif(vif_model) 
#    tsoil       ws       wd      swc       rh 
# 1.588209 1.066930 1.027984 1.531257 1.080262 

# Extract variable importance
importance_values <- importance(rf.nee_10.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_10.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tsoil 221.9706 *
# ws    190.8474
# wd    206.5656 *
# swc   177.0324
# rh    358.0844 *

```

#reduced model 11: removing VPD, rg, tsoil, tair, le, and swc  -- *adding in soil temp-moist interaction
```{r}

rf.nee_11.cc <- randomForest(nee ~ TS_SWC_interact + rh + ws + wd  + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ TS_SWC_interact + rh + ws + wd + h, data = cc_all)

 vif(vif_model) 
# TS_SWC_interact              rh              ws              wd               h 
#        1.153439        1.475979        1.054825        1.034965        1.590600 

# Extract variable importance
importance_values <- importance(rf.nee_11.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_11.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                  %IncMSE
# TS_SWC_interact 248.1488
# rh              109.3577
# ws              155.5509
# wd              143.1434
# h               270.6367


#Notes: 
#*tsoil has higher incMSE compared to interaction term; tair inMSE also slightly higher 

```




#Testing which model may be better, comparing the reduced models using tair and tsoil 
#### *anova doesn't work on randomforest products, so tried on simple lm 
#### AIC/BIC also don't work for RF models, so tried on simple lm 

```{r}

#using OOB and RMSE to compare the reduced models 6 and 7 which swaps tsoil and tair 

oob_mse_6 <- tail(rf.nee_6.cc$mse, 1)
oob_r2_6  <- tail(rf.nee_6.cc$rsq, 1)

oob_mse_7 <- tail(rf.nee_7.cc$mse, 1)
oob_r2_7  <- tail(rf.nee_7.cc$rsq, 1)

data.frame(model = c("airT", "soilT"),
           OOB_MSE = c(oob_mse_6, oob_mse_7),
           OOB_R2  = c(oob_r2_6,  oob_r2_7))

# # model      OOB MSE               OOB R2
# airT	     2.230882	              0.6394340		
# soilT	     2.180746	              0.6475372	

#tsoil has slightly lower error, and slightly higher R2, indicates it may be the better model 


#looking at model 8 with interaction term 
oob_mse_8 <- tail(rf.nee_8.cc$mse, 1)
oob_r2_8  <- tail(rf.nee_8.cc$rsq, 1)

data.frame(model = c("airT", "soilT", "interaction"),
           OOB_MSE = c(oob_mse_6, oob_mse_7, oob_mse_8),
           OOB_R2  = c(oob_r2_6,  oob_r2_7, oob_r2_8))

#interaction has slightly better performance, very close to tsoil 

# # model      OOB MSE               OOB R2
# airT      	2.235797	           0.6386396		
# soilT	      2.173410	           0.6487229		
# interaction	2.167859	           0.6496200	

#looking at models 9 - 11 
oob_mse_9 <- tail(rf.nee_9.cc$mse, 1)
oob_r2_9  <- tail(rf.nee_9.cc$rsq, 1)

oob_mse_10 <- tail(rf.nee_10.cc$mse, 1)
oob_r2_10  <- tail(rf.nee_10.cc$rsq, 1)

oob_mse_11 <- tail(rf.nee_11.cc$mse, 1)
oob_r2_11  <- tail(rf.nee_11.cc$rsq, 1)

data.frame(model = c("airT", "soilT", "interaction", "w/o h", "w/o rh", "interact w/o swc"),
           OOB_MSE = c(oob_mse_6, oob_mse_7, oob_mse_8, oob_mse_9, oob_mse_10, oob_mse_11),
           OOB_R2  = c(oob_r2_6,  oob_r2_7, oob_r2_8, oob_r2_9, oob_r2_10, oob_r2_11))

# model         OOB MSE           OOB R2
# airT	      2.230882	          0.6394340		
# soilT	      2.180746	          0.6475372		
# interaction	2.170268	          0.6492307	*	
# w/o h	      2.195002	          0.6452331		
# w/o rh	    2.644647          	0.5725593	

#interact w/o swc	2.319346	0.6251359	

#model with interaction best, followed by tsoil model 
```


#comparing lm models of reduced RF models 
```{r}
#lm to allow anova comparison 
lm_rf.nee_6<- lm(nee ~ tair + rh + ws + wd + swc + h, data = cc_all)
lm_rf.nee_7 <- lm(nee ~ tsoil + rh + ws + wd + swc + h, data = cc_all)

#anova(lm_rf.nee_7,lm_rf.nee_6 ) #doesn't generate a p value
AIC(lm_rf.nee_7,lm_rf.nee_6) #AIC for 6 = 144611.8, AIC for 7 = 144584.1 so 7 has slightly lower AIC
BIC(lm_rf.nee_7,lm_rf.nee_6) #BIC for 6 = 144679.4, BIC for 7 = 144651.7 so 7 has slightly lower BIC


vif(lm_rf.nee_6) # all <2 - ok
vif(lm_rf.nee_7) # < 2 - ok

#Vuong test can test two different, non-nested models with different parameters - but not sure this is appropriate as the models don't adhere to lm assumptions.... 
library(nonnest2)

# Vuong test for non-nested model comparison
vuong_test <- vuongtest(lm_rf.nee_6, lm_rf.nee_7)
print("Vuong Test Results:")
print(vuong_test)

#shows models do perform sig diff from one another, and that model 2, the one with tsoil, performs better than the model with tair 

#testing models 8 - 11 

lm_rf.nee_8 <- lm(nee ~ TS_SWC_interact + rh + ws + wd + swc + h, data = cc_all)
lm_rf.nee_9 <- lm(nee ~ TS_SWC_interact + ws + wd + swc + h, data = cc_all)
lm_rf.nee_10 <- lm(nee ~ TS_SWC_interact + rh + ws + wd + swc, data = cc_all)
lm_rf.nee_11 <- lm(nee ~ TS_SWC_interact + rh + ws + wd + h, data = cc_all)

vif(lm_rf.nee_8) #<2
vif(lm_rf.nee_9) #<2
vif(lm_rf.nee_10) #<2
vif(lm_rf.nee_11) #<2

anova(lm_rf.nee_7,lm_rf.nee_9) #doesn't generate a p value
anova(lm_rf.nee_7,lm_rf.nee_10) #sig diff between models 

AIC(lm_rf.nee_7,lm_rf.nee_6, lm_rf.nee_8, lm_rf.nee_9, lm_rf.nee_10, lm_rf.nee_11) 
BIC(lm_rf.nee_7,lm_rf.nee_6, lm_rf.nee_8, lm_rf.nee_9, lm_rf.nee_10, lm_rf.nee_11)

#lowest AIC/BIC model 10 


vuong_test <- vuongtest(lm_rf.nee_9, lm_rf.nee_10)
print("Vuong Test Results:")
print(vuong_test)

```
#reduced model 12: exploratory, removing soil moist-temp interaction, vpd, rg, and le  (adding in tair and tsoil)  
```{r}

rf.nee_12.cc <- randomForest(nee ~ TS_SWC_interact + tsoil + tair + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ TS_SWC_interact + tsoil + tair + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
# TS_SWC_interact           tsoil            tair              rh              ws 
#       22.087384       31.024689        5.536154        1.502867        1.092717 
#              wd             swc               h 
#        1.052812        1.555325        1.818357 

# Extract variable importance
importance_values <- importance(rf.nee_12.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_12.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                  %IncMSE
# TS_SWC_interact  77.05848
# tsoil            75.34498
# tair             70.08995
# rh               87.39395
# ws              139.16913
# wd              126.53742
# swc             133.67022
# h               248.27055


```


# ***************************************

#Re-running with just site-measured data only 
```{r}

df = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_gapfilled_clean_2017_2023_for analysis.3.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

df_cc = df[complete.cases(df$FC, df$TA, df$WD, df$WD_Cardinal, df$RH, df$SW_IN, df$WS, df$TS_3_1_1, df$SWC_3_1_1, df$H, df$LE, df$VPD, df$G_1_1_1),]

sum(is.na(df_cc$SW_IN))

#SWC-soil temp interaction term 

# Create interaction term --> explicit interaction term while keeping original terms 
df_cc$TS_SWC_interact <- df_cc$TS_3_1_1 * df_cc$SWC_3_1_1

```


#Boruta variable importance
```{r}

library(Boruta)

boruta = Boruta(FC ~ TA + RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1 + TS_SWC_interact, data = df_cc, doTrace = 2,maxRuns = 100)
boruta$finalDecision #indicates all above are confirmed important variables via a list 
plot(boruta,las = 2) 

```



##### Full model with all variables & interaction term 
```{r}
library(randomForest)

site.nee_full.cc <- randomForest(FC ~ TA + RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1 + TS_SWC_interact,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~ TA + RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1 + TS_SWC_interact, data = df_cc)
# 
 vif(vif_model) 
      #   TA              RH           SW_IN              WS              WD 
      # 12.878279        3.635034        6.179417        1.231184        1.134066 
      #  TS_3_1_1       SWC_3_1_1             VPD              LE               H 
      # 32.789734        2.044560        9.336989        4.329498        5.868555 
      #   G_1_1_1 TS_SWC_interact 
      #  5.004937       23.051551 
 
 
# Extract variable importance
importance_values <- importance(site.nee_full.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_full.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                 %IncMSE
# TA              36.90495
# RH              73.40355
# SW_IN           43.82108
# WS              67.93020
# WD              55.87808
# TS_3_1_1        42.66102
# SWC_3_1_1       79.21003
# VPD             43.79284
# LE              44.78493
# H               93.76022
# G_1_1_1         58.05021
# TS_SWC_interact 34.99044


```




##### reduced site model 1 - removing TS-SWC interact
```{r}
#TS_3 had highest VIF, but want to see what it is when interaction is removed first 

site.nee_1.cc <- randomForest(FC ~ TA + RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~ TA + RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1, data = df_cc)
# 
 vif(vif_model) 
#       TA        RH     SW_IN        WS        WD  TS_3_1_1 SWC_3_1_1       VPD        LE 
# 12.736759  3.577458  6.139650  1.229386  1.127361  8.210856  1.761249  9.335307  4.233116 
#         H   G_1_1_1 
#  5.632546  4.932024 

# Extract variable importance
importance_values <- importance(site.nee_1.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_1.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#             %IncMSE
# TA         44.58526
# RH         80.91754
# SW_IN      44.68218
# WS         67.24901
# WD         54.63567
# TS_3_1_1   55.71407
# SWC_3_1_1 100.21239
# VPD        43.00630
# LE         47.87899
# H          95.05690
# G_1_1_1    53.92212

```

##### reduced site model 2 - removing TS-SWC interact, TA 
```{r}

site.nee_2.cc <- randomForest(FC ~ RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + VPD + LE + H + G_1_1_1, data = df_cc)
# 
 vif(vif_model) 
 # RH     SW_IN        WS        WD  TS_3_1_1 SWC_3_1_1       VPD        LE         H 
 # 3.137800  5.840385  1.229386  1.108140  5.854800  1.643164  7.649409  4.229193  5.383255 
 #  G_1_1_1 
 # 4.167477 

# Extract variable importance
importance_values <- importance(site.nee_2.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_2.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#             %IncMSE
# RH         74.25941
# SW_IN      41.72186
# WS         71.51393
# WD         59.09287
# TS_3_1_1   72.61439
# SWC_3_1_1 100.57794
# VPD        45.17363
# LE         47.27929
# H          83.46191
# G_1_1_1    60.68640

```


##### reduced site model 3 - removing TS-SWC interact, TA, VPD
```{r}

site.nee_3.cc <- randomForest(FC ~ RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + LE + H + G_1_1_1,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + SW_IN + WS + WD + TS_3_1_1 + SWC_3_1_1 + LE + H + G_1_1_1, data = df_cc)
# 
 vif(vif_model) 
 #  RH     SW_IN        WS        WD  TS_3_1_1 SWC_3_1_1        LE         H   G_1_1_1 
 # 1.183011  5.554493  1.224268  1.106890  4.118946  1.622857  4.213928  5.048610  3.426896 

# Extract variable importance
importance_values <- importance(site.nee_3.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_3.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#             %IncMSE
# RH        101.92605
# SW_IN      43.26408
# WS         67.13157
# WD         58.12550
# TS_3_1_1   70.11697
# SWC_3_1_1 109.04488
# LE         44.72757
# H          87.72577
# G_1_1_1    62.15405


```

##### reduced site model 4 - removing TS-SWC interact, TA, VPD, SW_IN
```{r}

site.nee_4.cc <- randomForest(FC ~ RH + WS + WD + TS_3_1_1 + SWC_3_1_1 + LE + H + G_1_1_1,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + WS + WD + TS_3_1_1 + SWC_3_1_1 + LE + H + G_1_1_1, data = df_cc)
# 
 vif(vif_model) 
 #       RH        WS        WD  TS_3_1_1 SWC_3_1_1        LE         H   G_1_1_1 
 # 1.175148  1.221004  1.106890  4.118266  1.488948  3.625513  3.070386  3.425934 

# Extract variable importance
importance_values <- importance(site.nee_4.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_4.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")



```
##### reduced site model 5 - removing TS-SWC interact, TA, VPD, NETRAD, G
```{r}
#TS_3 is highest, but going to remove G first since it's likely collinear with that and TS is more important than G 

site.nee_5.cc <- randomForest(FC ~ RH + WS + WD + TS_3_1_1 + SWC_3_1_1 + LE + H,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + WS + WD + TS_3_1_1 + SWC_3_1_1 + LE + H , data = df_cc)
# 
 vif(vif_model) 
 #       RH        WS        WD  TS_3_1_1 SWC_3_1_1        LE         H 
 # 1.174410  1.208499  1.106622  2.313800  1.335953  3.605268  2.976155 

# Extract variable importance
importance_values <- importance(site.nee_5.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_5.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")


#             %IncMSE
# RH        122.73374
# WS         83.23936
# WD         69.43337
# TS_3_1_1  102.72641
# SWC_3_1_1 119.41172
# LE         51.24301
# H         151.65335

```
##### reduced site model 6 - removing TS-SWC interact, TA, VPD, NETRAD, swapping out G for TS_3
```{r}
#TS_3 has highest VIF, but going to remove G first since it's likely collinear with that and TS is more important than G --> now swapping G for TS_3 to see how the models compare 

site.nee_6.cc <- randomForest(FC ~ RH + WS + WD + G_1_1_1 + SWC_3_1_1 + LE + H,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + WS + WD + G_1_1_1 + SWC_3_1_1 + LE + H , data = df_cc)
# 
 vif(vif_model) 
 #       RH        WS        WD   G_1_1_1 SWC_3_1_1        LE         H 
 # 1.143595  1.213776  1.087944  1.924822  1.142018  3.440685  3.069713 

# Extract variable importance
importance_values <- importance(site.nee_6.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_6.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#             %IncMSE
# RH        112.48551
# WS         87.39789
# WD         62.73399
# G_1_1_1    85.72770
# SWC_3_1_1 150.12893
# LE         60.47228
# H         152.22809


#TS_3 still has higher VIF so seems removing it and keeping G is better choice 

```


##### reduced site model 7 - removing TS-SWC interact, TA, VPD, NETRAD, TS_3, LE
```{r}

site.nee_7.cc <- randomForest(FC ~ RH + WS + WD + G_1_1_1 + SWC_3_1_1 + H,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + WS + WD + G_1_1_1  + SWC_3_1_1 + H , data = df_cc)
# 
 vif(vif_model) 
 #       RH        WS        WD   G_1_1_1 SWC_3_1_1         H 
 # 1.135161  1.075422  1.063509  1.743391  1.079040  1.783052 

# Extract variable importance
importance_values <- importance(site.nee_7.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_7.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#            %IncMSE
# RH        138.15333
# WS        112.36072
# WD         74.31461
# G_1_1_1   108.59882
# SWC_3_1_1 180.89799
# H         391.26671

```
##### reduced site model 8 - removing TS-SWC interact, TA, VPD, NETRAD, LE, swapping G & TS_3
```{r}

site.nee_8.cc <- randomForest(FC ~ RH + WS + WD + TS_3_1_1 + SWC_3_1_1 + H,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + WS + WD + TS_3_1_1  + SWC_3_1_1 + H , data = df_cc)
# 
 vif(vif_model) 
 #       RH        WS        WD  TS_3_1_1 SWC_3_1_1         H 
 # 1.156992  1.068443  1.091549  2.000034  1.329149  1.709968 

# Extract variable importance
importance_values <- importance(site.nee_8.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_8.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#             %IncMSE
# RH        134.01296
# WS        117.77302
# WD         73.13618
# TS_3_1_1  133.75025
# SWC_3_1_1 143.20605
# H         357.38775


#TS_3 VIF =2, slightly higher than G, indicates maybe G is better choice 


```
#Comparing models 7 (using G) and 8 (using TS_3)
```{r}
# Compare OOB error (lower is better)
site.nee_8.cc$mse[length(site.nee_8.cc$mse)]  #  1.609279 --> with TS_3, slightly lower * 
site.nee_7.cc$mse[length(site.nee_7.cc$mse)]  # 1.655677 --> with G 

# Rsq (higher is better)
site.nee_8.cc$rsq[length(site.nee_8.cc$rsq)] # 0.74853 -- slightly higher
site.nee_7.cc$rsq[length(site.nee_7.cc$rsq)] # 0.7412798

# Compare directly
cat("Model 8 (soil temp) OOB MSE:", site.nee_8.cc$mse[500], "\n")
cat("Model 7 (ground heat flux) OOB MSE:", site.nee_7.cc$mse[500], "\n")
cat("Model 8 (soil temp) R²:", site.nee_8.cc$rsq[500], "\n")
cat("Model 7 (ground heat flux) R²:", site.nee_7.cc$rsq[500], "\n")

#indicates that using soil temp may be only marginally better, but it should have been taken out in the stepwise models due to highest VIF in model 4 so going to go with the model with G 
```
#Final site model figure 


##### reduced site model 7 - removing TS-SWC interact, TA, VPD, NETRAD, TS_3, LE
```{r}

site.nee_7.cc_final <- randomForest(FC ~ RH + WS + WD + G_1_1_1 + SWC_3_1_1 + H,
                             data = df_cc,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(FC ~  RH + WS + WD + G_1_1_1  + SWC_3_1_1 + H , data = df_cc)

 vif(vif_model) 
 #     RH        WS        WD   G_1_1_1 SWC_3_1_1         H 
 # 1.135161  1.075422  1.063509  1.743391  1.079040  1.783052 

# Extract variable importance
importance_values <- importance(site.nee_7.cc_final, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(site.nee_7.cc_final, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#             %IncMSE
# RH        124.10086
# WS        117.33983
# WD         77.52539
# G_1_1_1   104.46828
# SWC_3_1_1 179.15371
# H         380.73183

```




#Figure for final model 

```{r}
# 1. Extract importance table 
imp <- importance(site.nee_7.cc_final, type = 1)
imp_df <- data.frame(
  Variable = rownames(imp),
  IncMSE = imp[, 1]
)

#Rename some variables
imp_df$Variable <- dplyr::recode(
  imp_df$Variable,
  SWC_3_1_1 = "SWC",
  G_1_1_1 = "G"
)

#plot
NEE_incMSE <- ggplot(imp_df, aes(x = reorder(Variable, IncMSE), y = IncMSE)) +
 geom_point(size = 5, pch = 1, stroke = 1.5) + #stroke changes thickness of circle shape 
  coord_flip() +
  labs(
    x = "",
    y = "%IncMSE",
    title = "NEE: Variable Importance"
  ) +
  scale_y_continuous(limits = c(50, 400),  # Adjust these limits as needed
      breaks = seq(50, 400, by = 50))+
  theme_bw() +
 theme(
   axis.text = element_text(color = "black", size = 12, face = "bold"),
   axis.title = element_text(color = "black", size = 14, face = "bold"),
   plot.title = element_text(color = "black", size = 16, face = "bold", hjust = 0.5),
    panel.grid.major.x = element_blank(), #removes vertical grid lines 
     panel.grid.minor = element_blank(), #removes minor gridlines
    panel.grid.major.y = element_line(linewidth = 0.8, linetype = "dotted", color = "darkgrey")
 ) 
 
  
 NEE_incMSE 


```


#Save 
```{r}
# #Save CH4 seasonal budgets 
ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/NEE_incMSE_siteData.png",NEE_incMSE,
       width = 7, height = 4, dpi = 600)

```
