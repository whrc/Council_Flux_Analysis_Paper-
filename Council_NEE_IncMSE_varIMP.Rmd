---
title: "Council_IncMSE_NEE" #script for exploring deconstructed incMSE models for correlated variables 
#Note: optimal OOB determined in BASE data prepping proj, script 1.5 "Optimizing RF ntree OOB"
#Note**: scroll to bottom to see incMSE with full dataset (not train vs test) using cc of all variables being used**
output: html_document
date: "2025-09-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
rm(list = ls())

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix)
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(pracma)
library(dplyr)
library(car) 

Sys.setenv(TZ='UTC')
```


#ERA dataset 
####Prepping the era dataset to use to train RF too -- calc vpd and RF for SWC gapfilling, just like in the processing steps 
```{r}
#ERA-5 dataset for RF training - just like in step 2 of the processing code -- uses the same dataset used in the beginning of step 2 
df_era = fread("C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_2016_2023_era.csv") #using the re-cleaned df from Dani 

#subset out by which has complete air t data 
df_era = df_era[complete.cases(df_era$airt.eramod),]

#create subset of the variables wanted for training RF 
df_era2 = data.frame(df_era$date,df_era$FC.c,df_era$FCH4.c,
                 df_era$airt.eramod, df_era$wd, df_era$cardinal_direction, df_era$rh.eramod,df_era$rad.eramod,
                 df_era$ws.eramod,df_era$tsoil.eramod,#df_era$SWC_1_1_1.c,df_era$SWC_2_1_1.c, 
                 df_era$SWC_3_1_1.c, #SWC 3 = the tussock location 
                 df_era$h.eramod,df_era$le.eramod)

#rename for easier names
names(df_era2) = c('date','nee',"fch4",'tair', 'wd', 'cardDir','rh','rg','ws','tsoil','swc','h','le')

#make card dir as factor - 8 levels 
df_era2$cardDir <- as.factor(df_era2$cardDir)

#calculate VPD from air t and RH
svp = 610.7*10^((7.5*df_era2$tair)/(237.3+df_era2$tair))
df_era2$vpd = ((100 - df_era2$rh)/100)*svp  
```


#RF for SWC - Train RF to fill in SWC (using SWC3, tussocklocation*)
```{r}

#Subset dataset into training and testing dataset 

set.seed(123)#sets the start point of models, good for repeatability
cc = df_era2[complete.cases(df_era2$swc),]#create a gap free data set of the target variable

#use 80% of data set as training set and 20% as test set
sample = sample(c(TRUE, FALSE), nrow(cc), replace=TRUE, prob=c(0.8,0.2))
train  = cc[sample, ]
test   = cc[!sample, ]
#compare to ensure all data sets are representative of total data
hist(cc$swc)
hist(train$swc)
hist(test$swc)

#run random forest to predict missing SWC values 
library(randomForest)

rf.swc = randomForest(formula = swc ~ tair + rh + rg + ws + wd + tsoil + vpd + le + h,data = train,ntree = 800) #optimum ntree determined by OOB error (script in Council Base data prepping, #1.5)

#predict it on the full data set
swc.rf = predict(object = rf.swc,newdata = df_era2)
df_era2$swc.rf = swc.rf 

#time series plot of gap filled vs real
ggplot(data = df_era2)+
  geom_point(aes(date,swc.rf*100,col='RF'))+
  geom_point(aes(date,swc*100,col='Measured'))+
  scale_y_continuous("SWC (%)")


#validation dataset from only test data
val = merge(test,df_era2,by = "date",all.x = T)

ggplot(data = val,aes(swc.rf,swc.x))+theme_bw()+geom_abline(slope = 1,intercept = 0,col='red')+
  geom_point(alpha=0.1)+
  scale_x_continuous(limits = c(0,70),"RF SWC (%)")+
  scale_y_continuous(limits = c(0,70),"Measured SWC (%)")


#summary stats on gap filling
summary(lm(val$swc.x ~ val$swc.rf)) #R2 = 0.98, slope = 1.02

#Fig for council paper supp material 
SWC_RF <- ggplot(data = val,aes(swc.rf,swc.x))+theme_bw()+geom_abline(slope = 1,intercept = 0,col='red')+
  geom_point(alpha=0.1)+
  scale_x_continuous(limits = c(0,70),"RF SWC (%)")+
  scale_y_continuous(limits = c(0,70),"Measured SWC (%)")+
    annotate(geom = 'text',x = 10, y = 70,label=expression(R^2~"= 0.98"),size = 5)+
  annotate(geom = 'text',x = 10,y = 65,label=expression(Slope~"= 1.02"), size = 5)
SWC_RF

# ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/SWC_RF_Validation.png", SWC_RF, 
#        width = 10, height = 7, dpi = 600)

#create final gap free soil moisture
df_era2$swc = ifelse(is.na(df_era2$swc),df_era2$swc.rf,df_era2$swc)

```

#SWC-soil temp interaction term 
```{r}
# Create interaction term --> explicit interaction term while keeping original terms 
df_era2$TS_SWC_interact <- df_era2$tsoil * df_era2$swc
```


# VarImp for NEE

#testing for correlated variables 
#Non-parametric tests of correlations - spearman's correlation 

##### Full model with all variables & interaction term 
```{r}
#interaction term in ERA5 dataset, for reference: TS_SWC_interact

#Create training and testing datasets 
cc_nee = df_era2[complete.cases(df_era2$nee),]
cc = subset(cc,cc$nee < 12 & cc$nee > -14) #removing some spread 

#create training dataset - 80% to train, 20% to test
sample.nee = sample(c(TRUE, FALSE), nrow(cc_nee), replace=TRUE, prob=c(0.8,0.2))
train.nee  = cc_nee[sample.nee, ]
test.nee   = cc_nee[!sample.nee, ]


rf.nee_full <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + 
                             vpd + swc + h + le + TS_SWC_interact ,
                             data = train.nee,
                             ntree = 950,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + vpd + swc + h + le + TS_SWC_interact, data = df_era2)

vif(vif_model) 
      #      tair              rh              rg              ws              wd           tsoil 
      # 10.876716        4.230284       14.027880        1.241240        1.056183       33.772944 
      #       vpd             swc               h              le TS_SWC_interact 
      # 13.803276        1.842613        6.545965        6.066574       22.582958 

# Extract variable importance
importance_values <- importance(rf.nee_full, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_full, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                   %IncMSE
# tair             43.83793
# rh               83.60214
# rg               50.46131
# ws               92.66371 *
# wd              113.24795 *
# tsoil            52.33887
# vpd              44.72077
# swc             117.01935 * 
# h                81.75600
# le               62.76682
# TS_SWC_interact  48.44485

```
#full model but using the categorical CarDir instead of wd (degrees)
```{r}
rf.nee_full2 <- randomForest(nee ~ tair + rh + rg + ws + cardDir + tsoil + 
                             vpd + swc + h + le + TS_SWC_interact ,
                             data = train.nee,
                             ntree = 950,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + cardDir + tsoil + vpd + swc + h + le + TS_SWC_interact, data = df_era2)

vif(vif_model) 
#                      GVIF Df GVIF^(1/(2*Df))
# tair            11.115906  1        3.334052
# rh               4.349437  1        2.085530
# rg              14.265122  1        3.776920
# ws               1.326549  1        1.151759
# cardDir          1.554770  7        1.032026
# tsoil           34.096096  1        5.839186
# vpd             13.877429  1        3.725242
# swc              1.913614  1        1.383334
# h                6.921858  1        2.630942
# le               6.156193  1        2.481168
# TS_SWC_interact 22.802175  1        4.775162

# Extract variable importance
importance_values <- importance(rf.nee_full2, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_full2, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                   %IncMSE
# tair             39.62552
# rh               83.62718
# rg               50.22527
# ws               90.84175 *
# cardDir         120.99655 *
# tsoil            53.93861
# vpd              43.29743
# swc             114.13806 *
# h                77.15994
# le               59.64057
# TS_SWC_interact  48.14305

```


#Boruta variable importance
```{r}
#added wd (degrees)
library(Boruta)

boruta = Boruta(nee ~ tair + rh + rg + ws + wd + tsoil + swc + vpd + le + h + TS_SWC_interact, data = train.nee ,doTrace = 2,maxRuns = 100)
boruta$finalDecision #indicates all above are confirmed important variables via a list 
plot(boruta,las = 2) 

#using carDir instead of wd 
boruta2 = Boruta(nee ~ tair + rh + rg + ws + cardDir + tsoil + swc + vpd + le + h + TS_SWC_interact, data = train.nee ,doTrace = 2,maxRuns = 100)
boruta2$finalDecision #indicates all above are confirmed important variables via a list 
plot(boruta2,las = 2) 
```


#Checking collinearity among continuous predictor variables 
```{r}
library(corrplot)
library(car)
library(dplyr)
# CORRELATION MATRIX - Visual inspection
# Predictor variables
predictors <- df_era2 %>%
  select(tair, rh, rg, ws, wd, tsoil, vpd, swc, h, le, TS_SWC_interact) %>%
  na.omit()  # Remove rows with any missing values

# Calculate correlation matrix
cor_matrix <- cor(predictors, use = "complete.obs")
print("Correlation Matrix:")
print(round(cor_matrix, 3))

# Visualize correlation matrix
corrplot(cor_matrix, method = "color", type = "upper", 
         order = "hclust", tl.cex = 0.8, tl.col = "black",
         addCoef.col = "black", number.cex = 0.7)
title("Collinearity Check: Correlation Matrix")

# Identify highly correlated pairs (|r| > 0.7) - code from claude
high_cor_pairs <- which(abs(cor_matrix) > 0.7 & abs(cor_matrix) < 1, arr.ind = TRUE)
if(nrow(high_cor_pairs) > 0) {
  print("Variable pairs with |correlation| > 0.7:")
  for(i in 1:nrow(high_cor_pairs)) {
    var1 <- rownames(cor_matrix)[high_cor_pairs[i,1]]
    var2 <- colnames(cor_matrix)[high_cor_pairs[i,2]]
    cor_val <- cor_matrix[high_cor_pairs[i,1], high_cor_pairs[i,2]]
    cat(paste(var1, "vs", var2, ": r =", round(cor_val, 3), "\n"))
  }
} else {
  print("No variable pairs with |correlation| > 0.7 found")
}
#Results: most of them have collinearity / correlation 
# strongest correlations: 
#swc - tsoil, TS interact, tair, vpd
#tsoil - TS interact, tair, vpd, le
#TS interact - tair, vpd, le 
#tair - vpd, le, rg, h
#vpd - le, rg, h, rh
#wd - ok
#le - rg, h, rh
#rg - h, rh
#h - rh
#ws - ok 
```


#Now we start removing / swapping out variables that appear to be collinear (see VIF, corr matrix). My approach is to remove the variables with the highest VIF after each model run


#reduced model 1: removing soil temp - soil moisture interaction 
```{r}

rf.nee_1 <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + 
                             vpd + swc + h + le,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + vpd + swc + h + le, data = df_era2)

 vif(vif_model)
#      tair        rh        rg        ws        wd     tsoil       vpd       swc         h        le 
# 10.096590  4.111273 13.963473  1.216231  1.050951  7.784172 13.640742  1.820875  6.513567  6.064830 

# Extract variable importance
importance_values <- importance(rf.nee_1, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_1, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   40.75993
# rh     80.72256
# rg     46.56342
# ws     94.67850 *
# wd    115.11853 *
# tsoil  73.70873
# vpd    41.20033
# swc   119.08408 *
# h      73.92875
# le     61.35482
```
#Reducing the model by removing the variable with the highest VIF from previous model run 

#reduced model 2: removing soil moist-temp interaction & rg 
```{r}

rf.nee_2 <- randomForest(nee ~ tair + rh + vpd + ws + wd + tsoil + swc + h + le,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + vpd + ws + wd + tsoil + swc + h + le, data = df_era2)

 vif(vif_model) 
 #    tair        rh       vpd        ws        wd     tsoil       swc         h        le 
 # 8.512882  3.960500 13.583562  1.198464  1.050291  6.231644  1.715788  2.844975  4.574293 

# Extract variable importance
importance_values <- importance(rf.nee_2, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_2, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   39.40103
# rh     83.33405
# vpd    43.06318
# ws     99.84045
# wd    121.36225 *
# tsoil  77.76151
# swc   137.31217 *
# h     126.56098 *
# le     85.68831
```

#reduced model 3: removing soil moist-temp interaction, rg, & vpd  
```{r}

rf.nee_3 <- randomForest(nee ~ tair + rh + ws + wd + tsoil + swc + h + le,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + tsoil + swc + h + le, data = df_era2)

 vif(vif_model) 
#     tair       rh       ws       wd    tsoil      swc        h       le 
# 5.598534 1.736650 1.122805 1.047441 5.394139 1.550527 2.812684 3.861942 

# Extract variable importance
importance_values <- importance(rf.nee_3, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_3, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   53.41029
# rh     85.05921
# ws    103.74377
# wd    109.41255 *
# tsoil 101.23579
# swc   134.00447 *
# h     118.52890 *
# le     86.67041
```


#reduced model 4: removing soil moist-temp interaction, rg, vpd, tsoil   
```{r}

rf.nee_4 <- randomForest(nee ~ tair + rh + ws + wd + swc + h + le,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + swc + h + le, data = df_era2)

 vif(vif_model) 
#     tair       rh       ws       wd      swc        h       le 
# 2.135658 1.736571 1.109577 1.030410 1.366824 2.801886 3.861494 

# Extract variable importance
importance_values <- importance(rf.nee_4, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_4, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tair 140.96502 *
# rh    97.27419
# ws   112.57898
# wd   109.35117
# swc  158.35607 *
# h    120.91545 *
# le    98.25168
```

#reduced model 5: removing soil moist-temp interaction, rg, vpd, *Swapping out tair and adding tsoil back in   
```{r}

rf.nee_5 <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h + le,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + rh + ws + wd + swc + h + le, data = df_era2)

 vif(vif_model) 
#    tsoil       rh       ws       wd      swc        h       le 
# 2.057688 1.716520 1.121317 1.040646 1.549723 2.789873 3.606582 

# Extract variable importance
importance_values <- importance(rf.nee_5, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_5, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tsoil 151.03479 *
# rh     89.97427
# ws    103.01713
# wd    119.76066
# swc   146.04809 *
# h     120.44287 *
# le     92.34000

#tsoil has higher incMSE compared to tair when the other is excluded 
#for both versions, le has the highest VIF so removing that next 
```



#reduced model 6: removing soil moist-temp interaction, rg, *tsoil, and le    
```{r}

rf.nee_6 <- randomForest(nee ~ tair + rh + ws + wd + swc + h,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + swc + h, data = df_era2)

 vif(vif_model) 
#     tair       rh       ws       wd      swc        h 
# 1.740642 1.490084 1.062713 1.029823 1.364722 1.809694 

# Extract variable importance
importance_values <- importance(rf.nee_6, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_6, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tair 177.55333
# rh    95.45722
# ws   150.43097
# wd   128.82545
# swc  188.60975
# h    313.21372


```

#reduced model 7: removing soil moist-temp interaction, vpd, rg, *tair, and le  (swapping tair and tsoil)  
```{r}

rf.nee_7 <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + rh + ws + wd + swc + h, data = df_era2)

 vif(vif_model) 
#    tsoil       rh       ws       wd      swc        h 
# 1.795630 1.489880 1.075084 1.038298 1.548490 1.640614 

# Extract variable importance
importance_values <- importance(rf.nee_7, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_7, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tsoil 199.8100 *
# rh    106.4712
# ws    155.6312 *
# wd    128.4710
# swc   145.2717
# h     368.0150 *


```

#reduced model 8: removing VPD, rg, tsoil, tair, and le -- *adding in soil temp-moist interaction
```{r}

rf.nee_8 <- randomForest(nee ~ TS_SWC_interact + rh + ws + wd + swc + h,
                             data = train.nee,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ TS_SWC_interact + rh + ws + wd + swc + h, data = df_era2)

 vif(vif_model) 
# TS_SWC_interact              rh              ws              wd             swc               h 
#        1.718131        1.492326        1.062432        1.034974        1.539461        1.601862 

# Extract variable importance
importance_values <- importance(rf.nee_8, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_8, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                  %IncMSE
# TS_SWC_interact 175.5376 *
# rh              107.1026
# ws              147.1569
# wd              131.7755
# swc             147.7557 *
# h               357.1714 *


#Notes: 
#*tsoil has higher incMSE compared to interaction term; tair inMSE also slightly higher 

```
# ***********************


#Re-running with cc of ALL variables being testsed, and using the whole dataset (not training vs esting) - this uses the finalized dataset used in analyses 



#complete cases of all predictor variables being used and complete cases of obs nee (not gapfilled)

```{r}
#Complete cases of nee 
cc_nee = df_era2[complete.cases(df_era2$nee),]
cc = subset(cc,cc$nee < 12 & cc$nee > -14) #removes some outliers / spread


#subset out cc
cc_all = cc[complete.cases(cc$tair, cc$wd, cc$cardDir, cc$rh, cc$rg, cc$ws, cc$tsoil, cc$swc, cc$h, cc$le, cc$vpd),]
```



#SWC-soil temp interaction term 
```{r}
# Create interaction term --> explicit interaction term while keeping original terms 
cc_all$TS_SWC_interact <- cc_all$tsoil * cc_all$swc
```


# VarImp for NEE

#testing for correlated variables 
#Non-parametric tests of correlations - spearman's correlation 

##### Full model with all variables & interaction term, cc of ALL variables 
```{r}

rf.nee_full.cc <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + 
                             vpd + swc + h + le + TS_SWC_interact ,
                             data = cc_all,
                             ntree = 950,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + vpd + swc + h + le + TS_SWC_interact, data = cc_all)

vif(vif_model) 
#            tair              rh              rg              ws              wd 
#       10.746877        4.001402       13.568506        1.236861        1.082739 
#           tsoil             vpd             swc               h              le 
#       29.509590       13.986425        2.022967        7.176011        6.385860 
# TS_SWC_interact 
#       19.082907 

# Extract variable importance
importance_values <- importance(rf.nee_full.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_full.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                   %IncMSE
# tair             35.52427
# rh               80.67945
# rg               45.34761
# ws               87.72781 *
# wd              124.92105 *
# tsoil            70.36174
# vpd              42.19614
# swc             103.79417 *
# h                66.07705
# le               50.26218
# TS_SWC_interact  71.21866

```
#Now we start removing / swapping out variables that appear to be collinear (see VIF, corr matrix). My approach is to remove the variables with the highest VIF after each model run


#reduced model 1: removing soil temp - soil moisture interaction 
```{r}

rf.nee_1.cc <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + 
                             vpd + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + vpd + swc + h + le, data = cc_all)

 vif(vif_model)
 #     tair        rh        rg        ws        wd     tsoil       vpd       swc         h 
 # 9.814506  3.858254 13.513712  1.218658  1.078970  8.204134 13.656342  1.976365  7.159718 
 #       le 
 # 6.379694 

# Extract variable importance
importance_values <- importance(rf.nee_1.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_1.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   42.12507
# rh     82.01873
# rg     42.70822
# ws     96.03229 *
# wd    118.81967 *
# tsoil  90.44566
# vpd    45.62667
# swc   124.07490 *
# h      62.53791
# le     49.76220
```
#removing variable with highest VIF from previous model 

#reduced model 2: removing soil moist-temp interaction & vpd
```{r}

rf.nee_2.cc <- randomForest(nee ~ tair + rh + rg + ws + wd + tsoil + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + rg + ws + wd + tsoil + swc + h + le, data = cc_all)

 vif(vif_model) 
 #     tair        rh        rg        ws        wd     tsoil       swc         h        le 
 # 7.503837  2.014857 13.430518  1.164004  1.075777  6.954049  1.790062  6.972090  5.644709 

# Extract variable importance
importance_values <- importance(rf.nee_2.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_2.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   60.70451
# rh     87.35141
# rg     43.08088
# ws     91.93951
# wd    128.93834 *
# tsoil 101.46825 *
# swc   121.04909 *
# h      63.41955
# le     52.26742
```
#reduced model 3: removing soil moist-temp interaction, vpd, & rg
```{r}

rf.nee_3.cc <- randomForest(nee ~ tair + rh + ws + wd + tsoil + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + tsoil + swc + h + le, data = cc_all)

 vif(vif_model) 
#     tair       rh       ws       wd    tsoil      swc        h       le 
# 5.321477 1.805231 1.133102 1.075776 5.383748 1.673126 3.053299 4.472283 

# Extract variable importance
importance_values <- importance(rf.nee_3.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_3.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tair   66.34371
# rh     80.67984
# ws    111.08161 *
# wd    110.36258 *
# tsoil  97.48625
# swc   134.21077 *
# h     104.94091
# le     74.35098
```
#reduced model 4: removing soil moist-temp interaction, rg, vpd, tsoil   
```{r}

rf.nee_4.cc <- randomForest(nee ~ tair + rh + ws + wd + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + swc + h + le, data = cc_all)

 vif(vif_model) 
#     tair       rh       ws       wd      swc        h       le 
# 2.287025 1.804623 1.110735 1.066251 1.395880 3.051308 4.470915 

# Extract variable importance
importance_values <- importance(rf.nee_4.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_4.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tair 111.89664
# rh   101.45981
# ws   114.52206 *
# wd   114.33082 *
# swc  182.57753 *
# h    105.61302
# le    88.11088

```



#reduced model 5: removing soil moist-temp interaction, rg, vpd, *Swapping out tair and adding tsoil back in   
```{r}

rf.nee_5.cc <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h + le,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + rh + ws + wd + swc + h + le, data = cc_all)

 vif(vif_model) 
#    tsoil       rh       ws       wd      swc        h       le 
# 2.313788 1.794010 1.130489 1.075243 1.669824 3.044341 4.183500 

# Extract variable importance
importance_values <- importance(rf.nee_5.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_5.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#         %IncMSE
# tsoil 115.87215 *
# rh     98.65017
# ws    106.82040
# wd    113.63500 *
# swc   143.30746 *
# h     112.28845
# le     85.58012

#tsoil has higher incMSE compared to tair when the other is excluded 
#for both models, le has the highest VIF so removing that next 

```

#reduced model 6: removing soil moist-temp interaction, rg, *tsoil, and le    
```{r}

rf.nee_6.cc <- randomForest(nee ~ tair + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tair + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
#     tair       rh       ws       wd      swc        h 
# 1.906641 1.474734 1.100270 1.065513 1.392197 1.799002 

# Extract variable importance
importance_values <- importance(rf.nee_6.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_6.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#       %IncMSE
# tair 143.2239 *
# rh   101.6508
# ws   128.5292
# wd   120.9855
# swc  215.6550 *
# h    284.3507 *


```
#reduced model 7: removing soil moist-temp interaction, vpd, rg, *tair, and le  (swapping tair and tsoil)  
```{r}

rf.nee_7.cc <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ tsoil + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
#    tsoil       rh       ws       wd      swc        h 
# 2.061475 1.473227 1.121458 1.073954 1.668372 1.645937 

# Extract variable importance
importance_values <- importance(rf.nee_7.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_7.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#        %IncMSE
# tsoil 153.8955
# rh    102.5658
# ws    134.5362
# wd    115.4700
# swc   153.6187
# h     337.4732


```

#reduced model 8: removing VPD, rg, tsoil, tair, and le -- *adding in soil temp-moist interaction
```{r}

rf.nee_8.cc <- randomForest(nee ~ TS_SWC_interact + rh + ws + wd + swc + h,
                             data = cc_all,
                             ntree = 850,
                             importance = TRUE)


 vif_model <- lm(nee ~ TS_SWC_interact + rh + ws + wd + swc + h, data = cc_all)

 vif(vif_model) 
# TS_SWC_interact              rh              ws              wd             swc               h 
#        1.718131        1.492326        1.062432        1.034974        1.539461        1.601862 

# Extract variable importance
importance_values <- importance(rf.nee_8.cc, type = 1)  # type = 1 for %IncMSE

# Print the importance values
print(importance_values)

# Plot the importance values
varImpPlot(rf.nee_8.cc, type = 1, main = "NEE: Variable Importance (%IncMSE)")

#                  %IncMSE
# TS_SWC_interact 175.5376 *
# rh              107.1026
# ws              147.1569
# wd              131.7755
# swc             147.7557 *
# h               357.1714 *


#Notes: 
#*tsoil has higher incMSE compared to interaction term; tair inMSE also slightly higher 

```
#Testing which model may be better, comparing the reduced models using tair and tsoil 
#### *anova doesn't work on randomforest products 
#### AIC/BIC also don't work for RF models 

```{r}

#using OOB and RMSE to compare the reduced models 6 and 7 

oob_mse_6 <- tail(rf.nee_6.cc$mse, 1)
oob_r2_6  <- tail(rf.nee_6.cc$rsq, 1)

oob_mse_7 <- tail(rf.nee_7.cc$mse, 1)
oob_r2_7  <- tail(rf.nee_7.cc$rsq, 1)

data.frame(model = c("airT", "soilT"),
           OOB_MSE = c(oob_mse_6, oob_mse_7),
           OOB_R2  = c(oob_r2_6,  oob_r2_7))

# # model      OOB MSE               OOB R2
# airT	      1.123764	          0.7817901		
# soilT	      1.059777	          0.7942150	

#tsoil has slightly lower error, and slightly higher R2, indicates it may be the better model 


#looking at model 8 with interaction term 
oob_mse_8 <- tail(rf.nee_8.cc$mse, 1)
oob_r2_8  <- tail(rf.nee_8.cc$rsq, 1)

data.frame(model = c("airT", "soilT", "interaction"),
           OOB_MSE = c(oob_mse_6, oob_mse_7, oob_mse_8),
           OOB_R2  = c(oob_r2_6,  oob_r2_7, oob_r2_8))
#tsoil still has slightly better performance 


```
#comparing lm models of reduced RF models 
```{r}
#lm of rf.nee_7
lm_rf.nee_6<- lm(nee ~ tair + rh + ws + wd + swc + h, data = cc_all)
lm_rf.nee_7 <- lm(nee ~ tsoil + rh + ws + wd + swc + h, data = cc_all)

anova(lm_rf.nee_7,lm_rf.nee_6 )
AIC(lm_rf.nee_7,lm_rf.nee_6) #AIC for 6 = 81775, AIC for 7 = 81665 so 7 has slightly lower AIC
BIC(lm_rf.nee_7,lm_rf.nee_6) #BIC for 6 = 81839, BIC for 7 = 81729 so 7 has slightly lower BIC

```

```{r}
# Load required libraries
install.packages("Metrics")
library(caret)
library(Metrics)
library(dplyr)


# Method 1: Out-of-Bag (OOB) Error Comparison
print("=== OOB Error Comparison ===")
print(paste("Model 6 (tair) OOB MSE:", round(rf.nee_6.cc$mse[length(rf.nee_6.cc$mse)], 4)))
print(paste("Model 7 (tsoil) OOB MSE:", round(rf.nee_7.cc$mse[length(rf.nee_7.cc$mse)], 4)))
print(paste("Model 6 (tair) % Var Explained:", round(rf.nee_6.cc$rsq[length(rf.nee_6.cc$rsq)] * 100, 2)))
print(paste("Model 7 (tsoil) % Var Explained:", round(rf.nee_7.cc$rsq[length(rf.nee_7.cc$rsq)] * 100, 2)))

# Method 2: Cross-Validation Comparison
set.seed(123)  # For reproducibility
n_folds <- 10

# Create folds
folds <- createFolds(cc_all$nee, k = n_folds)

# Function to perform CV for a model formula
cv_rf <- function(formula, data, folds, ntree = 850) {
  cv_results <- sapply(folds, function(fold) {
    train_data <- data[-fold, ]
    test_data <- data[fold, ]
    
    # Train model
    model <- randomForest(formula, data = train_data, ntree = ntree)
    
    # Predict on test set
    predictions <- predict(model, test_data)
    actual <- test_data$nee
    
    # Calculate metrics
    rmse <- sqrt(mean((predictions - actual)^2, na.rm = TRUE))
    mae <- mean(abs(predictions - actual), na.rm = TRUE)
    r2 <- cor(predictions, actual, use = "complete.obs")^2
    
    return(c(RMSE = rmse, MAE = mae, R2 = r2))
  })
  
  return(rowMeans(cv_results))
}

# Perform cross-validation
print("=== Cross-Validation Results ===")
cv_model6 <- cv_rf(nee ~ tair + rh + ws + wd + swc + h, cc_all, folds)
cv_model7 <- cv_rf(nee ~ tsoil + rh + ws + wd + swc + h, cc_all, folds)

print("Model 6 (tair):")
print(round(cv_model6, 4))
print("Model 7 (tsoil):")
print(round(cv_model7, 4))

# Method 3: Train/Test Split Comparison
set.seed(456)
train_index <- createDataPartition(cc_all$nee, p = 0.8, list = FALSE)
train_data <- cc_all[train_index, ]
test_data <- cc_all[-train_index, ]

# Train models on training set
rf_train_6 <- randomForest(nee ~ tair + rh + ws + wd + swc + h, 
                           data = train_data, ntree = 850, importance = TRUE)
rf_train_7 <- randomForest(nee ~ tsoil + rh + ws + wd + swc + h, 
                           data = train_data, ntree = 850, importance = TRUE)

# Predict on test set
pred_6 <- predict(rf_train_6, test_data)
pred_7 <- predict(rf_train_7, test_data)

# Calculate test set metrics
test_metrics_6 <- c(
  RMSE = rmse(test_data$nee, pred_6),
  MAE = mae(test_data$nee, pred_6),
  R2 = cor(test_data$nee, pred_6)^2
)

test_metrics_7 <- c(
  RMSE = rmse(test_data$nee, pred_7),
  MAE = mae(test_data$nee, pred_7),
  R2 = cor(test_data$nee, pred_7)^2
)

print("=== Test Set Performance ===")
print("Model 6 (tair):")
print(round(test_metrics_6, 4))
print("Model 7 (tsoil):")
print(round(test_metrics_7, 4))

# Method 4: Variable Importance Comparison
print("=== Variable Importance Comparison ===")
importance_6 <- importance(rf.nee_6.cc)
importance_7 <- importance(rf.nee_7.cc)

print("Model 6 Variable Importance:")
print(round(importance_6, 2))
print("Model 7 Variable Importance:")
print(round(importance_7, 2))

# Method 5: Statistical Comparison using Predictions
# McNemar's test equivalent for regression (paired t-test of residuals)
pred_full_6 <- predict(rf.nee_6.cc)
pred_full_7 <- predict(rf.nee_7.cc)

residuals_6 <- cc_all$nee - pred_full_6
residuals_7 <- cc_all$nee - pred_full_7

# Paired t-test of absolute residuals
abs_res_test <- t.test(abs(residuals_6), abs(residuals_7), paired = TRUE)
print("=== Statistical Comparison of Absolute Residuals ===")
print(abs_res_test)

# Method 6: Comprehensive Comparison Table
comparison_table <- data.frame(
  Metric = c("OOB_MSE", "OOB_R2", "CV_RMSE", "CV_MAE", "CV_R2", "Test_RMSE", "Test_MAE", "Test_R2"),
  Model_6_tair = c(
    rf.nee_6.cc$mse[length(rf.nee_6.cc$mse)],
    rf.nee_6.cc$rsq[length(rf.nee_6.cc$rsq)],
    cv_model6[1], cv_model6[2], cv_model6[3],
    test_metrics_6[1], test_metrics_6[2], test_metrics_6[3]
  ),
  Model_7_tsoil = c(
    rf.nee_7.cc$mse[length(rf.nee_7.cc$mse)],
    rf.nee_7.cc$rsq[length(rf.nee_7.cc$rsq)],
    cv_model7[1], cv_model7[2], cv_model7[3],
    test_metrics_7[1], test_metrics_7[2], test_metrics_7[3]
  )
)

comparison_table$Better_Model <- ifelse(
  comparison_table$Metric %in% c("OOB_R2", "CV_R2", "Test_R2"),
  ifelse(comparison_table$Model_6_tair > comparison_table$Model_7_tsoil, "Model_6", "Model_7"),
  ifelse(comparison_table$Model_6_tair < comparison_table$Model_7_tsoil, "Model_6", "Model_7")
)

print("=== Comprehensive Model Comparison ===")
print(round(comparison_table[,1:3], 4))
print("Better performing model by metric:")
print(comparison_table[,c(1,4)])

# Method 7: Visualization
par(mfrow = c(2, 2))

# Plot 1: Predicted vs Actual
plot(cc_all$nee, pred_full_6, main = "Model 6 (tair): Predicted vs Actual", 
     xlab = "Actual NEE", ylab = "Predicted NEE")
abline(0, 1, col = "red")

plot(cc_all$nee, pred_full_7, main = "Model 7 (tsoil): Predicted vs Actual", 
     xlab = "Actual NEE", ylab = "Predicted NEE")
abline(0, 1, col = "red")

# Plot 2: Residuals
plot(pred_full_6, residuals_6, main = "Model 6 Residuals", 
     xlab = "Predicted", ylab = "Residuals")
abline(h = 0, col = "red")

plot(pred_full_7, residuals_7, main = "Model 7 Residuals", 
     xlab = "Predicted", ylab = "Residuals")
abline(h = 0, col = "red")

par(mfrow = c(1, 1))
```

