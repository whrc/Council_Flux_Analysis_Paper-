---
title: "Soil temp & C fluxes" #includes soil temp and SWC (all to 15cm depth) 
#AMERIFLUX data is in micro mol/m2/s for CO2 and nano mol/m2/s for CH4 --> convert to make the units in gC/m2/day for timeseries figures 
# 12 = molar mass of C 
#nmol C to g C = 10^-9 * 12 & umol C to g C = 10^-6 * 12
#Notes on site: Wind direction primarily blows from NW, except for Dec - Mar, when it primarily blows from SE direction. The site is largely tussock tundra but to the south there is thermokarst 
output: html_document
date: "2025-04-28"
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## based on Dani's Churchill CO2 Analysis code on github 

```{r, include=FALSE}
rm(list = ls())

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix)
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra)
library(plotly)
library(RColorBrewer)
library(pracma)
library(dplyr)

Sys.setenv(TZ='UTC')
```

# Set working directory and then Load data

```{r}
#using the ".2" version to reflect the updated SWC used in RF - should have seasons already included for each DOY

#needs continuous day variable - daily avg, calculated in processing steps
df = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

#needs continuous day variable - daily avg, calculated in processing steps
df_avg = fread('C:/Users/kkent/Documents/Council Data/Council BASE gapfilling/council_AVG_gapfilled_clean_2017_2023_for analysis.2.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

```

#create a useable timestamp - not necessary here as it's already in the correct format from our BASE processing code, but leaving as reference just in case  
```{r}
#ignore this if df is already in correct format, as this might mess up the formatting here and cause issues with analysis
# df$TIMESTAMP_END = as.character(df$TIMESTAMP_END)
# df$TIMESTAMP_START = as.character(df$TIMESTAMP_START)
# 
# df$TIMESTAMP_END = as.POSIXct(df$TIMESTAMP_END, tz="UTC", format = "%Y%m%d%H%M")
# df$TIMESTAMP_START = as.POSIXct(df$TIMESTAMP_START, tz="UTC", format = "%Y%m%d%H%M")
```


```{r}
#checking timestamp 
ggplot(data = df,aes(TIMESTAMP_END,FC_F))+
  geom_point()+
  scale_x_datetime(limits = as.POSIXct(c('2021-09-28','2021-10-05')))+
  scale_y_continuous(limits = c(-12,5))
```


#Yearly dataframes

```{r}
df$TIMESTAMP = df$TIMESTAMP_END
df_avg$TIMESTAMP = df_avg$TIMESTAMP_END

#create dataframes for each year for the data you have so you can look at annual trends 

#map out the timestamp of the daily avg dataset
df_avg$date <- as.POSIXct(df_avg$date, format = "%Y-%m-%d") #tells R the order of the timestamp: yr-month-day 

df_avg_2017 <- df_avg %>% filter(year == "2017") 
df_avg_2018 <- df_avg %>% filter(year == "2018") 
df_avg_2019 <- df_avg %>% filter(year == "2019") 
df_avg_2020 <- df_avg %>% filter(year == "2020") 
df_avg_2021 <- df_avg %>% filter(year == "2021") 
df_avg_2022 <- df_avg %>% filter(year == "2022") 
df_avg_2023 <- df_avg %>% filter(year == "2023") 


#for HH data
df <- df %>%
  mutate(year = format(date, "%Y"))

df_2017 <- df %>% filter(year == "2017") 
df_2018 <- df %>% filter(year == "2018") 
df_2019 <- df %>% filter(year == "2019") 
df_2020 <- df %>% filter(year == "2020") 
df_2021 <- df %>% filter(year == "2021") 
df_2022 <- df %>% filter(year == "2022") 
df_2023 <- df %>% filter(year == "2023") 


#spot check df to make sure it worked correctly 

```

#Comparing SWC and soil temp from the different locations 
```{r}
#SWC 
ggplot(data = df) +
  geom_line(aes(TIMESTAMP, SWC_1_1_1, col = 'SWC1 margin pond'))+
  geom_line(aes(TIMESTAMP, SWC_2_1_1, col = 'SWC2 lichen berries')) +
  geom_line(aes(TIMESTAMP, SWC_3_1_1, col = 'SWC3 tussock')) +
  labs(title = "Comparing SWC locations")+
  labs( x = "Timestamp",
        y = "SWC")+
  scale_y_continuous()+
  theme_minimal()


#soil temp
ggplot(data = df) +
    geom_line(aes(TIMESTAMP, TS_5_1_1, col = 'TS5 unknown')) + #putting it at front so other colored lines are not obscured by TS5
  geom_line(aes(TIMESTAMP, TS_1_1_1, col = 'TS1 margin pond'))+
  geom_line(aes(TIMESTAMP, TS_2_1_1, col = 'TS2 lichen berries')) +
  geom_line(aes(TIMESTAMP, TS_3_1_1, col = 'TS3 tussock')) +
  geom_line(aes(TIMESTAMP, TS_4_1_1, col = 'TS4 EC tower')) +
  #geom_line(aes(TIMESTAMP, TS_5_1_1, col = 'TS5 unknown')) +
  labs(title = "Comparing Soil temp among locations")+
  labs( x = "Timestamp",
        y = "Soil temp (C)")+
  scale_y_continuous()+
  theme_minimal()
```
#Timeseries - SWC and soil temp Facet wrapped by year 
```{r}
#facet-wrapped by year 

df <- df %>%
  mutate(month = format(date, "%m"))

df <- df %>%
  mutate(monthday  = as.Date(format(TIMESTAMP,   # force every point into a "2000‚ÄêMM-DD" date
                      "2000-%m-%d")))


#SWC 
ggplot(data = df) +
  geom_line(aes(monthday, SWC_1_1_1, col = 'SWC1 Margin Pond'))+
  geom_line(aes(monthday, SWC_2_1_1, col = 'SWC2 Lichen & Berries')) +
  geom_line(aes(monthday, SWC_3_1_1, col = 'SWC3 Tussock')) +
  facet_wrap(~year, ncol = 1)+ #sets 1 column for panels 
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b"          #to change numerical month to "jan", "feb" 
  ) +  
  scale_y_continuous()+
  labs(
    title = "Soil Water Content to 15cm Depth",
    x     = NULL,
    y     = "Soil Water Content to 15cm Depth (%SWC)",
    color = "Sensor"
  ) +
  theme_bw() +
  theme(
    strip.text      = element_text(face = "bold"),    # bold year labels
    axis.text.x     = element_text(face= "bold", angle = 0)#,        # horizontal months
    #panel.spacing.y = unit(0.5, "lines")              # tighten vertical spacing
  )


# ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/EC.SWC_timeseries_allyears.png", 
#        width = 10, height = 12, dpi = 600)


#soil temp
ggplot(data = df) +
    #geom_line(aes(TIMESTAMP, TS_5_1_1, col = 'TS5 unknown')) + #putting it at front so other colored lines are not obscured by TS5
  geom_line(aes(monthday, TS_1_1_1, col = 'TS1 Margin Pond'))+
  geom_line(aes(monthday, TS_2_1_1, col = 'TS2 Lichen & Berries')) +
  geom_line(aes(monthday, TS_3_1_1, col = 'TS3 Tussock')) +
  geom_line(aes(monthday, TS_4_1_1, col = 'TS4 EC Tower')) +
   facet_wrap(~year, ncol = 1)+ #sets 1 column for panels 
  scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b"          #to change numerical month to "jan", "feb" 
  ) +  
  scale_y_continuous()+
  labs(
    title = "Soil Temperature to 15cm Depth", face = "bold",
    x     = NULL,
    y     = "Soil Temperature to 15cm Depth (C)",
    color = "Sensor"
  ) +
  theme_bw() +
  theme(
    strip.text      = element_text(face = "bold"),    # bold year labels
    axis.text.x     = element_text(face= "bold", angle = 0)#,        # horizontal months
    #panel.spacing.y = unit(0.5, "lines")              # tighten vertical spacing
  )

# ggsave("C:/Users/kkent/Documents/Github Flux Network/Council_Flux_Analysis_Paper/Council Figures/EC.soiltemp_timeseries_allyears.png",
#        width = 10, height = 12, dpi = 600)

```
#Removing Winter - Dataset without winter season 

```{r}
df_avg_nowinter <- df_avg %>%
  filter(season!= "Winter")

#map out the timestamp of the daily avg dataset
df_avg_nowinter$date <- as.POSIXct(df_avg_nowinter$date, format = "%Y-%m-%d") #tells R the order of the timestamp: yr-month-day 

df_avg_nowinter_2017 <- df_avg_nowinter %>% filter(year == "2017") 
df_avg_nowinter_2018 <- df_avg_nowinter %>% filter(year == "2018") 
df_avg_nowinter_2019 <- df_avg_nowinter %>% filter(year == "2019") 
df_avg_nowinter_2020 <- df_avg_nowinter %>% filter(year == "2020") 
df_avg_nowinter_2021 <- df_avg_nowinter %>% filter(year == "2021") 
df_avg_nowinter_2022 <- df_avg_nowinter %>% filter(year == "2022") 
df_avg_nowinter_2023 <- df_avg_nowinter %>% filter(year == "2023") 

```



#Soil Temperature Relationship

####Exploratory plot of relationships 
```{r}
ggplot(data = df_avg_nowinter, (aes(x=TS_3_1_1, y = FC_night)))+
  geom_point()+
  geom_smooth(method = "auto") +
  facet_wrap(~year) 

```

#Comparing Different models for Temp - comparing the best fit - df_avg

####Exponential is best for FC_night, quadratic is best for FCH4

```{r}

# Function to compare different model types
compare_model_types <- function(flux_var, temp_var, df) {
  # Results dataframe
  results <- data.frame(
    model_type = c("Exponential", "Linear", "Quadratic", "Logarithmic"),
    r_squared = numeric(4)
  )
  
  # 1. Exponential model: flux ~ a * exp(b * temp)
  tryCatch({
    exp_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", temp_var, ")")), 
                     data = df, start = list(a = 1, b = 0.1))
    RSS <- sum(residuals(exp_model)^2)
    TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
    results$r_squared[1] <- 1 - (RSS/TSS)
  }, error = function(e) {
    results$r_squared[1] <<- NA
  })
  
  # 2. Linear model: flux ~ a + b * temp
  linear_model <- lm(as.formula(paste(flux_var, "~", temp_var)), data = df)
  results$r_squared[2] <- summary(linear_model)$r.squared
  
  # 3. Quadratic model: flux ~ a + b * temp + c * temp^2
  quad_model <- lm(as.formula(paste(flux_var, "~", temp_var, "+", "I(", temp_var, "^2)")), data = df)
  results$r_squared[3] <- summary(quad_model)$r.squared
  
  # 4. Logarithmic model: flux ~ a + b * log(temp+c)
  # Adding constant to temperature to handle negative values
  df$temp_adjusted <- df[[temp_var]] + abs(min(df[[temp_var]], na.rm = TRUE)) + 1
  log_model <- lm(as.formula(paste(flux_var, "~ log(temp_adjusted)")), data = df)
  results$r_squared[4] <- summary(log_model)$r.squared
  
  return(results)
}

# Compare model types for FC_night
model_comparison_FC_night <- compare_model_types("FC_night", "TS_3_1_1", df_avg)
print(model_comparison_FC_night)
#exponential is best when including winter seasons; R2 = 0.5178

# Compare model types for FCH4
model_comparison_FCH4 <- compare_model_types("FCH4", "TS_3_1_1", df_avg)
print(model_comparison_FCH4)
#suggests quadratic is best when including winter season; R2 = 0.1575 
```


#Different models - comparing the best fit - no winter 

####Results suggest exponential is best, as expected, but R2 still quite low 
```{r}
#uses function created in code chunk above 

# Compare model types for FC_night
model_comparison_FC_night <- compare_model_types("FC_night", "TS_3_1_1", df_avg_nowinter)
print(model_comparison_FC_night)
#suggests exponential is best when not including winter season, R2 = 0.394 

# Compare model types for FCH4
model_comparison_FCH4 <- compare_model_types("FCH4", "TS_3_1_1", df_avg_nowinter)
print(model_comparison_FCH4)
#suggests exponential is best when not including winter season; R2 = 0.127 



```

#Comparing different models - FCH4 and only winter 
```{r}
#model with only winter 

# Compare model types for FCH4
model_comparison_FCH4_winter <- compare_model_types("FCH4", "TS_3_1_1", df_avg %>% filter(season== "Winter"))
print(model_comparison_FCH4_winter)
#suggests quadratic is best for winter only R2=0.50
```



#Comparing different models - SWC - df_avg
```{r}

# Function to compare different model types
compare_model_types <- function(flux_var, SWC_var, df) {
  # Results dataframe
  results <- data.frame(
    model_type = c("Exponential", "Linear", "Quadratic", "Logarithmic"),
    r_squared = numeric(4)
  )
  
  # 1. Exponential model: flux ~ a * exp(b * SWC)
  tryCatch({
    exp_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", SWC_var, ")")), 
                     data = df, start = list(a = 1, b = 0.1))
    RSS <- sum(residuals(exp_model)^2)
    TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
    results$r_squared[1] <- 1 - (RSS/TSS)
  }, error = function(e) {
    results$r_squared[1] <<- NA
  })
  
  # 2. Linear model: flux ~ a + b * SWC
  linear_model <- lm(as.formula(paste(flux_var, "~", SWC_var)), data = df)
  results$r_squared[2] <- summary(linear_model)$r.squared
  
  # 3. Quadratic model: flux ~ a + b * SWC + c * SWC^2
  quad_model <- lm(as.formula(paste(flux_var, "~", SWC_var, "+", "I(", SWC_var, "^2)")), data = df)
  results$r_squared[3] <- summary(quad_model)$r.squared
  
  # 4. Logarithmic model: flux ~ a + b * log(SWC+c)
  # Adding constant to SWCerature to handle negative values
  df$SWC_adjusted <- df[[SWC_var]] + abs(min(df[[SWC_var]], na.rm = TRUE)) + 1
  log_model <- lm(as.formula(paste(flux_var, "~ log(SWC_adjusted)")), data = df)
  results$r_squared[4] <- summary(log_model)$r.squared
  
  return(results)
}

# Compare model types for FC_night
model_comparison_FC_night <- compare_model_types("FC_night", "SWC_3_1_1", df_avg)
print(model_comparison_FC_night)
#exponential is best when including winter seasons; R2 = 0.237

# Compare model types for FCH4
model_comparison_FCH4 <- compare_model_types("FCH4", "SWC_3_1_1", df_avg)
print(model_comparison_FCH4)
#suggests quadratic is best when including winter season; R2 = 0.14
```

#Different models - comparing the best fit - no winter 
####Results suggest exponential is best, as expected, but R2 still quite low 
```{r}

# Compare model types for FC_night
model_comparison_FC_night <- compare_model_types("FC_night", "SWC_3_1_1", df_avg_nowinter)
print(model_comparison_FC_night)
#suggests exponential is best when not including winter season; R2 = 0.093

# Compare model types for FCH4
model_comparison_FCH4 <- compare_model_types("FCH4", "SWC_3_1_1", df_avg_nowinter)
print(model_comparison_FCH4)
#suggests exponential is best when not including winter season; R2 = 0.126

```

### Exp. Model for soil temp v C fluxes - all seasons 
```{r}

###Across all years - all seasons - exp was best for FC_night, but quad was best for FCH4

#co2
exp_model_FCnight <- nls(FC_night ~ a * exp(b * TS_3_1_1), data = df_avg, start = list(a = 1, b = 0.1))

# Generate predicted values
df_avg$predicted_FCnight <- predict(exp_model_FCnight, newdata = df_avg)


#ch4 --> testing out exp, but see codes below for quad model 
exp_model_ch4 <- nls(FCH4 ~ a * exp(b * TS_3_1_1), data = df_avg, start = list(a = 1, b = 0.1))

# Generate predicted values
df_avg$predicted_ch4 <- predict(exp_model_ch4, newdata = df_avg)



####all years, no winter - exp for FC_night and FCH4 

#co2
exp_model_nowinter <- nls(FC_night ~ a * exp(b * TS_3_1_1), data = df_avg_nowinter, start = list(a = 1, b = 0.1))

# Generate predicted values
df_avg_nowinter$predicted_FCnight <- predict(exp_model_nowinter, newdata = df_avg_nowinter)


#ch4
exp_model_ch4_nowinter <- nls(FCH4 ~ a * exp(b * TS_3_1_1), data = df_avg_nowinter, start = list(a = 1, b = 0.1))

# Generate predicted values
df_avg_nowinter$predicted_ch4 <- predict(exp_model_ch4_nowinter, newdata = df_avg_nowinter)


```




# Quadratic model for FCH4 - all seasons 

```{r}
#Œ≤-1 (the B1TS) captures the linear change in methane flux per ¬∞C
#Œ≤-2 (the B2(TS^2) captures how that rate accelerates or decelerates as temperature rises (the curvature)

# Fit a quadratic model for FCH4 vs soil temperature
quad_model_ch4 <- lm(FCH4 ~ TS_3_1_1 + I(TS_3_1_1^2), data = df_avg) #wrap the quadratic term in "I" so R code knows to square the term as is, not that it's "up to 2nd degree interactions"

# View the model summary
summary(quad_model_ch4) #R2 = 0.16

# Predict FCH4 values using the quadratic model
df_avg$predicted_ch4_quad <- predict(quad_model_ch4, newdata = df_avg)

# Create plot with actual data and model prediction
ggplot() +
  # Add observed data points
  geom_point(data = df_avg, aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1), alpha = 0.7) +
  # Add model prediction line
  geom_line(data = df_avg, aes(x = TS_3_1_1, y = predicted_ch4_quad), 
           color = "red", size = 1.2) +
  # Add formatting
  scale_color_viridis_c(name = "SWC (%)") +
  theme_bw() +
  labs(title = "Quadratic Model: Methane Flux vs. Soil Temperature",
       subtitle = paste("FCH4 =", 
                      round(coef(quad_model_ch4)[1], 2), "+", 
                      round(coef(quad_model_ch4)[2], 2), "√ó Temp +", 
                      round(coef(quad_model_ch4)[3], 2), "√ó Temp¬≤"),
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)") +
  annotate("text", x = -5, y = 37, label  = "R2 = 0.16, p<0.001") #R2 taken from summary


#Predicted vs observed agreement 
summary(lm(df_avg$FCH4 ~ df_avg$predicted_ch4_quad)) #R2 = 0.15


ggplot() +
  # Add observed data points
    geom_point(data = df_avg, aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1))+
  geom_smooth(data = df_avg, aes(x = TS_3_1_1, y = FCH4), alpha = 0.7, method = "auto", se = TRUE)+
  #geom_smooth(method = "auto", se = TRUE)+
  # Add model prediction line
  geom_line(data = df_avg, aes(x = TS_3_1_1, y = predicted_ch4_quad), 
           color = "red", size = 1.2) 


```

## R Squared Values of exponential models & quadratic FCH4 model 
```{r}
# R squared values

r_squared <- function(model, column) {
  
  RSS <- sum(residuals(model)^2) # Residual sum of sqares
  TSS <- sum((column - mean(column, na.rm = TRUE))^2, na.rm = TRUE) # Total sum of squares
  
  return(1-(RSS/TSS)) # R squared
  
  
}

#All seasons
rsq_co2 <- r_squared(exp_model_FCnight, df_avg$FC_night)
rsq_ch4 <- r_squared(exp_model_ch4, df_avg$FCH4)
rsq_ch4_quad <- r_squared(quad_model_ch4, df_avg$FCH4)
  
  

print(rsq_co2)
print(rsq_ch4)
print(rsq_ch4_quad) #R2 of 0.17, but summary said 0.16

#No Winter season
rsq_co2_nw <- r_squared(exp_model_nowinter, df_avg_nowinter$FC_night)
rsq_ch4_nw <- r_squared(exp_model_ch4_nowinter, df_avg_nowinter$FCH4)

print(rsq_co2_nw)
print(rsq_ch4_nw)


#checking agreement of predicted and obs data 

#exponential model for FC_night 
ggplot(data = df_avg) +
  theme_bw() +
  geom_point(aes(x=predicted_FCnight, y = FC_night))

summary(lm(df_avg$FC_night ~ df_avg$predicted_FCnight)) #R2 = 0.4778, slope = 1

#exponential model for FCH4
ggplot(data = df_avg) +
  theme_bw() +
  geom_point(aes(x=predicted_ch4, y= FCH4))

summary(lm(df_avg$FCH4 ~ df_avg$predicted_ch4)) #R2 = 0.06 * BAD * slope = 0.9

#eponential model for FC_night, no winter 
ggplot(data = df_avg_nowinter) +
  theme_bw() +
  geom_point(aes(x=predicted_FCnight, y = FC_night))

summary(lm(df_avg_nowinter$FC_night ~ df_avg_nowinter$predicted_FCnight)) #R2 = 0.33; slope = 1

#exponential model for FCH4, no winter 
ggplot(data = df_avg) +
  theme_bw() +
  geom_point(aes(x=predicted_ch4, y= FCH4))

summary(lm(df_avg_nowinter$FCH4 ~ df_avg_nowinter$predicted_ch4)) #R2 = 0.1 * BAD * slope = 0.98

#quad model for FCH4
ggplot(data = df_avg) +
  theme_bw() +
  geom_point(aes(x=predicted_ch4, y= FCH4))

summary(lm(df_avg_nowinter$FCH4 ~ df_avg_nowinter$predicted_ch4)) #R2 = 0.1 * BAD * slope = 0.98

```



### Plots - observed vs predicted for C and temp 
```{r}

#FC

ggplot(data = df_avg, (aes(x=TS_3_1_1, y = FC_night)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
  labs(
    title = "FC_night vs Soil temp"
  )


ggplot(data = df_avg, (aes(x=TS_3_1_1, y = FC_night)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
  geom_line(aes(x=TS_3_1_1, y = predicted_FCnight, color = "red"))+
    labs(
    title = "FC_night vs Soil temp & predicted FC_night"
  )

#FC - no winter 

ggplot(data = df_avg_nowinter, (aes(x=TS_3_1_1, y = FC_night)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
    labs(
    title = "FC_night vs Soil temp - No Winter"
  )


ggplot(data = df_avg_nowinter, (aes(x=TS_3_1_1, y = FC_night)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
  geom_line(aes(x=TS_3_1_1, y = predicted_FCnight, color = "red"))+
    labs(
    title = "FC_night vs Soil temp & predicted FC_night - No Winter"
  )


#FCH4 
ggplot(data = df_avg, (aes(x=TS_3_1_1, y = FCH4)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
    labs(
    title = "FCH4 vs Soil temp"
  )


ggplot(data = df_avg, (aes(x=TS_3_1_1, y = FCH4)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
  geom_line(aes(x=TS_3_1_1, y = predicted_ch4, color = "red"))+
    labs(
    title = "FCH4 vs Soil temp & predicted FCH4"
  )

#FCH4 - no winter 
ggplot(data = df_avg_nowinter, (aes(x=TS_3_1_1, y = FCH4)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
    labs(
    title = "FCH4 vs Soil temp & predicted FCH4 - No Winter"
  )


ggplot(data = df_avg_nowinter, (aes(x=TS_3_1_1, y = FCH4)))+
  geom_point()+
  facet_wrap(~year) +
    stat_smooth(method = "auto") +
  geom_line(aes(x=TS_3_1_1, y = predicted_ch4, color = "red")) +
    labs(
    title = "FCH4 vs Soil temp & predicted FCH4 - No Winter"
  )
```



#Flux variables vs. TS3 (tussock soil temp to 15cm) to visualize temperature/co2 flux relationship

Temp relationship plots with daily averages - exponential model 

```{r}
#Across all years with all seasons 

co2model <- ggplot(data=df_avg)+
  theme_bw()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(aes(x=TS_3_1_1, y=FC_night, col = DOY, shape = factor(year)))+
  geom_line(aes(x = TS_3_1_1, y = predicted_FCnight))+
  scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("15cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CO "[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature"))+
  scale_shape_manual(name = "Year", values = c(15, 16, 17, 18, 21, 23, 24 ))+ #one symbol for each year 
  scale_x_continuous(limits=c(-11,19))+
  scale_y_continuous(limits=c(-3,6))+
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14),legend.position = 'none')+
  annotate("text",
           x = -Inf, y = Inf,
           hjust = -0.1, vjust = 1.3,
           label = paste0("R¬≤ = ", round(rsq_co2, 2)),
           size = 5)

co2model


#Methane vs. soil temp

ch4model <- ggplot(data=df_avg)+
  geom_vline(xintercept=0)+
  geom_hline(yintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_3_1_1, y=FCH4*(1/1000), col = DOY,  shape = factor(year)))+
  geom_line(aes(x = TS_3_1_1, y = predicted_ch4*(1/1000)))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("15cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits = c(-11, 19))+
  scale_y_continuous(limits = c(-0.02, 0.05))+
  scale_shape_manual(name = "Year", values = c(15, 16, 17, 18, 21, 23, 24 ))+ #one symbol for each year 
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14),legend.position = 'none')+
  annotate("text", 
           x = -Inf, y = Inf, 
           hjust = -0.1, vjust = 1.3,
           label = paste0("R¬≤ = ", round(rsq_ch4, 2)),
           size = 5)

ch4model
# 
# png(filename = './modelgrid.png',width = 9.3,height = 5.9,units = 'in',res = 2000)
# grid.arrange(co2model, ch4model, nrow = 1)
# dev.off()



CH4vTemp <- ggplot(data=df_avg)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_3_1_1, y=FCH4*(1/1000)))

CH4vTemp

CH4vTemp2 <- ggplot(data=df)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_3_1_1, y=FCH4*(1/1000)))

CH4vTemp2

CH4vTemp_nw <- ggplot(data=df_avg_nowinter)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_3_1_1, y=FCH4*(1/1000)))

CH4vTemp_nw

```


#Flux variables vs TS3 - Winter removed - exponential model 

```{r}

co2model_nw <- ggplot(data=df_avg_nowinter)+
  theme_bw()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(aes(x=TS_3_1_1, y=FC_night, col = DOY, shape = factor(year)))+
  geom_line(aes(x = TS_3_1_1, y = predicted_FCnight))+
  scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("15cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CO "[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature, No Winter"))+
  scale_shape_manual(name = "Year", values = c(15, 16, 17, 18, 21, 23, 24 ))+ #one symbol for each
  scale_x_continuous(limits=c(-5, 19))+
  scale_y_continuous(limits=c(-3, 6))+
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14)) +
  #theme(legend.position = c(0.95, 0.5))+
  annotate("text", 
           x = -Inf, y = Inf, 
           hjust = -0.1, vjust = 1.3,
           label = paste0("R¬≤ = ", round(rsq_co2_nw, 2)),
           size = 5)

co2model_nw



#Methane vs. soil temp

ch4model_nw <- ggplot(data=df_avg_nowinter)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x = TS_3_1_1, y=FCH4*(1/1000), col = DOY,  shape = factor(year)))+
  geom_line(aes(x = TS_3_1_1, y = predicted_ch4*(1/1000)))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("15cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature, No Winter")
  )+
  scale_x_continuous(limits = c(-5, 19))+
  scale_y_continuous(limits = c(-0.02, 0.05))+
  scale_shape_manual(name = "Year", values = c(15, 16, 17, 18, 21, 23, 24 ))+ #one symbol for each
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14))+
   #theme(legend.position = c(0.95, 0.5))+  OR legend.position = 'none')+
  annotate("text", 
           x = -Inf, y = Inf, 
           hjust = -0.1, vjust = 1.3,
           label = paste0("R¬≤ = ", round(rsq_ch4_nw, 2)),
           size = 5)

ch4model_nw


# png(filename = './modelgridco2.png',width = 7,height = 10,units = 'in',res = 2000)
# grid.arrange(co2model, co2model_ns, nrow = 2)
# dev.off()
# 
# png(filename = './modelgridch4.png',width = 7,height = 10,units = 'in',res = 2000)
# grid.arrange(ch4model, ch4model_ns, nrow = 2)
# dev.off()




```
# Temp vs FCH4 - all seasons - quadratic model 
```{r}

#Methane vs. soil temp

ch4model_quad <- ggplot(data=df_avg)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_3_1_1, y=FCH4*(1/1000), col = DOY,  shape = factor(year)))+
  geom_line(aes(x = TS_3_1_1, y = predicted_ch4_quad*(1/1000)))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("15cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits = c(-11, 19))+
  scale_y_continuous(limits = c(-0.02, 0.05))+
  scale_shape_manual(name = "Year", values = c(15, 16, 17, 18, 21, 23, 24 ))+ #one symbol for each year 
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14))+
  annotate("text", 
           x = -Inf, y = Inf, 
           hjust = -0.1, vjust = 1.3,
           label = paste0("R¬≤ = ", round(rsq_ch4_quad, 2)),
           size = 5)

ch4model_quad
```












#Other temp sensors - Trying relationship based on different temp sensors 

function to test other soil sensors & compare linear vs exponential fitted lines 
```{r}
# Function to create comparative plots for different soil temperature sensors
compare_soil_temp_sensors <- function(flux_var, df) {
  temp_cols <- c("TS_1_1_1", "TS_2_1_1", "TS_3_1_1", "TS_4_1_1")
  temp_names <- c("Margin Pond", "Lichen & Berries", "Tussock", "EC Tower")
  
  # Create a 2x2 panel of plots
  plots <- list()
  
  for (i in seq_along(temp_cols)) {
    temp_col <- temp_cols[i]
    temp_name <- temp_names[i]
    
    # Create basic plot
    p <- ggplot(df, aes_string(x = temp_col, y = flux_var)) +
      geom_point(alpha = 0.4) +
      theme_bw() +
      labs(
        x = paste0(temp_name, " Soil Temp (¬∞C)"),
        y = if(flux_var == "FC_night") "Nighttime CO2 Flux (Œºmol/m¬≤/s)" else "CH4 Flux (nmol/m¬≤/s)"
      )
    
    # Try exponential model
    tryCatch({
      exp_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", temp_col, ")")), 
                      data = df, start = list(a = 1, b = 0.1))
      
      # Calculate R¬≤
      RSS <- sum(residuals(exp_model)^2)
      TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
      r2_exp <- 1 - (RSS/TSS)
      
      # Generate prediction data
      pred_data <- data.frame(x = seq(min(df[[temp_col]], na.rm = TRUE), 
                                     max(df[[temp_col]], na.rm = TRUE), 
                                     length.out = 100))
      names(pred_data)[1] <- temp_col
      
      # Calculate predictions
      pred_data[[flux_var]] <- predict(exp_model, newdata = pred_data)
      
      # Add to plot
      p <- p + geom_line(data = pred_data, aes_string(x = temp_col, y = flux_var), 
                         color = "red", size = 1)
      
      # Add R¬≤ annotation for exponential model
      p <- p + annotate("text", x = max(df[[temp_col]], na.rm = TRUE) * 0.8, 
                       y = max(df[[flux_var]], na.rm = TRUE) * 0.9,
                       label = paste0("Exp. R¬≤ = ", round(r2_exp, 3)))
    }, error = function(e) {
      # If exponential model fails, just note it
      p <- p + annotate("text", x = mean(df[[temp_col]], na.rm = TRUE), 
                       y = max(df[[flux_var]], na.rm = TRUE) * 0.9,
                       label = "Exp. model failed")
    })
    
    # Add linear model
    tryCatch({
      linear_model <- lm(as.formula(paste(flux_var, "~", temp_col)), data = df)
      r2_linear <- summary(linear_model)$r.squared
      
      p <- p + geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "dashed") +
        annotate("text", x = max(df[[temp_col]], na.rm = TRUE) * 0.8, 
                 y = max(df[[flux_var]], na.rm = TRUE) * 0.8,
                 label = paste0("Linear R¬≤ = ", round(r2_linear, 3)))
    }, error = function(e) {
      # If linear model fails, just note it
    })
    
    plots[[i]] <- p
  }
  
  # Arrange plots in a grid
  grid_title <- if(flux_var == "FC_night") "Nighttime CO2 Flux vs. Different Soil Temperature Sensors" else "CH4 Flux vs. Different Soil Temperature Sensors"
  
  # Return list of plots (can be arranged with grid.arrange from gridExtra package)
  return(list(plots = plots, title = grid_title))
}


# Compare temperature sensors for FC_night - all seasons
fc_night_sensor_plots <- compare_soil_temp_sensors("FC_night", df_avg)
grid.arrange(grobs = fc_night_sensor_plots$plots, top = fc_night_sensor_plots$title)
#TS3 = best R2, 0.52 exp

# Compare temperature sensors for FCH4 - no winter 
fch4_sensor_plots <- compare_soil_temp_sensors("FCH4", df_avg)
grid.arrange(grobs = fch4_sensor_plots$plots, top = fch4_sensor_plots$title)
#EC tower best R2, 0.17 exp; tussock = R2 0.08 exp, next best is margin pond R2 = 0.13 exp

#No Winter 


# Compare temperature sensors for FC_night - no winter 
fc_night_sensor_plots_nw <- compare_soil_temp_sensors("FC_night", df_avg_nowinter)
grid.arrange(grobs = fc_night_sensor_plots_nw$plots, top = fc_night_sensor_plots_nw$title)
#TS3 tussock = best R2, 0.39, exp

# Compare temperature sensors for FCH4 - no winter 
fch4_sensor_plots_nw <- compare_soil_temp_sensors("FCH4", df_avg_nowinter)
grid.arrange(grobs = fch4_sensor_plots_nw$plots, top = fch4_sensor_plots_nw$title)
#EC tower = best R2, 0.27, exp; tussock R2 = 0.13, exp

#Exponential curves fit better than linear* 
```

####validating 
```{r}
# create a function to fit models for all temperature sensors and compare results
# This will help us identify which temperature sensor best explains flux variations

fit_compare_sensors <- function(flux_var, df) {
  # List of temperature columns to test
  temp_cols <- c("TS_1_1_1", "TS_2_1_1", "TS_3_1_1", "TS_4_1_1")
  
  # Store results
  results <- data.frame(sensor = temp_cols, 
                       r_squared = numeric(length(temp_cols)),
                       a_coef = numeric(length(temp_cols)),
                       b_coef = numeric(length(temp_cols)))
  
  # Loop through each temperature sensor
  for (i in seq_along(temp_cols)) {
    temp_col <- temp_cols[i]
    
    # Create formula dynamically
    formula <- as.formula(paste(flux_var, "~ a * exp(b *", temp_col, ")"))
    
    # Fit exponential model
    tryCatch({
      model <- nls(formula, data = df, start = list(a = 1, b = 0.1))
      
      # Calculate R-squared
      RSS <- sum(residuals(model)^2)
      TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
      r2 <- 1 - (RSS/TSS)
      
      # Store results
      results$r_squared[i] <- r2
      results$a_coef[i] <- coef(model)["a"]
      results$b_coef[i] <- coef(model)["b"]
    }, error = function(e) {
      # Handle errors (e.g., model failure to converge)
      results$r_squared[i] <<- NA
      results$a_coef[i] <<- NA
      results$b_coef[i] <<- NA
    })
  }
  
  return(results)
}

# Apply function to compare sensors for nighttime CO2 flux - no winter 
FC_night_sensor_comparison <- fit_compare_sensors("FC_night", df_avg_nowinter)
print(FC_night_sensor_comparison)

#TS3 has highest R2 of 0.39

# Apply function to compare sensors for CH4 flux - no winter 
FCH4_sensor_comparison <- fit_compare_sensors("FCH4", df_avg_nowinter)
print(FCH4_sensor_comparison)


#a_coef represents base flux at temp = 0; basal respiration rate 
#b_coef represents the temp sensitivity coefficient, how quickly flux inc when temp increases

#TS 3 R2 = 0.12; best is TS4 (EC tower) at 0.27 --> but will continue to use TS3 for continuity with CO2 fluxes and primary landscape type 
```
#Other SWC sensors - Trying relationship based on different SWC sensors 

function to test other SWC sensors & compare linear vs exponential fitted lines 
```{r}
# Function to create comparative plots for different soil temperature sensors
compare_soil_SWC_sensors <- function(flux_var, df) {
  SWC_cols <- c("SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1")
  SWC_names <- c("Margin Pond", "Lichen & Berries", "Tussock")
  
  # Create a 2x2 panel of plots
  plots <- list()
  
  for (i in seq_along(SWC_cols)) {
    SWC_col <- SWC_cols[i]
    SWC_name <- SWC_names[i]
    
    # Create basic plot
    p <- ggplot(df, aes_string(x = SWC_col, y = flux_var)) +
      geom_point(alpha = 0.4) +
      theme_bw() +
      labs(
        x = paste0(SWC_name, " SWC (%)"),
        y = if(flux_var == "FC_night") "Nighttime CO2 Flux (Œºmol/m¬≤/s)" else "CH4 Flux (nmol/m¬≤/s)"
      )
    
    # Try exponential model
    tryCatch({
      exp_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", SWC_col, ")")), 
                      data = df, start = list(a = 1, b = 0.1))
      
      # Calculate R¬≤
      RSS <- sum(residuals(exp_model)^2)
      TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
      r2_exp <- 1 - (RSS/TSS)
      
      # Generate prediction data
      pred_data <- data.frame(x = seq(min(df[[SWC_col]], na.rm = TRUE), 
                                     max(df[[SWC_col]], na.rm = TRUE), 
                                     length.out = 100))
      names(pred_data)[1] <- SWC_col
      
      # Calculate predictions
      pred_data[[flux_var]] <- predict(exp_model, newdata = pred_data)
      
      # Add to plot
      p <- p + geom_line(data = pred_data, aes_string(x = SWC_col, y = flux_var), 
                         color = "red", size = 1)
      
      # Add R¬≤ annotation for exponential model
      p <- p + annotate("text", x = max(df[[SWC_col]], na.rm = TRUE) * 0.8, 
                       y = max(df[[flux_var]], na.rm = TRUE) * 0.9,
                       label = paste0("Exp. R¬≤ = ", round(r2_exp, 3)))
    }, error = function(e) {
      # If exponential model fails, just note it
      p <- p + annotate("text", x = mean(df[[SWC_col]], na.rm = TRUE), 
                       y = max(df[[flux_var]], na.rm = TRUE) * 0.9,
                       label = "Exp. model failed")
    })
    
    # Add linear model
    tryCatch({
      linear_model <- lm(as.formula(paste(flux_var, "~", SWC_col)), data = df)
      r2_linear <- summary(linear_model)$r.squared
      
      p <- p + geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "dashed") +
        annotate("text", x = max(df[[SWC_col]], na.rm = TRUE) * 0.8, 
                 y = max(df[[flux_var]], na.rm = TRUE) * 0.8,
                 label = paste0("Linear R¬≤ = ", round(r2_linear, 3)))
    }, error = function(e) {
      # If linear model fails, just note it
    })
    
    plots[[i]] <- p
  }
  
  # Arrange plots in a grid
  grid_title <- if(flux_var == "FC_night") "Nighttime CO2 Flux vs. Different SWC Sensors" else "CH4 Flux vs. Different SWC Sensors"
  
  # Return list of plots (can be arranged with grid.arrange from gridExtra package)
  return(list(plots = plots, title = grid_title))
}

# Compare SWC sensors for FC_night - all seasons
fc_night_sensor_plotsSWC <- compare_soil_SWC_sensors("FC_night", df_avg)
grid.arrange(grobs = fc_night_sensor_plotsSWC$plots, top = fc_night_sensor_plotsSWC$title)

# Compare SWC sensors for FCH4 - all seasons 
fch4_sensor_plotsSWC <- compare_soil_SWC_sensors("FCH4", df_avg)
grid.arrange(grobs = fch4_sensor_plotsSWC$plots, top = fch4_sensor_plotsSWC$title)

# No Winter 

# Compare SWCerature sensors for FC_night
fc_night_sensor_plotsSWC_nw <- compare_soil_SWC_sensors("FC_night", df_avg_nowinter)
grid.arrange(grobs = fc_night_sensor_plotsSWC_nw$plots, top = fc_night_sensor_plotsSWC_nw$title)

# Compare SWCerature sensors for FCH4
fch4_sensor_plotsSWC_nw <- compare_soil_SWC_sensors("FCH4", df_avg_nowinter)
grid.arrange(grobs = fch4_sensor_plotsSWC_nw$plots, top = fch4_sensor_plotsSWC_nw$title)
```

####validating 
```{r}
# function to fit models for all temperature sensors and compare results
# This will help us identify which SWC sensor best explains flux variations

fit_compare_sensors <- function(flux_var, df) {
  # List of temperature columns to test
  SWC_cols <- c("SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1")
  
  # Store results
  results <- data.frame(sensor = SWC_cols, 
                       r_squared = numeric(length(SWC_cols)),
                       a_coef = numeric(length(SWC_cols)),
                       b_coef = numeric(length(SWC_cols)))
  
  # Loop through each temperature sensor
  for (i in seq_along(SWC_cols)) {
    SWC_col <- SWC_cols[i]
    
    # Create formula dynamically
    formula <- as.formula(paste(flux_var, "~ a * exp(b *", SWC_col, ")"))
    
    # Fit exponential model
    tryCatch({
      model <- nls(formula, data = df, start = list(a = 1, b = 0.1))
      
      # Calculate R-squared
      RSS <- sum(residuals(model)^2)
      TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
      r2 <- 1 - (RSS/TSS)
      
      # Store results
      results$r_squared[i] <- r2
      results$a_coef[i] <- coef(model)["a"]
      results$b_coef[i] <- coef(model)["b"]
    }, error = function(e) {
      # Handle errors (e.g., model failure to converge)
      results$r_squared[i] <<- NA
      results$a_coef[i] <<- NA
      results$b_coef[i] <<- NA
    })
  }
  
  return(results)
}

# Apply function to compare sensors for nighttime CO2 flux
FC_night_sensor_comparisonSWC <- fit_compare_sensors("FC_night", df_avg_nowinter)
print(FC_night_sensor_comparisonSWC)

#all very low R2, suggests water isn't a main driver of FC_night - SWC1 and SWC3 perform best

# Apply function to compare sensors for CH4 flux
FCH4_sensor_comparisonSWC <- fit_compare_sensors("FCH4", df_avg_nowinter)
print(FCH4_sensor_comparisonSWC)

#a_coef represents base flux at temp = 0; basal respiration rate 
#b_coef represents the SWC sensitivity coefficient, how quickly flux inc when SWC increases
#also all quite low, highest R2 in SWC3 =0.13
```

#Interactive models
```{r}

# Interactive model for CO2 flux
co2_interact_model <- lm(FC_night ~ TS_3_1_1 * SWC_3_1_1, data = df_avg)
summary(co2_interact_model)
#R2 = 0.49

# Interactive model for CH4 flux
ch4_interact_model <- lm(FCH4 ~ TS_3_1_1 * SWC_3_1_1, data = df_avg)
summary(ch4_interact_model)
#R2 = 0.29

#No Winter

# Interactive model for CO2 flux
co2_interact_model_nw <- lm(FC_night ~ TS_3_1_1 * SWC_3_1_1, data = df_avg_nowinter)
summary(co2_interact_model_nw)
#R2 = 0.3457

# Interactive model for CH4 flux
ch4_interact_model_nw <- lm(FCH4 ~ TS_3_1_1 * SWC_3_1_1, data = df_avg_nowinter)
summary(ch4_interact_model_nw)
#R2 = 0.277
```
#Potential Thresholds 

# By season and SWC 

```{r}
# FC_night scatter plot with coloring by season - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FC_night, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CO2 Flux by Season - NW")


# FCH4 scatter plot with coloring by season - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FCH4 * (1/1000), color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by Season - NW")


# FC_night scatter plot with coloring by season
ggplot(df_avg, aes(x = TS_3_1_1, y = FC_night, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CO2 Flux by Season")


# FCH4 scatter plot with coloring by season
ggplot(df_avg, aes(x = TS_3_1_1, y = FCH4 * (1/1000), color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by Season")

# FCH4 scatter plot with coloring by season
ggplot(df_avg, aes(x = TS_3_1_1, y = FCH4 * (1/1000), color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = FALSE) +
  geom_vline(xintercept=0)+
  geom_hline(yintercept=0)+
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by Season")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg, aes(x = TS_3_1_1, y = FCH4 * (1/1000), color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC")


# FCH4 scatter plot with coloring by SWC, facetwrapped by season 
ggplot(df_avg %>% drop_na(FCH4, TS_3_1_1, SWC_3_1_1, season), aes(x = TS_3_1_1, y = FCH4 * (1/1000), color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  facet_wrap(~season)+
  geom_smooth(method = "auto", se = FALSE) +
  geom_vline(xintercept=0)+
  geom_hline(yintercept=0)+
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature, SWC, and CH4 Flux by Season")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg, aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC")


# FCH4 scatter plot with coloring by SWC - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FCH4 * (1/1000), color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC - NW")


# FC_night scatter plot with coloring by SWC - no winter
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - NW")


```
```{r}
# FCH4 scatter plot with coloring by SWC - no winter 
ggplot(df_avg, aes(x = date, y = FCH4 * (1/1000), color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC - NW")

# FCH4 scatter plot with coloring by SWC - no winter 
ggplot(df_avg, aes(x = DOY, y = FCH4 * (1/1000), color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  facet_wrap(~year)+
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC - NW")
```



# 2019, with the most real methane data ** see if this U shape holds**

```{r}
# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2019"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC")

ggplot(df_avg %>%
         drop_na(TS_3_1_1, FCH4, SWC_3_1_1) %>%
         filter(year == "2019"), aes(x = DOY, y = FCH4, color = TS_3_1_1)) +
  geom_point(aes(x=DOY, y =TS_3_1_1))+
  geom_point(alpha = 0.7) +
  scale_color_viridis_c()+
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2019"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC")



```
#checking out temp <0 fluxes
```{r}

# FCH4 fluxes when temp <0; 2019 only 
ggplot(df_avg %>%
         filter(year == "2019")
       %>% filter(TS_3_1_1 < 0), aes(x = DOY, y = TS_3_1_1, color = SWC_3_1_1)) +
  
  geom_point(alpha = 0.7) +
 # geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "DOY", y = "Soil temp (C)", 
       title = "Relationship between Soil Temperature<0 and FCH4 Flux by SWC")



# FCH4 fluxes when temp <0; 2019 only; DOY < 150
ggplot(df_avg %>%
         filter(year == "2019")
       %>% filter(DOY < 150) 
       %>% filter(TS_3_1_1 < 0), aes(x = DOY, y = TS_3_1_1, color = SWC_3_1_1)) +
  
  geom_point(alpha = 0.7) +
 # geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "DOY", y = "Soil temp (C)", 
       title = "Daily Avg - Soil Temperature <0 (color = SWC) ")


# HH data - FCH4 fluxes when temp <0; 2019 only; DOY < 150
ggplot(df %>%
         filter(year == "2019")
       %>% filter(DOY < 150) 
       %>% filter(TS_3_1_1 < 0), aes(x = DOY, y = TS_3_1_1, color = SWC_3_1_1)) +
  
  geom_point(alpha = 0.7) +
 # geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "DOY", y = "Soil temp (C)", 
       title = "HH - Soil Temperature <0 (color = SWC)")



# FCH4 fluxes when temp <0; 2019 only 
ggplot(df_avg %>%
         filter(year == "2019")
       %>% filter(TS_3_1_1 < 0), aes(x = TS_3_1_1 , y = FCH4, color = SWC_3_1_1)) +
  
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FCH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature <0 and FCH4 Flux by SWC")
```



#all years 

```{r}
# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2017"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC - 2017")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2017"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2017")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2018"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC - 2018")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2018"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2018")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2019"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC- 2019")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2019"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2019")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2020"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC- 2020")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2020"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2020")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2021"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC- 2021")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2021"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2021")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2022"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC- 2022")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2022"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2022")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2023"), aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by SWC- 2023")

# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2023"), aes(x = TS_3_1_1, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by SWC - 2023")
 
```

#Quadratic model for FCH4 and soil temp
```{r}
#Œ≤-1 (the B1TS) captures the linear change in methane flux per ¬∞C
#Œ≤-2 (the B2(TS^2) captures how that rate accelerates or decelerates as temperature rises (the curvature)

# Fit a quadratic model for FCH4 vs soil temperature
quad_model_ch4 <- lm(FCH4 ~ TS_3_1_1 + I(TS_3_1_1^2), data = df_avg) #wrap the quadratic term in "I" so R code knows to square the term as is, not that it's "up to 2nd degree interactions"

# View the model summary
summary(quad_model_ch4)

# Create a visualization of the model fit
# First, create a data frame with temperature values for prediction
temp_range <- seq(min(df_avg$TS_3_1_1, na.rm = TRUE), 
                 max(df_avg$TS_3_1_1, na.rm = TRUE), 
                 length.out = 100)
pred_data <- data.frame(TS_3_1_1 = temp_range)

# Predict FCH4 values using the quadratic model
pred_data$FCH4_pred <- predict(quad_model_ch4, newdata = pred_data)

# Create plot with actual data and model prediction
ggplot() +
  # Add observed data points
  geom_point(data = df_avg, aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1), alpha = 0.7) +
  # Add model prediction line
  geom_line(data = pred_data, aes(x = TS_3_1_1, y = FCH4_pred), 
           color = "red", size = 1.2) +
  # Add formatting
  scale_color_viridis_c(name = "SWC (%)") +
  theme_bw() +
  labs(title = "Quadratic Model: Methane Flux vs. Soil Temperature",
       subtitle = paste("FCH4 =", 
                      round(coef(quad_model_ch4)[1], 2), "+", 
                      round(coef(quad_model_ch4)[2], 2), "√ó Temp +", 
                      round(coef(quad_model_ch4)[3], 2), "√ó Temp¬≤"),
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)")
```
#Adding SWC to quadratic model 
```{r}
# Quadratic model with SWC
quad_swc_model_ch4 <- lm(FCH4 ~ TS_3_1_1 + I(TS_3_1_1^2) + SWC_3_1_1, data = df_avg)


# Interactive model (including interactions between temperature terms and SWC)
interactive_model_ch4 <- lm(FCH4 ~ TS_3_1_1 + I(TS_3_1_1^2) + SWC_3_1_1 + 
                         TS_3_1_1:SWC_3_1_1 + I(TS_3_1_1^2):SWC_3_1_1, 
                         data = df_avg)
# Compare models
anova(quad_model_ch4, quad_swc_model_ch4, interactive_model_ch4)

AIC(quad_model_ch4, quad_swc_model_ch4, interactive_model_ch4)#interactive has lowest AIC
BIC(quad_model_ch4, quad_swc_model_ch4, interactive_model_ch4)#interactive has lowest BIC


# Check model summaries
summary(quad_swc_model_ch4)#R2 = 0.22
summary(interactive_model_ch4)#R2 = 0.32
```
#Visualize the interactive model 
```{r}
# Create prediction grid with temperature and SWC combinations
pred_grid <- expand.grid(
  TS_3_1_1 = seq(min(df_avg$TS_3_1_1, na.rm = TRUE),
                max(df_avg$TS_3_1_1, na.rm = TRUE),
                length.out = 100),
  SWC_3_1_1 = quantile(df_avg$SWC_3_1_1, probs = c(0.1, 0.5, 0.9), na.rm = TRUE)
)

# Calculate predictions from the interactive model
pred_grid$predicted <- predict(interactive_model_ch4, newdata = pred_grid)

# Create an enhanced visualization showing SWC interaction
ggplot() +
  # Add observed data points
  geom_point(data = df_avg, aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1), 
            alpha = 0.3, size = 1.5) +
  # Add model predictions by SWC level
  geom_line(data = pred_grid, aes(x = TS_3_1_1, y = predicted, 
                                 group = factor(SWC_3_1_1),
                                 color = SWC_3_1_1),
           size = 1.5) +
  # Add formatting
  scale_color_viridis_c(name = "SWC (%)") +
  theme_bw(base_size = 12) +
  labs(title = "Interactive Model: Methane Flux vs. Soil Temperature and Moisture",
       subtitle = "Showing how soil moisture modulates the temperature-methane relationship",
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)")
```



#Calc inflection point 
```{r}
# Calculate the inflection point (temperature where FCH4 is minimized)
# For a quadratic equation y = a + bx + cx¬≤, the minimum/maximum occurs at x = -b/(2c)
coefs <- coef(quad_model_ch4)
inflection_point <- -coefs[2] / (2 * coefs[3])

# Create an enhanced visualization showing the inflection point
ggplot() +
  # Add observed data points
  geom_point(data = df_avg, aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1), alpha = 0.7) +
  # Add model prediction line
  geom_line(data = pred_data, aes(x = TS_3_1_1, y = FCH4_pred), 
           color = "red", size = 1.2) +
  # Add vertical line at inflection point
  geom_vline(xintercept = inflection_point, linetype = "dashed", color = "darkred") +
  # Add text annotation for inflection point
  annotate("text", x = inflection_point + 1, y = min(pred_data$FCH4_pred), 
          label = paste("Min flux at", round(inflection_point, 1), "¬∞C"), 
          hjust = 0, color = "darkred") +
  # Add R¬≤ annotation
  annotate("text", x = min(df_avg$TS_3_1_1, na.rm = TRUE) + 2, 
          y = max(df_avg$FCH4, na.rm = TRUE) * 0.9,
          label = paste("R¬≤ =", round(summary(quad_model_ch4)$r.squared, 3)),
          hjust = 0) +
  # Add formatting
  scale_color_viridis_c(name = "SWC (%)") +
  theme_bw() +
  labs(title = "Quadratic Model: Methane Flux vs. Soil Temperature",
       subtitle = paste("FCH4 =", 
                      round(coef(quad_model_ch4)[1], 2), "+", 
                      round(coef(quad_model_ch4)[2], 2), "√ó Temp +", 
                      round(coef(quad_model_ch4)[3], 2), "√ó Temp¬≤"),
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)")





```

#Comprehensive figure 
```{r}
# Create a publication-quality figure
ggplot() +
  # Add observed data points with transparency based on SWC
  geom_point(data = df_avg, aes(x = TS_3_1_1, y = FCH4, color = SWC_3_1_1), 
            alpha = 0.7, size = 2) +
  # Add model prediction with confidence interval
  geom_smooth(data = df_avg, aes(x = TS_3_1_1, y = FCH4), 
             method = "lm", formula = y ~ x + I(x^2), 
             color = "darkred", size = 1.2, se = TRUE) +
  # Add vertical line at inflection point
  geom_vline(xintercept = inflection_point, linetype = "dashed", color = "darkred") +
  # Add text annotation for inflection point
  annotate("text", x = inflection_point + 1, y = min(df_avg$FCH4, na.rm = TRUE) + 1, 
          label = paste("Minimum flux at", round(inflection_point, 1), "¬∞C"), 
          hjust = 0, color = "darkred", size = 4) +
  # Add model equation and R¬≤ annotation
  annotate("text", x = min(df_avg$TS_3_1_1, na.rm = TRUE) + 2, 
          y = max(df_avg$FCH4, na.rm = TRUE) * 0.9,
          label = paste("Model: FCH4 =", 
                       round(coef(quad_model_ch4)[1], 1), "+", 
                       round(coef(quad_model_ch4)[2], 2), "√ó Temp +", 
                       round(coef(quad_model_ch4)[3], 3), "√ó Temp¬≤\n",
                       "R¬≤ =", round(summary(quad_model_ch4)$r.squared, 3)),
          hjust = 0, size = 4) +
  # Add formatting
  scale_color_viridis_c(name = "SWC (%)", option = "plasma") +
  theme_bw(base_size = 14) +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "right",
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12, face = "italic"),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12)
  ) +
  labs(title = "Quadratic Relationship Between Soil Temperature and Methane Flux",
       subtitle = "Arctic Tundra Ecosystem",
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)")

# Save high-resolution figure
ggsave("methane_temperature_quadratic_relationship.png", width = 10, height = 8, dpi = 300)
```

#Temp threshold at diff SWC levels 
```{r}
# Extract coefficients from the interactive model
coef_list <- coef(interactive_model_ch4)

# Function to calculate temperature threshold at a given SWC
calculate_temp_threshold <- function(swc) {
  # These are the coefficients that determine the shape of the parabola
  b1 <- coef_list["TS_3_1_1"]  # Linear temperature term
  b2 <- coef_list["I(TS_3_1_1^2)"]  # Quadratic temperature term
  b4 <- coef_list["TS_3_1_1:SWC_3_1_1"]  # Temperature-SWC interaction
  b5 <- coef_list["I(TS_3_1_1^2):SWC_3_1_1"]  # Quadratic temp-SWC interaction

  # Calculate effective linear and quadratic coefficients given SWC
  effective_b1 <- b1 + b4 * swc
  effective_b2 <- b2 + b5 * swc
  
  # The threshold occurs where the derivative equals zero: -b1/(2*b2)
  temp_threshold <- -effective_b1 / (2 * effective_b2)
  
  return(temp_threshold)
}

# Calculate thresholds at key SWC percentiles
swc_values <- quantile(df_avg$SWC_3_1_1, probs = seq(0.1, 0.9, by = 0.1), na.rm = TRUE)
temp_thresholds <- sapply(swc_values, calculate_temp_threshold)

# Create a data frame of results
swc_temp_thresholds <- data.frame(
  SWC_percentile = names(swc_values),
  SWC_value = swc_values,
  Temperature_threshold = temp_thresholds
)

print(swc_temp_thresholds)
#Results:
# The temperature threshold table shows at what soil temperature the methane flux response changes from negative to positive for different soil moisture levels:
# 
# At 10% SWC (very dry): The threshold is 16.6¬∞C - only at quite warm temperatures would methane flux start increasing
# At 50% SWC (medium): The threshold is 2.0¬∞C - close to freezing point
# At 90% SWC (very wet): The threshold is -0.7¬∞C - even before soil fully thaws

#As soil becomes wetter, the temp at which methane emissions start to inc with warming gets lower - moisture-dependent temp relationship * 

```
#SWC thresholds at different temps 
```{r}
# Function to calculate SWC threshold at a given temperature
calculate_swc_threshold <- function(temp) {
  # Extract relevant coefficients
  b3 <- coef_list["SWC_3_1_1"]  # Main SWC effect
  b4 <- coef_list["TS_3_1_1:SWC_3_1_1"]  # Temperature-SWC interaction
  b5 <- coef_list["I(TS_3_1_1^2):SWC_3_1_1"]  # Quadratic temp-SWC interaction
  
  # Partial derivative of flux with respect to SWC equals zero when:
  # b3 + b4*temp + b5*temp^2 = 0
  # If b5 is non-zero (significant quadratic interaction), we solve the quadratic
  # Otherwise, it's a simple linear threshold
  
  if (abs(b5) > 1e-6) {  # If quadratic interaction is meaningful
    # This is a quadratic equation in temp, not SWC
    # For SWC threshold, we would need to solve for when SWC effect changes sign
    # Not applicable in this model structure
    return(NA)
  } else {
    # If effectively linear in SWC, threshold is where effect equals zero
    swc_threshold <- -b3 / (b4 * temp)
    return(swc_threshold)
  }
}

# This approach might not work well with this model structure
# Instead, let's examine how the SWC effect varies with temperature directly

# Create temperature sequence
temp_seq <- seq(min(df_avg$TS_3_1_1, na.rm = TRUE), 
               max(df_avg$TS_3_1_1, na.rm = TRUE), 
               length.out = 20)

# For each temperature, calculate the marginal effect of SWC on methane flux
swc_effects <- sapply(temp_seq, function(temp) {
  b3 <- coef_list["SWC_3_1_1"]  # Main SWC effect
  b4 <- coef_list["TS_3_1_1:SWC_3_1_1"]  # Temperature-SWC interaction
  b5 <- coef_list["I(TS_3_1_1^2):SWC_3_1_1"]  # Quadratic temp-SWC interaction
  
  # Marginal effect of SWC at this temperature
  swc_effect <- b3 + b4 * temp + b5 * temp^2
  return(swc_effect)
})

# Create table of SWC effects at different temperatures
swc_effect_table <- data.frame(
  Temperature = temp_seq,
  SWC_effect = swc_effects
)

# Find where SWC effect changes sign (if it does)
sign_changes <- which(diff(sign(swc_effects)) != 0)
if (length(sign_changes) > 0) {
  swc_effect_threshold_temp <- temp_seq[sign_changes]
  print(paste("SWC effect changes sign at temperature:", swc_effect_threshold_temp))
} else {
  print("SWC effect does not change sign across the temperature range")
}

#Results: [1] "SWC effect changes sign at temperature: -2.56512106930451"
#means that at temp below -2, inc soil moisture would dec methane flux....but wouldn't it be frozen then anyhow? maybe it's trapping methane gas?
```
#Visualize - help from Claude 
```{r}
# 1. Create a clearer visualization of temperature thresholds at different SWC levels
ggplot(data = swc_temp_thresholds, aes(x = SWC_value, y = Temperature_threshold)) +
  geom_line(size = 1.5, color = "blue") +
  geom_point(size = 3) +
  theme_bw() +
  labs(title = "Temperature Threshold by Soil Moisture",
       subtitle = "Temperature at which CH4 flux response changes from negative to positive",
       x = "Soil Water Content (%)",
       y = "Temperature Threshold (¬∞C)")

# 2. Create a heatmap showing predicted methane flux
# Generate a dense prediction grid
temp_fine <- seq(min(df_avg$TS_3_1_1, na.rm = TRUE),
                max(df_avg$TS_3_1_1, na.rm = TRUE),
                length.out = 100)
swc_fine <- seq(min(df_avg$SWC_3_1_1, na.rm = TRUE),
               max(df_avg$SWC_3_1_1, na.rm = TRUE),
               length.out = 100)
pred_grid_fine <- expand.grid(TS_3_1_1 = temp_fine, SWC_3_1_1 = swc_fine)
pred_grid_fine$FCH4_pred <- predict(interactive_model_ch4, newdata = pred_grid_fine)

# Create an improved heatmap
ggplot() +
  # Add heatmap of predicted methane flux
  geom_raster(data = pred_grid_fine, 
             aes(x = TS_3_1_1, y = SWC_3_1_1, fill = FCH4_pred)) +
  # Use a better color scale
  scale_fill_viridis_c(option = "plasma", 
                      name = "CH4 Flux\n(nmol/m¬≤/s)") +
  # Add the threshold curve
  geom_line(data = swc_temp_thresholds, 
           aes(y = SWC_value, x = Temperature_threshold),
           color = "white", size = 1.5) +
  # Add observed data points to show data coverage
  geom_point(data = df_avg, 
            aes(x = TS_3_1_1, y = SWC_3_1_1),
            alpha = 0.05, color = "white", size = 0.5) +
  # Better labeling
  theme_bw() +
  labs(title = "Methane Flux Threshold Map",
       subtitle = "White line shows where temperature effect switches from negative to positive",
       x = "Soil Temperature (¬∞C)",
       y = "Soil Water Content (%)")

# 3. Create a plot showing SWC effect on methane at different temperatures
ggplot(swc_effect_table, aes(x = Temperature, y = SWC_effect)) +
  geom_line(size = 1.5, color = "darkgreen") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_bw() +
  labs(title = "Effect of Soil Moisture on Methane Flux",
       subtitle = "How the impact of SWC changes with temperature",
       x = "Soil Temperature (¬∞C)",
       y = "Marginal Effect of SWC on CH4 Flux")

# 4. Create profile plots showing methane response to temperature at different SWC levels
# Select representative SWC levels
swc_levels <- quantile(df_avg$SWC_3_1_1, probs = c(0.1, 0.5, 0.9), na.rm = TRUE)
names(swc_levels) <- c("Low SWC (10%)", "Medium SWC (50%)", "High SWC (90%)")

# Create prediction data for these SWC levels
temp_seq <- seq(min(df_avg$TS_3_1_1, na.rm = TRUE),
               max(df_avg$TS_3_1_1, na.rm = TRUE),
               length.out = 100)
swc_profiles <- data.frame()

for (i in 1:length(swc_levels)) {
  swc_val <- swc_levels[i]
  swc_name <- names(swc_levels)[i]
  
  # Create prediction data for this SWC level
  temp_data <- data.frame(
    TS_3_1_1 = temp_seq,
    SWC_3_1_1 = swc_val
  )
  
  # Generate predictions
  temp_data$FCH4_pred <- predict(interactive_model_ch4, newdata = temp_data)
  temp_data$SWC_level <- swc_name
  
  # Add to combined data frame
  swc_profiles <- rbind(swc_profiles, temp_data)
}

# Calculate temperature thresholds for these SWC levels
thresholds_for_plot <- sapply(swc_levels, calculate_temp_threshold)

# Create profile plot
ggplot(swc_profiles, aes(x = TS_3_1_1, y = FCH4_pred, color = SWC_level)) +
  geom_line(size = 1.5) +
  # Add vertical lines at threshold temperatures
  geom_vline(xintercept = thresholds_for_plot, linetype = "dashed",
            color = c("darkgreen", "blue", "red")) +
  # Add text labels for thresholds
  annotate("text", 
          x = thresholds_for_plot, 
          y = rep(max(swc_profiles$FCH4_pred) * 0.9, 3),
          label = paste("Threshold =", round(thresholds_for_plot, 1), "¬∞C"),
          color = c("darkgreen", "blue", "red"),
          hjust = c(1, 0.5, 0)) +
    theme_bw() +
  labs(title = "Methane Flux Response to Temperature at Different Moisture Levels",
       subtitle = "Dashed lines show threshold temperatures where response changes direction",
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)",
       color = "Soil Moisture Level")
```

#Visualized with more SWC bins:

```{r}
# Create more detailed SWC bins
swc_bins <- c(0, 20, 40, 60, 80, max(df_avg$SWC_3_1_1, na.rm = TRUE))
bin_labels <- c("Very Dry (0-20%)", "Dry (20-40%)", "Wet (40-60%)", "Very Wet (60-80%)", "Extremely Wet (80%+)")

# Calculate the mean SWC for each bin to use in predictions
mean_swc_by_bin <- numeric(length(bin_labels))
for (i in 1:length(bin_labels)) {
  bin_data <- df_avg %>% 
    filter(SWC_3_1_1 >= swc_bins[i] & SWC_3_1_1 < swc_bins[i+1])
  mean_swc_by_bin[i] <- mean(bin_data$SWC_3_1_1, na.rm = TRUE)
}

# Create temperature sequence
temp_seq <- seq(min(df_avg$TS_3_1_1, na.rm = TRUE),
               max(df_avg$TS_3_1_1, na.rm = TRUE),
               length.out = 100)

# Create prediction data for these SWC bins
swc_bin_profiles <- data.frame()

for (i in 1:length(bin_labels)) {
  swc_val <- mean_swc_by_bin[i]
  
  # Create prediction data for this SWC level
  temp_data <- data.frame(
    TS_3_1_1 = temp_seq,
    SWC_3_1_1 = swc_val
  )
  
  # Generate predictions
  temp_data$FCH4_pred <- predict(interactive_model_ch4, newdata = temp_data)
  temp_data$SWC_bin <- bin_labels[i]
  
  # Add to combined data frame
  swc_bin_profiles <- rbind(swc_bin_profiles, temp_data)
}

# Calculate temperature threshold for each bin
thresholds_for_bins <- sapply(mean_swc_by_bin, calculate_temp_threshold)
threshold_data <- data.frame(
  SWC_bin = bin_labels,
  SWC_value = mean_swc_by_bin,
  Temp_threshold = thresholds_for_bins
)

# Create improved profile plot with more SWC bins
ggplot(swc_bin_profiles, aes(x = TS_3_1_1, y = FCH4_pred, color = SWC_bin)) +
  geom_line(size = 1.5) +
  # Add vertical lines at threshold temperatures
  geom_vline(data = threshold_data, 
            aes(xintercept = Temp_threshold, color = SWC_bin),
            linetype = "dashed") +
  # Add text labels for thresholds
  geom_text(data = threshold_data,
           aes(x = Temp_threshold, 
               y = max(swc_bin_profiles$FCH4_pred) * (0.6 + 0.1*1:5),
               color = SWC_bin,
               label = paste("Threshold =", round(Temp_threshold, 1), "¬∞C")),
           hjust = 0) +
  scale_color_viridis_d(end = 0.9) +
  theme_bw() +
  labs(title = "Methane Flux Response to Temperature at Different Moisture Levels",
       subtitle = "Dashed lines show threshold temperatures where response changes direction",
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (nmol/m¬≤/s)",
       color = "Soil Moisture Level")
```
#Looking at reverse thresholds - at what SWC does temp relationship with CH4 change
```{r}
# Create a data frame with many SWC values
swc_range <- seq(min(df_avg$SWC_3_1_1, na.rm = TRUE),
                max(df_avg$SWC_3_1_1, na.rm = TRUE),
                length.out = 50)

# Calculate temperature threshold for each SWC value
temp_thresholds <- sapply(swc_range, calculate_temp_threshold)

# Create data frame for curve
threshold_curve <- data.frame(
  SWC = swc_range,
  Temp_threshold = temp_thresholds
)

# Plot the relationship between SWC and temperature threshold
ggplot(threshold_curve, aes(x = SWC, y = Temp_threshold)) +
  geom_line(size = 1.5, color = "blue") +
  geom_point(data = threshold_data, 
            aes(x = SWC_value, y = Temp_threshold), 
            size = 3, color = "red") +
  geom_text(data = threshold_data,
           aes(x = SWC_value, y = Temp_threshold,
               label = SWC_bin),
           hjust = -0.1, vjust = -0.5, size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "darkgrey") +
  theme_bw() +
  labs(title = "Temperature Threshold by Soil Moisture Level",
       subtitle = "Temperature at which CH4 flux response changes from negative to positive",
       x = "Soil Water Content (%)",
       y = "Temperature Threshold (¬∞C)")

# Create a contour plot showing regions of positive and negative temperature effect
# Generate a dense prediction grid
temp_fine <- seq(min(df_avg$TS_3_1_1, na.rm = TRUE),
                max(df_avg$TS_3_1_1, na.rm = TRUE),
                length.out = 100)
swc_fine <- seq(min(df_avg$SWC_3_1_1, na.rm = TRUE),
               max(df_avg$SWC_3_1_1, na.rm = TRUE),
               length.out = 100)
pred_grid_fine <- expand.grid(TS_3_1_1 = temp_fine, SWC_3_1_1 = swc_fine)

# Calculate the partial derivative of flux with respect to temperature
pred_grid_fine$temp_effect <- sapply(1:nrow(pred_grid_fine), function(i) {
  temp <- pred_grid_fine$TS_3_1_1[i]
  swc <- pred_grid_fine$SWC_3_1_1[i]
  
  # Get coefficients
  b1 <- coef(interactive_model_ch4)["TS_3_1_1"]  # Linear temperature term
  b2 <- coef(interactive_model_ch4)["I(TS_3_1_1^2)"]  # Quadratic temperature term
  b4 <- coef(interactive_model_ch4)["TS_3_1_1:SWC_3_1_1"]  # Temperature-SWC interaction
  b5 <- coef(interactive_model_ch4)["I(TS_3_1_1^2):SWC_3_1_1"]  # Quadratic interaction
  
  # Partial derivative: b1 + 2*b2*temp + b4*swc + 2*b5*temp*swc
  effect <- b1 + 2*b2*temp + b4*swc + 2*b5*temp*swc
  return(effect)
})

# Create a new categorical variable for positive/negative effect
pred_grid_fine$effect_direction <- ifelse(pred_grid_fine$temp_effect > 0, 
                                        "Positive (flux increases with warming)",
                                        "Negative (flux decreases with warming)")

# Create a contour plot showing temperature effect regions
ggplot() +
  # Add background fill showing positive/negative regions
  geom_raster(data = pred_grid_fine, 
             aes(x = TS_3_1_1, y = SWC_3_1_1, fill = effect_direction)) +
  # Add threshold curve
  geom_line(data = threshold_curve, 
           aes(x = Temp_threshold, y = SWC),
           color = "black", size = 1.5) +
  # Add observed data points
  geom_point(data = df_avg, 
            aes(x = TS_3_1_1, y = SWC_3_1_1),
            alpha = 0.1, size = 0.5) +
  # Add SWC bin thresholds
  geom_point(data = threshold_data,
            aes(x = Temp_threshold, y = SWC_value),
            size = 3, color = "red") +
  # Use distinct colors for positive/negative regions
  scale_fill_manual(values = c("blue", "red")) +
  # Format plot
  theme_bw() +
  labs(title = "Temperature-Moisture Interaction Map",
       subtitle = "Regions where temperature has positive vs. negative effect on methane flux",
       x = "Soil Temperature (¬∞C)",
       y = "Soil Water Content (%)",
       fill = "Temperature Effect")
```

#Binned Temp - coding help from Claude
```{r}
# Create temperature bins as requested
temp_bins <- c(-10, -1, 1, 4, 11, 18)
temp_labels <- c("Below Freezing (-10 to -1¬∞C)",
                "Around Freezing (-1 to 1¬∞C)",
                "Cold (1 to 4¬∞C)",
                "Cool (4 to 11¬∞C)",
                "Warm (11 to 18¬∞C)")

# Calculate the mean temperature for each bin to use in predictions
mean_temp_by_bin <- numeric(length(temp_labels))
for (i in 1:length(temp_labels)) {
  bin_data <- df_avg %>% 
    filter(TS_3_1_1 >= temp_bins[i] & TS_3_1_1 < temp_bins[i+1])
  mean_temp_by_bin[i] <- mean(bin_data$TS_3_1_1, na.rm = TRUE)
}

# Create SWC sequence
swc_seq <- seq(min(df_avg$SWC_3_1_1, na.rm = TRUE),
              max(df_avg$SWC_3_1_1, na.rm = TRUE),
              length.out = 100)

# Create prediction data for these temperature bins
temp_bin_profiles <- data.frame()

for (i in 1:length(temp_labels)) {
  temp_val <- mean_temp_by_bin[i]
  
  # Create prediction data for this temperature level
  swc_data <- data.frame(
    TS_3_1_1 = temp_val,
    SWC_3_1_1 = swc_seq
  )
  
  # Generate predictions
  swc_data$FCH4_pred <- predict(interactive_model_ch4, newdata = swc_data)
  swc_data$Temp_bin <- temp_labels[i]
  
  # Add to combined data frame
  temp_bin_profiles <- rbind(temp_bin_profiles, swc_data)
}

# Calculate the effect of SWC on methane at each temperature bin
swc_effects_by_temp <- data.frame()

for (i in 1:length(temp_labels)) {
  temp_val <- mean_temp_by_bin[i]
  
  # Get model coefficients
  b3 <- coef(interactive_model_ch4)["SWC_3_1_1"]  # Main SWC effect
  b4 <- coef(interactive_model_ch4)["TS_3_1_1:SWC_3_1_1"]  # Temp-SWC interaction
  b5 <- coef(interactive_model_ch4)["I(TS_3_1_1^2):SWC_3_1_1"]  # Quadratic interaction
  
  # Calculate SWC effect at this temperature
  swc_effect <- b3 + b4 * temp_val + b5 * temp_val^2
  
  swc_effects_by_temp <- rbind(swc_effects_by_temp, 
                             data.frame(Temp_bin = temp_labels[i],
                                      Temp_value = temp_val,
                                      SWC_effect = swc_effect))
}

# Create a nicely formatted profile plot with temperature bins
ggplot(temp_bin_profiles, aes(x = SWC_3_1_1, y = FCH4_pred, color = Temp_bin)) +
  geom_line(size = 1.5) +
  scale_color_viridis_d(option = "plasma", end = 0.9) +
  theme_bw(base_size = 12) +
  theme(legend.position = "right") +
  labs(title = "Methane Flux Response to Soil Moisture at Different Temperature Ranges",
       x = "Soil Water Content (%)",
       y = "CH4 Flux (nmol/m¬≤/s)",
       color = "Temperature Range")

# Create an alternative plot showing just the slope of the SWC effect
ggplot(swc_effects_by_temp, aes(x = Temp_value, y = SWC_effect, fill = Temp_bin)) +
  geom_col(width = 0.8) +
  geom_text(aes(label = round(SWC_effect, 3)), 
           vjust = ifelse(swc_effects_by_temp$SWC_effect > 0, -0.5, 1.5),
           size = 4) +
  scale_fill_viridis_d(option = "plasma", end = 0.9) +
  theme_bw(base_size = 12) +
  labs(title = "Effect of Soil Moisture on Methane Flux at Different Temperature Ranges",
       subtitle = "Values show the change in CH4 flux per 1% increase in soil moisture",
       x = "Temperature Range",
       y = "Marginal Effect of SWC on CH4 Flux",
       fill = "Temperature Range")

# Create a contour plot showing methane flux with both temp and SWC bins
# First bin both variables
df_avg$Temp_bin <- cut(df_avg$TS_3_1_1, 
                      breaks = temp_bins,
                      labels = temp_labels,
                      include.lowest = TRUE)

df_avg$SWC_bin <- cut(df_avg$SWC_3_1_1, 
                     breaks = c(0, 20, 40, 60, 80, max(df_avg$SWC_3_1_1, na.rm = TRUE)),
                     labels = c("Very Dry (0-20%)", 
                               "Dry (20-40%)", 
                               "Wet (40-60%)", 
                               "Very Wet (60-80%)", 
                               "Extremely Wet (80%+)"),
                     include.lowest = TRUE)

# Calculate mean methane flux for each bin combination
# bin_summary <- df_avg %>%
#   filter(!is.na(Temp_bin) & !is.na(SWC_bin)) %>%
#   group_by(Temp_bin, SWC_bin) %>%
#   summarize(
#     mean_FCH4 = mean(FCH4, na.rm = TRUE),
#     median_FCH4 = median(FCH4, na.rm = TRUE),
#     n = n(),
#     .groups = 'drop'
#   )


# Alternative approach to create bin summary
bin_summary <- aggregate(
  FCH4 ~ Temp_bin + SWC_bin, 
  data = df_avg[!is.na(df_avg$Temp_bin) & !is.na(df_avg$SWC_bin) & !is.na(df_avg$FCH4), ], 
  FUN = function(x) c(mean = mean(x, na.rm = TRUE), 
                     median = median(x, na.rm = TRUE), 
                     n = length(x))
)

# Convert the results to a more usable format
bin_summary <- data.frame(
  Temp_bin = bin_summary$Temp_bin,
  SWC_bin = bin_summary$SWC_bin,
  mean_FCH4 = bin_summary$FCH4[, "mean"],
  median_FCH4 = bin_summary$FCH4[, "median"],
  n = bin_summary$FCH4[, "n"]
)

# Create a heatmap of mean methane flux by temperature and SWC bins
ggplot(bin_summary, aes(x = Temp_bin, y = SWC_bin, fill = mean_FCH4)) +
  geom_tile() +
  geom_text(aes(label = paste0(round(mean_FCH4, 1), "\n(n=", n, ")")), 
           color = "cyan", size = 3) +
  scale_fill_viridis_c(option = "plasma", name = "Mean CH4 Flux\n(nmol/m¬≤/s)") +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Mean Methane Flux by Temperature and Moisture Bins",
       x = "Temperature Range",
       y = "Soil Moisture Range")

# Create a heatmap of mean methane flux by temperature and SWC bins
ggplot(bin_summary, aes(x = Temp_bin, y = SWC_bin, fill = mean_FCH4)) +
  geom_tile() +
  geom_text(aes(label = paste0(round(mean_FCH4, 1), "\n(n=", n, ")")), 
           color = "white", size = 3) +
  scale_fill_viridis_c(option = "plasma", name = "Mean CH4 Flux\n(nmol/m¬≤/s)") +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Mean Methane Flux by Temperature and Moisture Bins",
       x = "Temperature Range",
       y = "Soil Moisture Range")

# Create an interaction plot showing how the effect of SWC varies by temperature
# Generate a grid of predictions for each temp and SWC bin
bin_combinations <- expand.grid(
  Temp_bin = factor(temp_labels, levels = temp_labels),
  SWC_bin = factor(c("Very Dry (0-20%)", "Dry (20-40%)", "Wet (40-60%)", 
                    "Very Wet (60-80%)", "Extremely Wet (80%+)"),
                  levels = c("Very Dry (0-20%)", "Dry (20-40%)", "Wet (40-60%)", 
                          "Very Wet (60-80%)", "Extremely Wet (80%+)"))
)

# Assign representative values for each bin
bin_combinations$Temp_value <- mean_temp_by_bin[match(bin_combinations$Temp_bin, temp_labels)]
bin_combinations$SWC_value <- c(10, 30, 50, 70, 85)[match(bin_combinations$SWC_bin, 
                                                       c("Very Dry (0-20%)", "Dry (20-40%)", "Wet (40-60%)", 
                                                       "Very Wet (60-80%)", "Extremely Wet (80%+)"))]

# Generate predictions
bin_combinations$FCH4_pred <- sapply(1:nrow(bin_combinations), function(i) {
  predict(interactive_model_ch4, newdata = data.frame(
    TS_3_1_1 = bin_combinations$Temp_value[i],
    SWC_3_1_1 = bin_combinations$SWC_value[i]
  ))
})

# Create an interaction plot
ggplot(bin_combinations, aes(x = Temp_bin, y = FCH4_pred, group = SWC_bin, color = SWC_bin)) +
  geom_point(size = 3) +
  geom_line(size = 1.5) +
  scale_color_viridis_d(end = 0.9) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Interactive Effects of Temperature and Soil Moisture on Methane Flux",
       subtitle = "How soil moisture modifies the temperature response of methane flux",
       x = "Temperature Range",
       y = "Predicted CH4 Flux (nmol/m¬≤/s)",
       color = "Soil Moisture Range")
```

```{r}
ggplot(df_avg %>% filter(season == "Winter"), aes(x=TS_3_1_1, y = FCH4, color = SWC_3_1_1))+
  geom_point()+
  geom_smooth(method = "auto", se = TRUE)
```
















#*************************






#Air temp & FCH4 
```{r}
#**ACTUALLY FCH4 is in n-mol, not umol here 

# FCH4 scatter plot with coloring by SWC - all seasons - also shows slightly quadratic relationship, possibly** 
ggplot(df_avg, aes(x = TA , y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC - all years")

# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2017"), aes(x = TA , y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC - 2017")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2018"), aes(x = TA, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC - 2018")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2019"), aes(x = TA, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC- 2019")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2020"), aes(x = TA, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC- 2020")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2021"), aes(x = TA, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC- 2021")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2022"), aes(x = TA, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC- 2022")


# FCH4 scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2023"), aes(x = TA, y = FCH4, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and CH4 Flux by SWC- 2023")

```
#Air temp & FC_night 
```{r}
# FC_night scatter plot with coloring by SWC - all seasons, all years  
ggplot(df_avg, aes(x = TA , y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - all years")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2017"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2017")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2018"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2018")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2019"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2019")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2020"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2020")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2021"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2021")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2022"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2022")


# FC_night scatter plot with coloring by SWC - all seasons 
ggplot(df_avg %>%
         filter(year == "2023"), aes(x = TA, y = FC_night, color = SWC_3_1_1)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "auto", se = TRUE) +
  theme_bw() +
  labs(x = "Air Temp(¬∞C)", y = "FC_night Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Air Temp and FC_night Flux by SWC - 2023")
 
```



#C vs SWC by season - SWC 3
```{r}
# FC_night scatter plot with coloring by season - no winter 
ggplot(df_avg_nowinter, aes(x = SWC_3_1_1, y = FC_night, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "SWC", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between SWC and CO2 Flux by Season - NW")


# FCH4 scatter plot with coloring by season - no winter 
ggplot(df_avg_nowinter, aes(x = SWC_3_1_1, y = FCH4, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "SWC", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between SWC and CH4 Flux by Season - NW")


# FC_night scatter plot with coloring by season
ggplot(df_avg, aes(x = SWC_3_1_1, y = FC_night, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "SWC", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between SWC and CO2 Flux by Season")


# FCH4 scatter plot with coloring by season
ggplot(df_avg, aes(x = SWC_3_1_1, y = FCH4, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "SWC", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between SWC and CH4 Flux by Season")


```














#Annual variation in relationship - exponential model - soil temp TS3
```{r}
# Function to calculate and compare R¬≤ by year
get_yearly_r2_fixed <- function(data, flux_var, temp_var) {
  years <- 2017:2023
  result <- data.frame(
    year = years,
    r_squared = numeric(length(years)),
    a_coef = numeric(length(years)),
    b_coef = numeric(length(years)),
    n_obs = numeric(length(years)) # Added to check sample size
  )
  
  for (i in seq_along(years)) {
    # Explicitly convert year to character for filtering
    yr <- as.character(years[i])
    
    # Create a new dataframe for this year only
    df_year <- data[data$year == yr, ]
    
    # Print diagnostic info to check
    cat("Processing year:", yr, "with", nrow(df_year), "observations\n")
    
    # Only proceed if we have enough data points
    if (nrow(df_year) >= 10) {
      tryCatch({
        # Create formula with explicit column names
        formula_text <- paste0(flux_var, " ~ a * exp(b * ", temp_var, ")")
        model <- nls(formula_text, data = df_year, start = list(a = 1, b = 0.1))
        
        # Calculate R¬≤ specifically for this year's data
        RSS <- sum(residuals(model)^2)
        TSS <- sum((df_year[[flux_var]] - mean(df_year[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
        
        # Store results
        result$r_squared[i] <- 1 - (RSS/TSS)
        result$a_coef[i] <- coef(model)["a"]
        result$b_coef[i] <- coef(model)["b"]
        result$n_obs[i] <- nrow(df_year)
        
      }, error = function(e) {
        cat("Error in year", yr, ":", conditionMessage(e), "\n")
        result$r_squared[i] <<- NA
        result$a_coef[i] <<- NA
        result$b_coef[i] <<- NA
      })
    } else {
      cat("Not enough data for year", yr, "\n")
      result$r_squared[i] <- NA
      result$a_coef[i] <- NA
      result$b_coef[i] <- NA
      result$n_obs[i] <- nrow(df_year)
    }
  }
  
  return(result)
}

# Use function
yearly_r2_fc_night <- get_yearly_r2_fixed(df_avg_nowinter, "FC_night", "TS_3_1_1")
print(yearly_r2_fc_night)

# Also check methane
yearly_r2_fch4 <- get_yearly_r2_fixed(df_avg_nowinter, "FCH4", "TS_3_1_1")
print(yearly_r2_fch4)


# sum(is.na(df_avg_nowinter$FCH4)) #475
# sum(is.na(df_avg_nowinter$FC_night)) #490

#a_coef represents base flux at temp = 0; basal respiration rate 
#b_coef represents the temp sensitivity coefficient, how quickly flux inc when temp increases

```


#Yearly visualizations - no winter 

```{r}
# Improved function to create yearly plots with correct R¬≤ values
create_yearly_plots_fixed <- function(flux_var, temp_var, data_list) {
  plot_list <- list()
  
  for (i in seq_along(data_list)) {
    year_name <- names(data_list)[i]
    df_year <- data_list[[i]]
    
    if (nrow(df_year) > 0) {
      p <- ggplot(df_year, aes_string(x = temp_var, y = flux_var)) +
        geom_point(alpha = 0.7) +
        theme_bw() +
        ggtitle(paste("Year:", year_name)) +
        labs(x = "Soil Temperature (¬∞C)", 
             y = if(flux_var == "FC_night") "CO2 Flux (Œºmol/m¬≤/s)" else "CH4 Flux (nmol/m¬≤/s)")
      
      # Try to add exponential model
      tryCatch({
        # Fit exponential model
        exp_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", temp_var, ")")), 
                        data = df_year, start = list(a = 1, b = 0.1))
        
        # Calculate R¬≤ manually - this is the key fix
        RSS <- sum(residuals(exp_model)^2)
        TSS <- sum((df_year[[flux_var]] - mean(df_year[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
        r_squared <- 1 - (RSS/TSS)
        
        # Create prediction data
        new_data <- data.frame(x = seq(min(df_year[[temp_var]], na.rm = TRUE),
                                     max(df_year[[temp_var]], na.rm = TRUE),
                                     length.out = 100))
        names(new_data)[1] <- temp_var
        
        new_data[[flux_var]] <- predict(exp_model, newdata = new_data)
        
        p <- p + geom_line(data = new_data, aes_string(x = temp_var, y = flux_var), 
                          color = "red", size = 1)
        
        # Add manually calculated R¬≤ value
        a_coef <- coef(exp_model)["a"]
        b_coef <- coef(exp_model)["b"]
        equation <- paste0("y = ", round(a_coef, 3), "e^(", round(b_coef, 3), 
                         "x), R¬≤ = ", round(r_squared, 3))
        
        p <- p + annotate("text", x = min(df_year[[temp_var]], na.rm = TRUE) + 1, 
                         y = max(df_year[[flux_var]], na.rm = TRUE) * 0.9,
                         label = equation, hjust = 0)
      }, error = function(e) {
        # If exponential model fails, add linear
        linear_model <- lm(as.formula(paste(flux_var, "~", temp_var)), data = df_year)
        p <- p + geom_smooth(method = "lm", color = "blue", se = FALSE)
        
        r_squared_linear <- summary(linear_model)$r.squared
        
        p <- p + annotate("text", x = min(df_year[[temp_var]], na.rm = TRUE) + 1, 
                         y = max(df_year[[flux_var]], na.rm = TRUE) * 0.9,
                         label = paste0("R¬≤ = ", round(r_squared_linear, 3)),
                         hjust = 0)
      })
      
      plot_list[[i]] <- p
    }
  }
  
  return(plot_list)
}

# Create yearly dataframes list - all seasons
yearly_dfs<- list(
  "2017" = df_avg_2017,
  "2018" = df_avg_2018,
  "2019" = df_avg_2019,
  "2020" = df_avg_2020,
  "2021" = df_avg_2021,
  "2022" = df_avg_2022
)

# Create yearly dataframes list - no winter 
yearly_dfs_nw <- list(
  "2017" = df_avg_nowinter_2017,
  "2018" = df_avg_nowinter_2018,
  "2019" = df_avg_nowinter_2019,
  "2020" = df_avg_nowinter_2020,
  "2021" = df_avg_nowinter_2021,
  "2022" = df_avg_nowinter_2022
)

# Create plots for CO2 flux - all seasons 
fc_night_plots <- create_yearly_plots_fixed("FC_night", "TS_3_1_1", yearly_dfs)

# Display plots (requires gridExtra package)
grid.arrange(grobs = fc_night_plots, ncol = 2)

# Create plots for CH4 flux - all seasons 
fch4_plots <- create_yearly_plots_fixed("FCH4", "TS_3_1_1", yearly_dfs)
grid.arrange(grobs = fch4_plots, ncol = 2)

#Winter removed 

# Create plots for CO2 flux - no winter 
fc_night_plots <- create_yearly_plots_fixed("FC_night", "TS_3_1_1", yearly_dfs_nw)
grid.arrange(grobs = fc_night_plots, ncol = 2)

# Create plots for CH4 flux - no winter 
fch4_plots <- create_yearly_plots_fixed("FCH4", "TS_3_1_1", yearly_dfs_nw)
grid.arrange(grobs = fch4_plots, ncol = 2)


```
#Unified relationship script for yearly trends for FC_night & soil temp - all seasons
```{r}
# Unified analysis script for FC_night
analyze_FCnight_yearly <- function(data_list, temp_sensor = "TS_3_1_1") {
  # Create results table
  results <- data.frame(
    year = names(data_list),
    r_squared = numeric(length(data_list)),
    a_coef = numeric(length(data_list)),
    b_coef = numeric(length(data_list)),
    Q10 = numeric(length(data_list)),
    n_obs = numeric(length(data_list))
  )
  
  # Create list for plots
  plot_list <- list()
  
  # Process each year
  for (i in seq_along(data_list)) {
    year_name <- names(data_list)[i]
    df_year <- data_list[[i]]
    
    if (nrow(df_year) >= 10) {
      # Create formula
      formula_text <- paste0("FC_night ~ a * exp(b * ", temp_sensor, ")")
      
      # Fit model
      tryCatch({
        model <- nls(as.formula(formula_text), data = df_year, 
                    start = list(a = 1, b = 0.1))
        
        # Extract coefficients
        a_val <- coef(model)["a"]
        b_val <- coef(model)["b"]
        
        # Calculate R¬≤ manually
        RSS <- sum(residuals(model)^2)
        TSS <- sum((df_year$FC_night - mean(df_year$FC_night, na.rm = TRUE))^2, na.rm = TRUE)
        r2_val <- 1 - (RSS/TSS)
        
        # Calculate Q10
        q10_val <- exp(10 * b_val)
        
        # Store in results table
        results$r_squared[i] <- r2_val
        results$a_coef[i] <- a_val
        results$b_coef[i] <- b_val
        results$Q10[i] <- q10_val
        results$n_obs[i] <- nrow(df_year)
        
        # Create plot
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FC_night")) +
          geom_point(alpha = 0.7) +
          theme_bw() +
          ggtitle(paste("Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "FC_night Flux (nmol/m¬≤/s)")
        
        # Add model prediction line
        new_data <- data.frame(x = seq(min(df_year[[temp_sensor]], na.rm = TRUE),
                                     max(df_year[[temp_sensor]], na.rm = TRUE),
                                     length.out = 100))
        names(new_data)[1] <- temp_sensor
        
        new_data$FC_night <- predict(model, newdata = new_data)
        
        p <- p + geom_line(data = new_data, aes_string(x = temp_sensor, y = "FC_night"), 
                          color = "red", size = 1)
        
        # Add equation and R¬≤
        equation <- paste0("y = ", round(a_val, 3), "e^(", 
                         round(b_val, 3), "x), R¬≤ = ", round(r2_val, 3))
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FC_night, na.rm = TRUE) * 0.9,
                         label = equation, hjust = 0)
        
        plot_list[[i]] <- p
        
      }, error = function(e) {
        # Handle errors
        results$r_squared[i] <<- NA
        results$a_coef[i] <<- NA
        results$b_coef[i] <<- NA
        results$Q10[i] <<- NA
        
        # Create plot with linear model instead
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FC_night")) +
          geom_point(alpha = 0.7) +
          geom_smooth(method = "lm", color = "blue", se = FALSE) +
          theme_bw() +
          ggtitle(paste("Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "CH4 Flux (nmol/m¬≤/s)")
        
        # Add R¬≤ for linear model
        lm_model <- lm(as.formula(paste("FC_night ~", temp_sensor)), data = df_year)
        r2_linear <- summary(lm_model)$r.squared
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FC_night, na.rm = TRUE) * 0.9,
                         label = paste0("Linear R¬≤ = ", round(r2_linear, 3)), 
                         hjust = 0)
        
        plot_list[[i]] <- p
      })
    }
  }
  
  return(list(results = results, plots = plot_list))
}

# Run unified analysis
FCnight_analysis <- analyze_FCnight_yearly(yearly_dfs)

# Print results table
print(FCnight_analysis$results)

# Display plots (requires gridExtra)
 grid.arrange(grobs = FCnight_analysis$plots, ncol = 2)
```

#Unified yearly relationship analysis for FCH4 & soil temp - all seasons 

```{r}
# Unified analysis script for FCH4
analyze_methane_yearly <- function(data_list, temp_sensor = "TS_3_1_1") {
  # Create results table
  results <- data.frame(
    year = names(data_list),
    r_squared = numeric(length(data_list)),
    a_coef = numeric(length(data_list)),
    b_coef = numeric(length(data_list)),
    Q10 = numeric(length(data_list)),
    n_obs = numeric(length(data_list))
  )
  
  # Create list for plots
  plot_list <- list()
  
  # Process each year
  for (i in seq_along(data_list)) {
    year_name <- names(data_list)[i]
    df_year <- data_list[[i]]
    
    if (nrow(df_year) >= 10) {
      # Create formula
      formula_text <- paste0("FCH4 ~ a * exp(b * ", temp_sensor, ")")
      
      # Fit model
      tryCatch({
        model <- nls(as.formula(formula_text), data = df_year, 
                    start = list(a = 1, b = 0.1))
        
        # Extract coefficients
        a_val <- coef(model)["a"]
        b_val <- coef(model)["b"]
        
        # Calculate R¬≤ manually
        RSS <- sum(residuals(model)^2)
        TSS <- sum((df_year$FCH4 - mean(df_year$FCH4, na.rm = TRUE))^2, na.rm = TRUE)
        r2_val <- 1 - (RSS/TSS)
        
        # Calculate Q10
        q10_val <- exp(10 * b_val)
        
        # Store in results table
        results$r_squared[i] <- r2_val
        results$a_coef[i] <- a_val
        results$b_coef[i] <- b_val
        results$Q10[i] <- q10_val
        results$n_obs[i] <- nrow(df_year)
        
        # Create plot
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FCH4")) +
          geom_point(alpha = 0.7) +
          theme_bw() +
          ggtitle(paste("Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "CH4 Flux (nmol/m¬≤/s)")
        
        # Add model prediction line
        new_data <- data.frame(x = seq(min(df_year[[temp_sensor]], na.rm = TRUE),
                                     max(df_year[[temp_sensor]], na.rm = TRUE),
                                     length.out = 100))
        names(new_data)[1] <- temp_sensor
        
        new_data$FCH4 <- predict(model, newdata = new_data)
        
        p <- p + geom_line(data = new_data, aes_string(x = temp_sensor, y = "FCH4"), 
                          color = "red", size = 1)
        
        # Add equation and R¬≤
        equation <- paste0("y = ", round(a_val, 3), "e^(", 
                         round(b_val, 3), "x), R¬≤ = ", round(r2_val, 3))
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FCH4, na.rm = TRUE) * 0.9,
                         label = equation, hjust = 0)
        
        plot_list[[i]] <- p
        
      }, error = function(e) {
        # Handle errors
        results$r_squared[i] <<- NA
        results$a_coef[i] <<- NA
        results$b_coef[i] <<- NA
        results$Q10[i] <<- NA
        
        # Create plot with linear model instead
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FCH4")) +
          geom_point(alpha = 0.7) +
          geom_smooth(method = "lm", color = "blue", se = FALSE) +
          theme_bw() +
          ggtitle(paste("Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "CH4 Flux (nmol/m¬≤/s)")
        
        # Add R¬≤ for linear model
        lm_model <- lm(as.formula(paste("FCH4 ~", temp_sensor)), data = df_year)
        r2_linear <- summary(lm_model)$r.squared
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FCH4, na.rm = TRUE) * 0.9,
                         label = paste0("Linear R¬≤ = ", round(r2_linear, 3)), 
                         hjust = 0)
        
        plot_list[[i]] <- p
      })
    }
  }
  
  return(list(results = results, plots = plot_list))
}

# Run unified analysis
fch4_analysis <- analyze_methane_yearly(yearly_dfs)

# Print results table
print(fch4_analysis$results)

# Display plots (requires gridExtra)
 grid.arrange(grobs = fch4_analysis$plots, ncol = 2)
```



#Unified relationship script for yearly trends for FC_night & soil temp - no winter 
```{r}
# Unified analysis script for FCH4
analyze_FCnight_yearly_nw <- function(data_list, temp_sensor = "TS_3_1_1") {
  # Create results table
  results <- data.frame(
    year = names(data_list),
    r_squared = numeric(length(data_list)),
    a_coef = numeric(length(data_list)),
    b_coef = numeric(length(data_list)),
    Q10 = numeric(length(data_list)),
    n_obs = numeric(length(data_list))
  )
  
  # Create list for plots
  plot_list <- list()
  
  # Process each year
  for (i in seq_along(data_list)) {
    year_name <- names(data_list)[i]
    df_year <- data_list[[i]]
    
    if (nrow(df_year) >= 10) {
      # Create formula
      formula_text <- paste0("FC_night ~ a * exp(b * ", temp_sensor, ")")
      
      # Fit model
      tryCatch({
        model <- nls(as.formula(formula_text), data = df_year, 
                    start = list(a = 1, b = 0.1))
        
        # Extract coefficients
        a_val <- coef(model)["a"]
        b_val <- coef(model)["b"]
        
        # Calculate R¬≤ manually
        RSS <- sum(residuals(model)^2)
        TSS <- sum((df_year$FC_night - mean(df_year$FC_night, na.rm = TRUE))^2, na.rm = TRUE)
        r2_val <- 1 - (RSS/TSS)
        
        # Calculate Q10
        q10_val <- exp(10 * b_val)
        
        # Store in results table
        results$r_squared[i] <- r2_val
        results$a_coef[i] <- a_val
        results$b_coef[i] <- b_val
        results$Q10[i] <- q10_val
        results$n_obs[i] <- nrow(df_year)
        
        # Create plot
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FC_night")) +
          geom_point(alpha = 0.7) +
          theme_bw() +
          ggtitle(paste("No Winter, Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "FC_night Flux (nmol/m¬≤/s)")
        
        # Add model prediction line
        new_data <- data.frame(x = seq(min(df_year[[temp_sensor]], na.rm = TRUE),
                                     max(df_year[[temp_sensor]], na.rm = TRUE),
                                     length.out = 100))
        names(new_data)[1] <- temp_sensor
        
        new_data$FC_night <- predict(model, newdata = new_data)
        
        p <- p + geom_line(data = new_data, aes_string(x = temp_sensor, y = "FC_night"), 
                          color = "red", size = 1)
        
        # Add equation and R¬≤
        equation <- paste0("y = ", round(a_val, 3), "e^(", 
                         round(b_val, 3), "x), R¬≤ = ", round(r2_val, 3))
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FC_night, na.rm = TRUE) * 0.9,
                         label = equation, hjust = 0)
        
        plot_list[[i]] <- p
        
      }, error = function(e) {
        # Handle errors
        results$r_squared[i] <<- NA
        results$a_coef[i] <<- NA
        results$b_coef[i] <<- NA
        results$Q10[i] <<- NA
        
        # Create plot with linear model instead
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FC_night")) +
          geom_point(alpha = 0.7) +
          geom_smooth(method = "lm", color = "blue", se = FALSE) +
          theme_bw() +
          ggtitle(paste("No Winter, Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "CH4 Flux (nmol/m¬≤/s)")
        
        # Add R¬≤ for linear model
        lm_model <- lm(as.formula(paste("FC_night ~", temp_sensor)), data = df_year)
        r2_linear <- summary(lm_model)$r.squared
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FC_night, na.rm = TRUE) * 0.9,
                         label = paste0("Linear R¬≤ = ", round(r2_linear, 3)), 
                         hjust = 0)
        
        plot_list[[i]] <- p
      })
    }
  }
  
  return(list(results = results, plots = plot_list))
}

# Run unified analysis
FCnight_analysis_nw <- analyze_FCnight_yearly_nw(yearly_dfs_nw)

# Print results table
print(FCnight_analysis_nw$results)

# Display plots (requires gridExtra)
 grid.arrange(grobs = FCnight_analysis_nw$plots, ncol = 2)
```

#Unified yearly relationship analysis for FCH4 & soil temp - no winter 

```{r}
# Unified analysis script for FCH4
analyze_methane_yearly_nw <- function(data_list, temp_sensor = "TS_3_1_1") {
  # Create results table
  results <- data.frame(
    year = names(data_list),
    r_squared = numeric(length(data_list)),
    a_coef = numeric(length(data_list)),
    b_coef = numeric(length(data_list)),
    Q10 = numeric(length(data_list)),
    n_obs = numeric(length(data_list))
  )
  
  # Create list for plots
  plot_list <- list()
  
  # Process each year
  for (i in seq_along(data_list)) {
    year_name <- names(data_list)[i]
    df_year <- data_list[[i]]
    
    if (nrow(df_year) >= 10) {
      # Create formula
      formula_text <- paste0("FCH4 ~ a * exp(b * ", temp_sensor, ")")
      
      # Fit model
      tryCatch({
        model <- nls(as.formula(formula_text), data = df_year, 
                    start = list(a = 1, b = 0.1))
        
        # Extract coefficients
        a_val <- coef(model)["a"]
        b_val <- coef(model)["b"]
        
        # Calculate R¬≤ manually
        RSS <- sum(residuals(model)^2)
        TSS <- sum((df_year$FCH4 - mean(df_year$FCH4, na.rm = TRUE))^2, na.rm = TRUE)
        r2_val <- 1 - (RSS/TSS)
        
        # Calculate Q10
        q10_val <- exp(10 * b_val)
        
        # Store in results table
        results$r_squared[i] <- r2_val
        results$a_coef[i] <- a_val
        results$b_coef[i] <- b_val
        results$Q10[i] <- q10_val
        results$n_obs[i] <- nrow(df_year)
        
        # Create plot
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FCH4")) +
          geom_point(alpha = 0.7) +
          theme_bw() +
          ggtitle(paste("No Winter, Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "CH4 Flux (nmol/m¬≤/s)")
        
        # Add model prediction line
        new_data <- data.frame(x = seq(min(df_year[[temp_sensor]], na.rm = TRUE),
                                     max(df_year[[temp_sensor]], na.rm = TRUE),
                                     length.out = 100))
        names(new_data)[1] <- temp_sensor
        
        new_data$FCH4 <- predict(model, newdata = new_data)
        
        p <- p + geom_line(data = new_data, aes_string(x = temp_sensor, y = "FCH4"), 
                          color = "red", size = 1)
        
        # Add equation and R¬≤
        equation <- paste0("y = ", round(a_val, 3), "e^(", 
                         round(b_val, 3), "x), R¬≤ = ", round(r2_val, 3))
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FCH4, na.rm = TRUE) * 0.9,
                         label = equation, hjust = 0)
        
        plot_list[[i]] <- p
        
      }, error = function(e) {
        # Handle errors
        results$r_squared[i] <<- NA
        results$a_coef[i] <<- NA
        results$b_coef[i] <<- NA
        results$Q10[i] <<- NA
        
        # Create plot with linear model instead
        p <- ggplot(df_year, aes_string(x = temp_sensor, y = "FCH4")) +
          geom_point(alpha = 0.7) +
          geom_smooth(method = "lm", color = "blue", se = FALSE) +
          theme_bw() +
          ggtitle(paste("No Winter, Year:", year_name)) +
          labs(x = "Soil Temperature (¬∞C)", 
               y = "CH4 Flux (nmol/m¬≤/s)")
        
        # Add R¬≤ for linear model
        lm_model <- lm(as.formula(paste("FCH4 ~", temp_sensor)), data = df_year)
        r2_linear <- summary(lm_model)$r.squared
        
        p <- p + annotate("text", x = min(df_year[[temp_sensor]], na.rm = TRUE) + 1, 
                         y = max(df_year$FCH4, na.rm = TRUE) * 0.9,
                         label = paste0("Linear R¬≤ = ", round(r2_linear, 3)), 
                         hjust = 0)
        
        plot_list[[i]] <- p
      })
    }
  }
  
  return(list(results = results, plots = plot_list))
}

# Run unified analysis
fch4_analysis_nw <- analyze_methane_yearly_nw(yearly_dfs_nw)

# Print results table
print(fch4_analysis_nw$results)

# Display plots (requires gridExtra)
 grid.arrange(grobs = fch4_analysis_nw$plots, ncol = 2)
```



#Potential threshold effects 

```{r}
# Example: Threshold analysis for temperature
df_avg_nowinter <- df_avg_nowinter %>%
  mutate(temp_threshold = ifelse(TS_3_1_1 > median(TS_3_1_1, na.rm = TRUE), 
                               "High", "Low"))

ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FC_night, color = temp_threshold)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  scale_color_manual(values = c("blue", "red")) +
  labs(title = "Temperature-Flux Relationship with Threshold Effect",
       x = "Soil Temperature (¬∞C)",
       y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)")



ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FCH4, color = temp_threshold)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  scale_color_manual(values = c("blue", "red")) +
  labs(title = "Temperature-Flux Relationship with Threshold Effect",
       x = "Soil Temperature (¬∞C)",
       y = "CH4 Flux (Œºmol/m¬≤/s)")


# Example: Threshold analysis for SWC
df_avg_nowinter <- df_avg_nowinter %>%
  mutate(SWC_threshold = ifelse(SWC_3_1_1 > median(SWC_3_1_1, na.rm = TRUE), 
                               "High", "Low"))

ggplot(df_avg_nowinter, aes(x = SWC_3_1_1, y = FC_night, color = SWC_threshold)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  scale_color_manual(values = c("blue", "red")) +
  labs(title = "SWC-Flux Relationship with Threshold Effect",
       x = "SWC ",
       y = "FC_night Flux (Œºmol/m¬≤/s)")

ggplot(df_avg_nowinter, aes(x = SWC_3_1_1, y = FCH4, color = SWC_threshold)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  scale_color_manual(values = c("blue", "red")) +
  labs(title = "SWC-Flux Relationship with Threshold Effect",
       x = "SWC ",
       y = "CH4 Flux (Œºmol/m¬≤/s)")





```


#Relationship by year - temp 
```{r}
# Function to fit yearly models and calculate R¬≤
fit_yearly_models <- function(flux_var, temp_var, yearly_dfs) {
  # Store results
  results <- data.frame(year = names(yearly_dfs),
                       r_squared = numeric(length(yearly_dfs)),
                       a_coef = numeric(length(yearly_dfs)),
                       b_coef = numeric(length(yearly_dfs)))
  
  # Loop through each year's dataframe
  for (i in seq_along(yearly_dfs)) {
    df_year <- yearly_dfs[[i]]
    year_name <- names(yearly_dfs)[i]
    
    # Create formula
    formula <- as.formula(paste(flux_var, "~ a * exp(b *", temp_var, ")"))
    
    # Fit model
    tryCatch({
      model <- nls(formula, data = df_year, start = list(a = 1, b = 0.1))
      
      # Calculate R-squared
      RSS <- sum(residuals(model)^2)
      TSS <- sum((df_year[[flux_var]] - mean(df_year[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
      r2 <- 1 - (RSS/TSS)
      
      # Store results
      results$r_squared[i] <- r2
      results$a_coef[i] <- coef(model)["a"]
      results$b_coef[i] <- coef(model)["b"]
    }, error = function(e) {
      # Handle errors
      results$r_squared[i] <<- NA
      results$a_coef[i] <<- NA
      results$b_coef[i] <<- NA
    })
  }
  
  return(results)
}

# Create a list of yearly dataframes (no winter)
yearly_dfs <- list(
  "2017" = df_avg_nowinter_2017,
  "2018" = df_avg_nowinter_2018,
  "2019" = df_avg_nowinter_2019,
  "2020" = df_avg_nowinter_2020,
  "2021" = df_avg_nowinter_2021,
  "2022" = df_avg_nowinter_2022,
  "2023" = df_avg_nowinter_2023
)

# Analyze yearly patterns for FC_night
yearly_FC_night_results <- fit_yearly_models("FC_night", "TS_3_1_1", yearly_dfs)
print(yearly_FC_night_results)

# Analyze yearly patterns for FCH4
yearly_FCH4_results <- fit_yearly_models("FCH4", "TS_3_1_1", yearly_dfs)
print(yearly_FCH4_results)
```








#Temp and SWC
```{r}
# Function to test models with SWC interaction
test_swc_interaction <- function(flux_var, temp_var, swc_var, df) {
  # Simple linear model with temperature only
  formula_temp <- as.formula(paste(flux_var, "~", temp_var))
  model_temp <- lm(formula_temp, data = df)
  r2_temp <- summary(model_temp)$r.squared
  
  # Linear model with temperature and SWC
  formula_temp_swc <- as.formula(paste(flux_var, "~", temp_var, "+", swc_var))
  model_temp_swc <- lm(formula_temp_swc, data = df)
  r2_temp_swc <- summary(model_temp_swc)$r.squared
  
  # Linear model with temperature, SWC, and their interaction
  formula_interaction <- as.formula(paste(flux_var, "~", temp_var, "*", swc_var))
  model_interaction <- lm(formula_interaction, data = df)
  r2_interaction <- summary(model_interaction)$r.squared
  
  # Return results
  results <- data.frame(
    model = c("Temperature only", "Temperature + SWC", "Temperature * SWC"),
    r_squared = c(r2_temp, r2_temp_swc, r2_interaction)
  )
  
  return(results)
}

# Test SWC interaction for FC_night using different SWC sensors
swc_cols <- c("SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1")

for (swc_col in swc_cols) {
  results <- test_swc_interaction("FC_night", "TS_3_1_1", swc_col, df_avg_nowinter)
  cat("FC_night with", swc_col, "interaction:\n")
  print(results)
  cat("\n")
}

# Test SWC interaction for FCH4
for (swc_col in swc_cols) {
  results <- test_swc_interaction("FCH4", "TS_3_1_1", swc_col, df_avg_nowinter)
  cat("FCH4 with", swc_col, "interaction:\n")
  print(results)
  cat("\n")
}
```

#Visualizations 
```{r}
# Function to create temperature-flux scatter plots with model fits
plot_temp_flux_relationship <- function(flux_var, temp_var, df, yearly_dfs = NULL) {
  p <- ggplot(df, aes_string(x = temp_var, y = flux_var)) +
    geom_point(alpha = 0.5) +
    theme_bw() +
    labs(
      x = "Soil Temperature (¬∞C)",
      y = if(flux_var == "FC_night") "Nighttime CO2 Flux (Œºmol/m¬≤/s)" else "CH4 Flux (nmol/m¬≤/s)"
    )
  
  # Add exponential model fit
  tryCatch({
    exp_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", temp_var, ")")), 
                    data = df, start = list(a = 1, b = 0.1))
    
    # Generate prediction data
    pred_data <- data.frame(x = seq(min(df[[temp_var]], na.rm = TRUE), 
                                   max(df[[temp_var]], na.rm = TRUE), 
                                   length.out = 100))
    names(pred_data)[1] <- temp_var
    
    # Calculate predictions
    pred_data[[flux_var]] <- predict(exp_model, newdata = pred_data)
    
    # Add to plot
    p <- p + geom_line(data = pred_data, aes_string(x = temp_var, y = flux_var), 
                       color = "red", size = 1)
    
    # Add R¬≤ annotation
    RSS <- sum(residuals(exp_model)^2)
    TSS <- sum((df[[flux_var]] - mean(df[[flux_var]], na.rm = TRUE))^2, na.rm = TRUE)
    r2 <- 1 - (RSS/TSS)
    
    p <- p + annotate("text", x = max(df[[temp_var]], na.rm = TRUE) * 0.8, 
                     y = max(df[[flux_var]], na.rm = TRUE) * 0.9,
                     label = paste0("Exp. model R¬≤ = ", round(r2, 3)))
  }, error = function(e) {
    # If model fails, just show the scatter plot
  })
  
  # Add linear model fit
  linear_model <- lm(as.formula(paste(flux_var, "~", temp_var)), data = df)
  r2_linear <- summary(linear_model)$r.squared
  
  p <- p + geom_smooth(method = "lm", color = "blue", se = FALSE, linetype = "dashed") +
    annotate("text", x = max(df[[temp_var]], na.rm = TRUE) * 0.8, 
             y = max(df[[flux_var]], na.rm = TRUE) * 0.8,
             label = paste0("Linear R¬≤ = ", round(r2_linear, 3)))
  
  # If yearly data is provided, add yearly models
  if (!is.null(yearly_dfs)) {
    colors <- rainbow(length(yearly_dfs))
    
    for (i in seq_along(yearly_dfs)) {
      df_year <- yearly_dfs[[i]]
      year_name <- names(yearly_dfs)[i]
      
      # Add points for this year
      p <- p + geom_point(data = df_year, aes_string(x = temp_var, y = flux_var), 
                         color = colors[i], alpha = 0.7)
      
      # Try to add exponential model for this year
      tryCatch({
        year_model <- nls(as.formula(paste(flux_var, "~ a * exp(b *", temp_var, ")")), 
                         data = df_year, start = list(a = 1, b = 0.1))
        
        # Generate prediction data for this year
        year_pred <- data.frame(x = seq(min(df_year[[temp_var]], na.rm = TRUE), 
                                      max(df_year[[temp_var]], na.rm = TRUE), 
                                      length.out = 50))
        names(year_pred)[1] <- temp_var
        
        # Calculate predictions
        year_pred[[flux_var]] <- predict(year_model, newdata = year_pred)
        
        # Add to plot
        p <- p + geom_line(data = year_pred, aes_string(x = temp_var, y = flux_var), 
                          color = colors[i], size = 0.7)
      }, error = function(e) {
        # If model fails for this year, skip it
      })
    }
    
    # Add legend for years
    p <- p + annotate("text", x = rep(min(df[[temp_var]], na.rm = TRUE) * 1.1, length(yearly_dfs)), 
                     y = seq(from = max(df[[flux_var]], na.rm = TRUE) * 0.7, 
                             to = max(df[[flux_var]], na.rm = TRUE) * 0.4, 
                             length.out = length(yearly_dfs)),
                     label = names(yearly_dfs), 
                     color = colors)
  }
  
  return(p)
}

# Create overall plots
fc_night_plot <- plot_temp_flux_relationship("FC_night", "TS_3_1_1", df_avg_nowinter)
print(fc_night_plot)

fch4_plot <- plot_temp_flux_relationship("FCH4", "TS_3_1_1", df_avg_nowinter)
print(fch4_plot)

# Create plots with yearly data
fc_night_yearly_plot <- plot_temp_flux_relationship("FC_night", "TS_3_1_1", df_avg_nowinter, yearly_dfs)
print(fc_night_yearly_plot)

fch4_yearly_plot <- plot_temp_flux_relationship("FCH4", "TS_3_1_1", df_avg_nowinter, yearly_dfs)
print(fch4_yearly_plot)
```

# By temp & WD 
```{r}
# FC_night scatter plot with coloring by season - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FC_night, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~WD_cardinal)+
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by WD - NW")


# FCH4 scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FCH4, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~WD_cardinal)+
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by WD- NW")


# FC_night scatter plot with coloring by WD - all seasons 
ggplot(df_avg, aes(x = TS_3_1_1, y = FC_night, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~WD_cardinal)+
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by WD")


# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg, aes(x = TS_3_1_1, y = FCH4, color = season)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~WD_cardinal)+
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by WD")


# FC_night scatter plot with coloring by season - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FC_night, color = WD_cardinal)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by WD - NW")


# FCH4 scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter, aes(x = TS_3_1_1, y = FCH4, color = WD_cardinal)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by WD- NW")


# FC_night scatter plot with coloring by WD - all seasons 
ggplot(df_avg, aes(x = TS_3_1_1, y = FC_night, color = WD_cardinal)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and FC_night Flux by WD")


# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg, aes(x = TS_3_1_1, y = FCH4, color = WD_cardinal)) +
  geom_point(alpha = 0.7) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_bw() +
  labs(x = "Soil Temperature (¬∞C)", y = "CH4 Flux (Œºmol/m¬≤/s)", 
       title = "Relationship between Soil Temperature and CH4 Flux by WD")

```


# By WD 

```{r}
# WD only 
# df_avg_nowinter <- df_avg %>%
#   filter(season!= "Winter")

# FC_night scatter plot with coloring by WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, FC_night)), aes(x = WD_cardinal, y = FC_night)) +
  geom_boxplot()+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  geom_hline(yintercept=0)+
  labs(x = "Wind Direction", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = "FC_night Flux by WD")


# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000)) +
  geom_boxplot()+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction "))
  #labs(x = "Wind Direction", y = "CH4 Flux (Œºmol/m¬≤/s)", 



# FC_night scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter %>% filter(complete.cases(WD_cardinal, FC_night)), aes(x = WD_cardinal, y = FC_night)) +
  geom_boxplot()+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  labs(x = "Wind Direction", y = "Nighttime CO2 Flux (Œºmol/m¬≤/s)", 
       title = " FC_night Flux by WD - NW")


# FCH4 scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter %>% filter(complete.cases(WD_cardinal, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000)) +
  geom_boxplot()+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction, No Winter "))


#facetwrap FCH4 by wind by season 

# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, season, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000, fill = season)) +
  geom_boxplot()+
     stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  facet_wrap(~season)+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction "))
  #labs(x = "Wind Direction", y = "CH4 Flux (Œºmol/m¬≤/s)", 


# FCH4 scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter %>% filter(complete.cases(WD_cardinal, season, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000, fill = season)) +
  geom_boxplot()+
   stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  facet_wrap(~season)+
  theme_bw() +
   scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  #scale_fill_manual(values = c("salmon", "forestgreen"))+
    scale_fill_manual(values = c("salmon", "#0DA907"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction, No Winter "))


ggplot(df_avg %>% filter(season == "Winter"), aes(x = WD_cardinal, y = FCH4)) +
  geom_boxplot()+
  theme_bw()


# FCH4 scatter plot with coloring by WD
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, season, FCH4)), aes(x = DOY, y = FCH4 * 1/1000, color = WD_cardinal)) +
geom_point()+
  geom_hline(yintercept = 0)+
  facet_wrap(~year)+
  theme_bw() +
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("DOY"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction "))


# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, season, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000, fill = season)) +
  geom_boxplot()+
     stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  #facet_grid(year ~ season)+
  facet_wrap(~year + season, ncol = 6)+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction "))
  #labs(x = "Wind Direction", y = "CH4 Flux (Œºmol/m¬≤/s)", 


```


#facetwrap FCH4 by wind by season 
```{r}
# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, season, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000, fill = season)) +
  geom_boxplot()+
     stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  facet_wrap(~season)+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction "))
  #labs(x = "Wind Direction", y = "CH4 Flux (Œºmol/m¬≤/s)", 


# FCH4 scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter %>% filter(complete.cases(WD_cardinal, season, FCH4)), aes(x = WD_cardinal, y = FCH4 * 1/1000, fill = season)) +
  geom_boxplot()+
   stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  facet_wrap(~season)+
  theme_bw() +
   scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  #scale_fill_manual(values = c("salmon", "forestgreen"))+
    scale_fill_manual(values = c("salmon", "#0DA907"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CH"[4] ~ "by Wind Direction, No Winter "))


ggplot(df_avg %>% filter(season == "Winter"), aes(x = WD_cardinal, y = FCH4)) +
  geom_boxplot()+
  theme_bw()

```










#CO2 flux by WD

```{r}
# WD only 

# FC WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, FC)), aes(x = WD_cardinal, y = FC)) +
  geom_boxplot()+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CO"[2] ~ "by Wind Direction "))


# FC plot with coloring by WD - no winter 
ggplot(df_avg_nowinter %>% filter(complete.cases(WD_cardinal, FC)), aes(x = WD_cardinal, y = FC)) +
  geom_boxplot()+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CO"[2] ~ "by Wind Direction, No Winter "))


#facetwrap FCH4 by wind by season 

# FCH4 scatter plot with coloring by WD - all seasons 
ggplot(df_avg %>% filter(complete.cases(WD_cardinal, season, FC)), aes(x = WD_cardinal, y = FC, fill = season)) +
  geom_boxplot()+
     stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  facet_wrap(~season)+
  theme_bw() +
    scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CO"[2] ~ "by Wind Direction "))



# FC scatter plot with coloring by WD - no winter 
ggplot(df_avg_nowinter %>% filter(complete.cases(WD_cardinal, season, FC)), aes(x = WD_cardinal, y = FC, fill = season)) +
  geom_boxplot()+
   stat_summary(fun=mean, geom="point", shape=23, size=4)+
  geom_hline(yintercept = 0)+
  facet_wrap(~season)+
  theme_bw() +
   scale_x_discrete(
    limits = c("N", "NE", "E", "SE", "S", "SW", "W", "NW"))+
  #scale_fill_manual(values = c("salmon", "forestgreen"))+
    scale_fill_manual(values = c("salmon", "#0DA907"))+
  theme(
        # bold the axis titles
    axis.title   = element_text(face = "bold"),
    # bold the axis tick labels
    axis.text    = element_text(face = "bold"),
    plot.title = element_text(face="bold")) +
    labs(
    x = expression("Wind Direction"),
    y = expression("Daily Average Half-hourly CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Daily Average CO"[2] ~ "by Wind Direction, No Winter "))



```

